{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "70a6f6bb_4b0d219b",
        "filename": "firmware/2lib/2modpow_sse2.c",
        "patchSetId": 31
      },
      "lineNbr": 113,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2024-01-04T22:50:08Z",
      "side": 1,
      "message": "I\u0027ve been playing around with doing an Arm port of this code for a bit, and I noticed in the version I tested there that I would get a very noticeable speed difference (about 30%!) if I declare this as `const struct vb2_public_key *restrict key` instead. I believe the problem is that the compiler thinks it needs to reload `key-\u003earrsize` at every iteration of the inner loop because it cannot tell that the pointer for `key` doesn\u0027t point to the same memory as `de`, and thus updating `de` might have changed `key-\u003earrsize`.\n\nI don\u0027t have an Intel device to test this for your version at hand right now, but you might want to try it out and see if it makes a difference for you as well. (Alternatively you should get the same benefits by just putting `key-\u003earrsize` into a local variable at the top of the function and using that everywhere else.)",
      "range": {
        "startLine": 113,
        "startChar": 22,
        "endLine": 113,
        "endChar": 55
      },
      "revId": "7c3b60bb667f917525b5472f6a34df6402d7fa58",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a1c34950_191c4156",
        "filename": "firmware/2lib/2modpow_sse2.c",
        "patchSetId": 31
      },
      "lineNbr": 113,
      "author": {
        "id": 1542640
      },
      "writtenOn": "2024-01-05T18:23:33Z",
      "side": 1,
      "message": "That\u0027s interesting because using a local variable is something we tried and it did not bring any benefit. I\u0027ll try the `restrict` keyword once I am out of the critical task I am working on.",
      "parentUuid": "70a6f6bb_4b0d219b",
      "range": {
        "startLine": 113,
        "startChar": 22,
        "endLine": 113,
        "endChar": 55
      },
      "revId": "7c3b60bb667f917525b5472f6a34df6402d7fa58",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "035c0410_5cb1307d",
        "filename": "firmware/2lib/2modpow_sse2.c",
        "patchSetId": 31
      },
      "lineNbr": 113,
      "author": {
        "id": 1542640
      },
      "writtenOn": "2024-01-05T21:00:37Z",
      "side": 1,
      "message": "I tested the following change on my Meteor Lake rex board. I did not observe any significant/measurable change.\n\n    modified   firmware/2lib/2modpow_sse2.c\n    @@ -71,7 +71,8 @@ vb2_and_si128 (vb2_m128i a, vb2_m128i b)\n      * 64 bits (effectively lower 32 bits)\n      * de[] is used as a temporary buffer and therefore its content will be lost.\n      */\n    -static void sub_mod(const struct vb2_public_key *key, vb2_m128i *de, uint32_t *c)\n    +static void sub_mod(const struct vb2_public_key * restrict key,\n    +\t\t    vb2_m128i *de, uint32_t *c)\n     {\n    \tuint32_t i, borrow \u003d 0, carry \u003d 0, d, e;\n    \tuint64_t sum, *de_i;",
      "parentUuid": "a1c34950_191c4156",
      "range": {
        "startLine": 113,
        "startChar": 22,
        "endLine": 113,
        "endChar": 55
      },
      "revId": "7c3b60bb667f917525b5472f6a34df6402d7fa58",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "7b7422e3_80b0b306",
        "filename": "firmware/2lib/2modpow_sse2.c",
        "patchSetId": 31
      },
      "lineNbr": 113,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2024-01-05T22:25:38Z",
      "side": 1,
      "message": "Okay, yeah, if moving it to a local variable didn\u0027t help you then `restrict` wouldn\u0027t either. It\u0027s kind of a complicated edge case anyway, since the compiler should not assume the two pointers point to the same thing unless they\u0027re of the same type. On Arm the vector types express more explicitly what they contain (e.g. `uint32x4_t`), so maybe in that case the compiler considers those the same as a normal `uint32_t` for strict-aliasing purposes, whereas with your `__m128i` it doesn\u0027t.",
      "parentUuid": "035c0410_5cb1307d",
      "range": {
        "startLine": 113,
        "startChar": 22,
        "endLine": 113,
        "endChar": 55
      },
      "revId": "7c3b60bb667f917525b5472f6a34df6402d7fa58",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    }
  ]
}