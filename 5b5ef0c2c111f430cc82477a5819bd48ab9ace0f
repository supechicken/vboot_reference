{
  "comments": [
    {
      "key": {
        "uuid": "a4e7b44f_420c72de",
        "filename": "futility/updater.c",
        "patchSetId": 6
      },
      "lineNbr": 1197,
      "author": {
        "id": 1000239
      },
      "writtenOn": "2020-01-07T03:39:31Z",
      "side": 1,
      "message": "It\u0027d make more sense to do the quirk in updater_apply_white_label.",
      "range": {
        "startLine": 1197,
        "startChar": 5,
        "endLine": 1197,
        "endChar": 46
      },
      "revId": "5b5ef0c2c111f430cc82477a5819bd48ab9ace0f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "2aa573fc_9e17bb8f",
        "filename": "futility/updater.c",
        "patchSetId": 6
      },
      "lineNbr": 1357,
      "author": {
        "id": 1000239
      },
      "writtenOn": "2020-01-07T03:39:31Z",
      "side": 1,
      "message": "Please add invocation of quirk here.\n\nUnfortunately the model/signature_id are both not included in cfg, so we have to declare a specific quirk function for it. I\u0027d recommend\n\n try_quirk_override_signature_id(cfg, model, \u0026signature_id, tmp_image);",
      "range": {
        "startLine": 1357,
        "startChar": 2,
        "endLine": 1357,
        "endChar": 3
      },
      "revId": "5b5ef0c2c111f430cc82477a5819bd48ab9ace0f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "b82b0f53_dc757e95",
        "filename": "futility/updater_quirks.c",
        "patchSetId": 6
      },
      "lineNbr": 60,
      "author": {
        "id": 1000239
      },
      "writtenOn": "2020-01-07T03:39:31Z",
      "side": 1,
      "message": "let\u0027s rename this to override_signature_id",
      "range": {
        "startLine": 60,
        "startChar": 41,
        "endLine": 60,
        "endChar": 60
      },
      "revId": "5b5ef0c2c111f430cc82477a5819bd48ab9ace0f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "6d442926_2f9a4c2c",
        "filename": "futility/updater_quirks.c",
        "patchSetId": 6
      },
      "lineNbr": 383,
      "author": {
        "id": 1000239
      },
      "writtenOn": "2020-01-07T03:39:31Z",
      "side": 1,
      "message": "I think we don\u0027t want to duplicate all the logic here. The quirk should do\n - check signature ID\n - check system rootkey\n - change signature id if matches\n\nSo let\u0027s re-implement this as\n\n int try_quirk_override_signature_id(cfg, model, *signature_id)\n {\n    if (!get_config_quirk(QUIRK_OVERRIDE_SIGNATURE_ID))\n      return 0;\n\n    /* b/146876241 */\n    if (strcmp(model, \"phaser360\") \u003d\u003d 0) {\n       assert(cfg-\u003eimage_current.data);\n       const char *rootkey_hash \u003d get_firmware_rootkey_hash(\u0026cfg-\u003eimage_current);\n       if (rootkey_hash \u0026\u0026 strcmp(...) \u003d\u003d 0) {\n         static const char * const sig_dopefish \u003d \"dopefish\";\n          WARN(\"A Phaser360 with Dupefish rootkey - override signature_id.\\n\");\n          *signature_id \u003d sig_dopefish;\n       }\n    }\n\n    return 0;\n }",
      "range": {
        "startLine": 383,
        "startChar": 8,
        "endLine": 383,
        "endChar": 16
      },
      "revId": "5b5ef0c2c111f430cc82477a5819bd48ab9ace0f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "22d6360b_2f5f969b",
        "filename": "futility/updater_quirks.c",
        "patchSetId": 6
      },
      "lineNbr": 383,
      "author": {
        "id": 1000239
      },
      "writtenOn": "2020-01-07T03:51:16Z",
      "side": 1,
      "message": "oh, we should also check\n\n if (!is_write_protection_enabled(cfg))\n    return 0;\n\nafter get_config_quirk.\n\nIn this implementation, whenever dopefish rootkey is found (and WP enabled), we will apply dopefish sigid, no need checking if VPD is empty.\n\nFeel free to let me know if there\u0027s some something missed.",
      "parentUuid": "6d442926_2f9a4c2c",
      "range": {
        "startLine": 383,
        "startChar": 8,
        "endLine": 383,
        "endChar": 16
      },
      "revId": "5b5ef0c2c111f430cc82477a5819bd48ab9ace0f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "2bd480eb_605df965",
        "filename": "futility/updater_quirks.c",
        "patchSetId": 6
      },
      "lineNbr": 383,
      "author": {
        "id": 1247406
      },
      "writtenOn": "2020-01-07T05:31:34Z",
      "side": 1,
      "message": "Sorry, I am not able to fully understand the idea behind the comments. As you can see, Patchset 5 is direct function call version and it does minimal work to update signature id. Do you mean just move that function to updater_quirks.c? Patchset 7 is a complete quirk infrastructure version, apply(cfg) function only accept one cfg parameters, so quirk function can\u0027t get enough information to do judgement, so duplicated work has to be done. Do you mean to extend apply(cfg) function to accept more parameters?\nDo you tend to write a quirk and only as a flag, still need direct function call to change the signature id, is this right?\n\nsince we are first time to change futility code, so please give us more guidance, thank you.",
      "parentUuid": "22d6360b_2f5f969b",
      "range": {
        "startLine": 383,
        "startChar": 8,
        "endLine": 383,
        "endChar": 16
      },
      "revId": "5b5ef0c2c111f430cc82477a5819bd48ab9ace0f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "305e0dc2_6bdd4d3e",
        "filename": "futility/updater_quirks.c",
        "patchSetId": 6
      },
      "lineNbr": 383,
      "author": {
        "id": 1247406
      },
      "writtenOn": "2020-01-07T05:46:45Z",
      "side": 1,
      "message": "I can understand that if rootkey is DOPEFISH, then whitelabel_tag judgement can be removed. and even we are able to not get model name, DOPEFISH rootkey is enough for us to know it is a phaser360 device.",
      "parentUuid": "2bd480eb_605df965",
      "range": {
        "startLine": 383,
        "startChar": 8,
        "endLine": 383,
        "endChar": 16
      },
      "revId": "5b5ef0c2c111f430cc82477a5819bd48ab9ace0f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "c1fdb513_d837d4b1",
        "filename": "futility/updater_quirks.c",
        "patchSetId": 6
      },
      "lineNbr": 383,
      "author": {
        "id": 1000239
      },
      "writtenOn": "2020-01-07T06:33:20Z",
      "side": 1,
      "message": "\u003e Patchset 5 is direct function call version and it does minimal work to update signature id. Do you mean just move that function to updater_quirks.c? \n\nVery close. We want (1) minimize the work, (2) do not put board-specific information in files expect quirks.c.\n\n\u003e Patchset 7 is a complete quirk infrastructure version, apply(cfg) function only accept one cfg parameters, so quirk function can\u0027t get enough information to do judgement, so duplicated work has to be done.\n\nThat\u0027s too much. We don\u0027t want to duplicate the work since it\u0027ll be hard to maintain / debug in future.\n\n\u003e Do you mean to extend apply(cfg) function to accept more parameters?\n\nNo need to extend apply since that\u0027ll be changing all quirk functions.\nWe can just declare a new quirk function and call it directly.\nThe apply is for simple quirks.\n\n\u003e Do you tend to write a quirk and only as a flag, still need direct function call to change the signature id, is this right?\n\nYes. You should\n\n - Define a quirk QUIRK_OVERRIDE_SIGNATURE_ID\n - Define a public function try_quirk_override_signature_id in updater_quirks.c\n - In updater_archive.c call try_quirk_override_signature_id",
      "parentUuid": "305e0dc2_6bdd4d3e",
      "range": {
        "startLine": 383,
        "startChar": 8,
        "endLine": 383,
        "endChar": 16
      },
      "revId": "5b5ef0c2c111f430cc82477a5819bd48ab9ace0f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "3320ae21_009791c6",
        "filename": "futility/updater_quirks.c",
        "patchSetId": 6
      },
      "lineNbr": 384,
      "author": {
        "id": 1115020
      },
      "writtenOn": "2020-01-06T17:55:03Z",
      "side": 1,
      "message": "whitelabel_tag",
      "revId": "5b5ef0c2c111f430cc82477a5819bd48ab9ace0f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "da9a89ff_54ef16a4",
        "filename": "futility/updater_quirks.c",
        "patchSetId": 6
      },
      "lineNbr": 384,
      "author": {
        "id": 1247406
      },
      "writtenOn": "2020-01-07T02:39:31Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "3320ae21_009791c6",
      "revId": "5b5ef0c2c111f430cc82477a5819bd48ab9ace0f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "aa0dbff5_b879b2c2",
        "filename": "futility/updater_quirks.c",
        "patchSetId": 6
      },
      "lineNbr": 449,
      "author": {
        "id": 1176029
      },
      "writtenOn": "2020-01-06T11:19:14Z",
      "side": 1,
      "message": "different",
      "range": {
        "startLine": 449,
        "startChar": 40,
        "endLine": 449,
        "endChar": 50
      },
      "revId": "5b5ef0c2c111f430cc82477a5819bd48ab9ace0f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "30b20777_292aa207",
        "filename": "futility/updater_quirks.c",
        "patchSetId": 6
      },
      "lineNbr": 449,
      "author": {
        "id": 1247406
      },
      "writtenOn": "2020-01-07T02:39:31Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "aa0dbff5_b879b2c2",
      "range": {
        "startLine": 449,
        "startChar": 40,
        "endLine": 449,
        "endChar": 50
      },
      "revId": "5b5ef0c2c111f430cc82477a5819bd48ab9ace0f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "dae797da_ca0c586a",
        "filename": "futility/updater_quirks.c",
        "patchSetId": 6
      },
      "lineNbr": 472,
      "author": {
        "id": 1176029
      },
      "writtenOn": "2020-01-06T11:19:14Z",
      "side": 1,
      "message": "move after line 477 if we have logic below to handle the case of NOT FOUND?",
      "revId": "5b5ef0c2c111f430cc82477a5819bd48ab9ace0f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "f571ac02_60cff931",
        "filename": "futility/updater_quirks.c",
        "patchSetId": 6
      },
      "lineNbr": 472,
      "author": {
        "id": 1247406
      },
      "writtenOn": "2020-01-07T02:39:31Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "dae797da_ca0c586a",
      "revId": "5b5ef0c2c111f430cc82477a5819bd48ab9ace0f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "3bf9f6ea_8911af74",
        "filename": "futility/updater_quirks.c",
        "patchSetId": 6
      },
      "lineNbr": 477,
      "author": {
        "id": 1176029
      },
      "writtenOn": "2020-01-06T11:19:14Z",
      "side": 1,
      "message": "else\n    errcnt +\u003d patch_image_by_model(\u0026cfg-\u003eimage, \u0026model, archive);\n\nIf we don\u0027t find the patches then we don\u0027t need to patch?",
      "revId": "5b5ef0c2c111f430cc82477a5819bd48ab9ace0f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "b79b58e6_a3dbfccc",
        "filename": "futility/updater_quirks.c",
        "patchSetId": 6
      },
      "lineNbr": 477,
      "author": {
        "id": 1247406
      },
      "writtenOn": "2020-01-07T02:39:31Z",
      "side": 1,
      "message": "Have changes the code so that if not found patches, an error will be returned. firmware update will be aborted in this case.",
      "parentUuid": "3bf9f6ea_8911af74",
      "revId": "5b5ef0c2c111f430cc82477a5819bd48ab9ace0f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    }
  ]
}