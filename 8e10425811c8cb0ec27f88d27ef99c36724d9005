{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "b8e622a7_ab649308",
        "filename": "firmware/2lib/2ui_screens.c",
        "patchSetId": 17
      },
      "lineNbr": 1156,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2021-02-25T07:21:48Z",
      "side": 1,
      "message": "I\u0027m not sure I understand what this is accomplishing, and why only some of the vb2_ui_screen_back calls are changed.  Could you explain?",
      "range": {
        "startLine": 1155,
        "startChar": 0,
        "endLine": 1156,
        "endChar": 33
      },
      "revId": "8e10425811c8cb0ec27f88d27ef99c36724d9005",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "918f1f07_475705a9",
        "filename": "firmware/2lib/2ui_screens.c",
        "patchSetId": 17
      },
      "lineNbr": 1156,
      "author": {
        "id": 1240396
      },
      "writtenOn": "2021-02-25T08:04:00Z",
      "side": 1,
      "message": "For those functions which are called directly from ui loop, there is no different between returning SUCCESS and REQUEST_UI_CONTINUE.\n\nBut this function is like this: \nUI_Loop -\u003e diagnostics_memory_init_quick -\u003e diagnostics_memory_update_screen\n\nIf we return VB2_SUCCESS, then we cannot just use VB2_TRY in `diagnostics_memory_init_quick` because it will catch it, and then perform `log_page_reset_to_top`, which is now calling `log_page_update`, and cause error.\n\nThis issue actually has happened before this CL. log_page_init will perform on the screen which is changed by `vb2_ui_screen_back`.",
      "parentUuid": "b8e622a7_ab649308",
      "range": {
        "startLine": 1155,
        "startChar": 0,
        "endLine": 1156,
        "endChar": 33
      },
      "revId": "8e10425811c8cb0ec27f88d27ef99c36724d9005",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "0463d359_55e4abd7",
        "filename": "firmware/2lib/2ui_screens.c",
        "patchSetId": 17
      },
      "lineNbr": 1156,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2021-02-26T07:22:52Z",
      "side": 1,
      "message": "A few points here:\n\n(1) The bug you are describing is introduced by CL:2714502.  It should be fixed there, rather than patching it in another CL stacked on top.  I\u0027ve uploaded a CL which adds unit test coverage around this issue at CL:2721377.  Please stack CL:2714502 on top of this one -- it fails the unit test.\n\n(2) This applies not only to this particular call to vb2_ui_screen_back, but to vb2_ui_screen_change and vb2_ui_menu_select as well.  So the solution here should apply to all calls to these three functions.\n\n(3) Rather than requiring the caller of these three functions to always use the sequence here (VB2_TRY + return UI_CONTINUE), I\u0027d recommend just returning the VB2_REQUEST value from these three functions directly.  That way, the caller doesn\u0027t need the extra return statement after VB2_TRY.",
      "parentUuid": "918f1f07_475705a9",
      "range": {
        "startLine": 1155,
        "startChar": 0,
        "endLine": 1156,
        "endChar": 33
      },
      "revId": "8e10425811c8cb0ec27f88d27ef99c36724d9005",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "0b925046_74897710",
        "filename": "firmware/2lib/2ui_screens.c",
        "patchSetId": 17
      },
      "lineNbr": 1156,
      "author": {
        "id": 1240396
      },
      "writtenOn": "2021-03-02T07:45:57Z",
      "side": 1,
      "message": "Add fixes in CL:2714502, and add some comments there.",
      "parentUuid": "0463d359_55e4abd7",
      "range": {
        "startLine": 1155,
        "startChar": 0,
        "endLine": 1156,
        "endChar": 33
      },
      "revId": "8e10425811c8cb0ec27f88d27ef99c36724d9005",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "93460e13_362ec5be",
        "filename": "firmware/2lib/2ui_screens.c",
        "patchSetId": 17
      },
      "lineNbr": 1156,
      "author": {
        "id": 1353551
      },
      "writtenOn": "2021-03-02T08:49:39Z",
      "side": 1,
      "message": "I\u0027m not sure if (3) is a good idea. It looks like we\u0027re mixing VB2_UI_CONTINUE and VB2_SUCCESS together. If we want to call some other function followed by vb2_ui_screen_back(), then the following won\u0027t work:\n\n vb2_error_t func() {\n     VB2_TRY(vb2_ui_screen_back());\n     VB2_TRY(some_other_func());\n }\n\nGiven that most calls to vb2_ui_screen_back() (that are treated like errors) are in init() hooks, I wonder if we can return VB2_UI_REQUEST_BACK in these cases. Then, in ui_loop_impl(), when receiving VB2_UI_REQUEST_BACK, we call vb2_ui_screen_back().",
      "parentUuid": "0b925046_74897710",
      "range": {
        "startLine": 1155,
        "startChar": 0,
        "endLine": 1156,
        "endChar": 33
      },
      "revId": "8e10425811c8cb0ec27f88d27ef99c36724d9005",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "1046c4d0_a1c515e4",
        "filename": "firmware/2lib/2ui_screens.c",
        "patchSetId": 17
      },
      "lineNbr": 1156,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2021-03-03T07:52:30Z",
      "side": 1,
      "message": "Actually, I also considered returning VB2_UI_REQUEST_BACK, which seems like an elegant solution.  But it doesn\u0027t cover the cases of vb2_ui_screen_change and vb2_ui_menu_select, and I\u0027d like to keep these using one solution if possible.\n\nThe other option is to put a request to change screens in vb2_ui_context -- but that seems overly complex.\n\nRegarding your example -- you\u0027re right, some_other_func() doesn\u0027t get called, by design.  The documentation for VB2_TRY is:\n\n * Evaluate an expression and return *from the caller* on failure or if an\n * action (such as reboot) is requested.\n\nIn this case, the \"action\" is UI_CONTINUE (whose name is questionable at this point).\n\nThat said, since the semantics required of calling a screen-changing function is to *return immediately afterwards or handle the screen change failure*, wrapping VB2_TRY around any of these three functions seems misleading.  In other words, my recommendation would be:\n\n  // use this form:\n  return vb2_ui_screen_back();\n  // do not use:\n  VB2_TRY(vb2_ui_screen_back());\n\nBut for functions which in turn call screen-changing functions, it should be acceptable to wrap with VB2_TRY:\n\n  vb2_error_t func()\n    return vb2_ui_screen_back();\n  // this is okay:\n  VB2_TRY(func());\n\nWhat are your thoughts?",
      "parentUuid": "93460e13_362ec5be",
      "range": {
        "startLine": 1155,
        "startChar": 0,
        "endLine": 1156,
        "endChar": 33
      },
      "revId": "8e10425811c8cb0ec27f88d27ef99c36724d9005",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "cd9d1ccf_8ecfb6d6",
        "filename": "firmware/2lib/2ui_screens.c",
        "patchSetId": 17
      },
      "lineNbr": 1156,
      "author": {
        "id": 1353551
      },
      "writtenOn": "2021-03-03T08:13:32Z",
      "side": 1,
      "message": "\u003e But it doesn\u0027t cover the cases of vb2_ui_screen_change and vb2_ui_menu_select, and I\u0027d like to keep these using one solution if possible.\n\nThat\u0027s true. I didn\u0027t consider that.\n\nIf we want to go with the solution Joel suggested, we\u0027ll need to make sure vb2_ui_screen_back() never returns VB2_SUCCESS. (Otherwise the bug Chung-Sheng mentioned would still exist.) Since vb2_ui_screen_back() calls reinit(), we\u0027ll have to either\n\n(1) Convert return value of reinit() from VB2_SUCCESS to VB2_UI_CONTINUE, or\n(2) Make sure all reinit functions don\u0027t return VB2_SUCCESS either. Note that this almost means changing all VB2_SUCCESS back to VB2_UI_CONTINUE, so this shouldn\u0027t be a feasible option.",
      "parentUuid": "1046c4d0_a1c515e4",
      "range": {
        "startLine": 1155,
        "startChar": 0,
        "endLine": 1156,
        "endChar": 33
      },
      "revId": "8e10425811c8cb0ec27f88d27ef99c36724d9005",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    }
  ]
}