{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "24fb35bd_1b22916c",
        "filename": "firmware/2lib/2load_android_kernel.c",
        "patchSetId": 9
      },
      "lineNbr": 22,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2025-01-23T00:52:35Z",
      "side": 1,
      "message": "Why not `size_t`?",
      "range": {
        "startLine": 22,
        "startChar": 11,
        "endLine": 22,
        "endChar": 19
      },
      "revId": "606fd3bf91449183fa41f01afb8e306197a5d493",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "cbce6181_ad96246a",
        "filename": "firmware/2lib/2load_android_kernel.c",
        "patchSetId": 9
      },
      "lineNbr": 22,
      "author": {
        "id": 1562687
      },
      "writtenOn": "2025-01-29T14:06:49Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "24fb35bd_1b22916c",
      "range": {
        "startLine": 22,
        "startChar": 11,
        "endLine": 22,
        "endChar": 19
      },
      "revId": "606fd3bf91449183fa41f01afb8e306197a5d493",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ecea9666_7f6f799b",
        "filename": "firmware/2lib/2load_android_kernel.c",
        "patchSetId": 9
      },
      "lineNbr": 44,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2025-01-23T00:52:35Z",
      "side": 1,
      "message": "Use `GptGetEntrySizeBytes()`",
      "revId": "606fd3bf91449183fa41f01afb8e306197a5d493",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "a6d8f567_94271acf",
        "filename": "firmware/2lib/2load_android_kernel.c",
        "patchSetId": 9
      },
      "lineNbr": 44,
      "author": {
        "id": 1562687
      },
      "writtenOn": "2025-01-29T14:06:49Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "ecea9666_7f6f799b",
      "revId": "606fd3bf91449183fa41f01afb8e306197a5d493",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "316a08fb_93e55faf",
        "filename": "firmware/2lib/2load_android_kernel.c",
        "patchSetId": 9
      },
      "lineNbr": 54,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2025-01-23T00:52:35Z",
      "side": 1,
      "message": "wrong name",
      "range": {
        "startLine": 54,
        "startChar": 28,
        "endLine": 54,
        "endChar": 35
      },
      "revId": "606fd3bf91449183fa41f01afb8e306197a5d493",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "63f0c9d2_7f6caa34",
        "filename": "firmware/2lib/2load_android_kernel.c",
        "patchSetId": 9
      },
      "lineNbr": 54,
      "author": {
        "id": 1562687
      },
      "writtenOn": "2025-01-29T14:06:49Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "316a08fb_93e55faf",
      "range": {
        "startLine": 54,
        "startChar": 28,
        "endLine": 54,
        "endChar": 35
      },
      "revId": "606fd3bf91449183fa41f01afb8e306197a5d493",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "65f2391e_ebc6826c",
        "filename": "firmware/2lib/2load_android_kernel.c",
        "patchSetId": 9
      },
      "lineNbr": 62,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2025-01-23T00:52:35Z",
      "side": 1,
      "message": "You don\u0027t need the parenthesis around `part_bytes` (and in our coding style we usually don\u0027t do that for a cast).",
      "range": {
        "startLine": 62,
        "startChar": 14,
        "endLine": 62,
        "endChar": 26
      },
      "revId": "606fd3bf91449183fa41f01afb8e306197a5d493",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "59394dce_5bdea686",
        "filename": "firmware/2lib/2load_android_kernel.c",
        "patchSetId": 9
      },
      "lineNbr": 62,
      "author": {
        "id": 1562687
      },
      "writtenOn": "2025-01-29T14:06:49Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "65f2391e_ebc6826c",
      "range": {
        "startLine": 62,
        "startChar": 14,
        "endLine": 62,
        "endChar": 26
      },
      "revId": "606fd3bf91449183fa41f01afb8e306197a5d493",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "94877770_45dd8053",
        "filename": "firmware/2lib/2load_android_kernel.c",
        "patchSetId": 9
      },
      "lineNbr": 93,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2025-01-23T00:52:35Z",
      "side": 1,
      "message": "`VB2_TRY()` (or otherwise check return value)",
      "revId": "606fd3bf91449183fa41f01afb8e306197a5d493",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "c608a928_222d947c",
        "filename": "firmware/2lib/2load_android_kernel.c",
        "patchSetId": 9
      },
      "lineNbr": 93,
      "author": {
        "id": 1562687
      },
      "writtenOn": "2025-01-29T14:06:49Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "94877770_45dd8053",
      "revId": "606fd3bf91449183fa41f01afb8e306197a5d493",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "51feb98e_f44d1c3a",
        "filename": "firmware/2lib/2load_android_kernel.c",
        "patchSetId": 9
      },
      "lineNbr": 96,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2025-01-23T00:52:35Z",
      "side": 1,
      "message": "I still don\u0027t think this kind of stuff belongs in this code. This code is just responsible for loading, not interpretation. Leave the interpretation to AVB and later depthcharge code. (In general, it\u0027s a good security practice to not touch the untrusted data at all before signature verification.)",
      "revId": "606fd3bf91449183fa41f01afb8e306197a5d493",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "ce149ed7_36464e59",
        "filename": "firmware/2lib/2load_android_kernel.c",
        "patchSetId": 9
      },
      "lineNbr": 96,
      "author": {
        "id": 1562687
      },
      "writtenOn": "2025-01-29T14:06:49Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "51feb98e_f44d1c3a",
      "revId": "606fd3bf91449183fa41f01afb8e306197a5d493",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "65994bf9_2d324cfb",
        "filename": "firmware/2lib/include/2api.h",
        "patchSetId": 9
      },
      "lineNbr": 631,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2025-01-23T00:52:35Z",
      "side": 1,
      "message": "I wonder if rather than all these unstructured values, we should do something like this:\n```\n  struct {\n    void *buffer;\n    size_t size;\n  } preloaded[GPT_ANDROID_PRELOADED_NUM];\n```\nThen we\u0027d have to do modify the enum a little:\n```\nenum GptPartition {\n  GPT_ANDROID_BOOT \u003d 0,\n  GPT_ANDROID_INIT_BOOT,\n  GPT_ANDROID_VENDOR_BOOT,\n  GPT_ANDROID_PVMFW,\n  GPT_ANDROID_PRELOADED_NUM,\n  \n  /* Partitions below this point do not get passed via kparams */\n  GPT_ANDROID_MISC \u003d GPT_ANDROID_PRELOADED_NUM,\n  GPT_ANDROID_VBMETA,\n};\n```\nThen you could do the preloading with something like\n```\nfor (enum GptPartition p \u003d 0; p \u003c GPT_ANDROID_PRELOADED_NUM; p++) {\n  VB2_TRY(vb2_load_android_partition(gpt, p, params-\u003ecurrent_android_slot_suffix,\n                                     buf, buf_size, disk_handle, \u0026bytes_used));\n  params-\u003epreloaded[p].buffer \u003d buf;\n  params-\u003epreloaded[p].size \u003d bytes_used;\n  buf +\u003d bytes_used;\n  buf_size -\u003d bytes_used;\n}\n```\nand the implementation of `vboot_avb_get_preloaded_partition()` also gets cleaner:\n```\nfor (enum GptPartition p \u003d 0; p \u003c GPT_ANDROID_PRELOADED_NUM; p++) {\n  if (!strncmp(partition, GptPartitionNames[p], prefix_len)) {\n    *out_pointer \u003d params-\u003epreloaded[p].buffer;\n    *out_num_bytes_preloaded \u003d params-\u003epreloaded[p].size;\n    return AVB_IO_RESULT_OK;\n  }\n}\n```",
      "fixSuggestions": [
        {
          "fixId": "922b655d_62f04963",
          "description": "prompt_to_edit API",
          "replacements": [
            {
              "path": "firmware/2lib/include/2api.h",
              "range": {
                "startLine": 618,
                "startChar": 0,
                "endLine": 628,
                "endChar": 0
              },
              "replacement": "\t/* Preloaded partitions. */\n\tstruct {\n\t\tvoid *buffer;\n\t\tsize_t size;\n\t} preloaded[GPT_ANDROID_PRELOADED_NUM];\n"
            }
          ]
        }
      ],
      "revId": "606fd3bf91449183fa41f01afb8e306197a5d493",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d21038dd_388d6a89",
        "filename": "firmware/2lib/include/2api.h",
        "patchSetId": 9
      },
      "lineNbr": 631,
      "author": {
        "id": 1562687
      },
      "writtenOn": "2025-01-29T14:06:49Z",
      "side": 1,
      "message": "Ok, I can do that, just one question, should I move `enum GptPartition` to 2api.h or include cgptlib.h in 2api.h?",
      "parentUuid": "65994bf9_2d324cfb",
      "revId": "606fd3bf91449183fa41f01afb8e306197a5d493",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "23e6b4c3_f5d24ed7",
        "filename": "firmware/2lib/include/2api.h",
        "patchSetId": 9
      },
      "lineNbr": 631,
      "author": {
        "id": 1562687
      },
      "writtenOn": "2025-01-30T11:29:15Z",
      "side": 1,
      "message": "Hi Julius, it would be nice to link list of partition to preload with the list of partition to verify (`boot_partitions` variable in `2load_android` function).\nBut there is a \u0027pvmfw\u0027 partition which is part of GPT layout but the content of this partition may not be valid on each board family. Right now we are checking value of \u0027pvmfw_buffer_size\u0027 to determine if it needs to be loaded.\n\nPlease let me know if you ok with leaving this workaround and add something like:\n```\nif ((p \u003d\u003d GPT_ANDROID_PVMFW) \u0026\u0026 (params-\u003epvmfw_buffer_size \u003d\u003d 0))\n    continue;\n```\nto the function which preloads partitions.",
      "parentUuid": "d21038dd_388d6a89",
      "revId": "606fd3bf91449183fa41f01afb8e306197a5d493",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "84912ed6_5382695a",
        "filename": "firmware/2lib/include/2api.h",
        "patchSetId": 9
      },
      "lineNbr": 631,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2025-02-01T02:31:50Z",
      "side": 1,
      "message": "Move the enum to `2api.h`.\n\nYeah, I guess pvmfw will need to be treated specially if we want to have it in CBMEM. And the ramdisk may also need to be treated specially if we want to load it straight to a different memory area than the kernel, as discussed in that one other CL. So I guess you may need to expand the suggestion above a bit... uhh... okay this is getting a bit complicated, let me know if this makes things too confusing, but I think you could do:\n```\nfor (enum GptPartition p \u003d 0; p \u003c GPT_ANDROID_PRELOADED_NUM; p++) {\n  void **buffer_ptr;\n  size_t *size_ptr;\n  switch (p) {\n  case GPT_ANDROID_PVMFW:\n    if (!params-\u003epvmfw_buffer_size)\n      continue; /* don\u0027t load pvmfw if not requested */\n    buffer_ptr \u003d \u0026params-\u003epvmfw_buffer;\n    size_ptr \u003d \u0026params-\u003epvmfw_buffer_size;\n    break;\n  case GPT_ANDROID_VENDOR_BOOT:\n  case GPT_ANDROID_INIT_BOOT:\n    if (params-\u003eramdisk_buffer_size) {\n      /* x86 case */\n      buffer_ptr \u003d \u0026params-\u003eramdisk_buffer;\n      size_ptr \u003d \u0026params-\u003eramdisk_buffer_size;\n      break;\n    }\n    /* otherwise fallthrough, use default buffer for the Arm case */\n  default:\n    buffer_ptr \u003d \u0026params-\u003ekernel_buffer;\n    size_ptr \u003d \u0026params-\u003ekernel_buffer_size;\n  }\n  VB2_TRY(vb2_load_android_partition(gpt, p, params-\u003ecurrent_android_slot_suffix,\n                                     *buffer_ptr, *size_ptr, disk_handle, \u0026bytes_used));\n  params-\u003epreloaded[p].buffer \u003d *buffer_ptr;\n  params-\u003epreloaded[p].size \u003d bytes_used;\n  *buffer_ptr +\u003d bytes_used;\n  *size_ptr -\u003d bytes_used;\n}\n```\n(BTW I also just realized that `VENDOR_BOOT` should probably come before `INIT_BOOT` in the enum so that it gets loaded first... I think that\u0027s important for the ramdisk coalescing later.)",
      "parentUuid": "23e6b4c3_f5d24ed7",
      "revId": "606fd3bf91449183fa41f01afb8e306197a5d493",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "059967e0_b69c6b4c",
        "filename": "firmware/avb/vboot_avb_ops.c",
        "patchSetId": 9
      },
      "lineNbr": 270,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2025-01-23T00:52:35Z",
      "side": 1,
      "message": "`strlen()` is a more than trivially expensive operation so you should try to make as few calls as possible and cache the results in a variable if needed.\n\nIn general maybe this first part looks a little more complicated than it needs to be... how about writing it like this:\n```\nconst char *suffix \u003d strrchr(\u0027_\u0027, partition);\nif (!suffix || strcmp(suffix, avbctx-\u003eparams-\u003ecurrent_android_slot_suffix) !\u003d 0)\n  return AVB_IO_RESULT_ERROR_NO_SUCH_PARTITION;\n\nsize_t prefix_len \u003d suffix - partition;\n```",
      "revId": "606fd3bf91449183fa41f01afb8e306197a5d493",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "9db8223a_2a42f6b4",
        "filename": "firmware/avb/vboot_avb_ops.c",
        "patchSetId": 9
      },
      "lineNbr": 270,
      "author": {
        "id": 1562687
      },
      "writtenOn": "2025-01-29T15:17:10Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "059967e0_b69c6b4c",
      "revId": "606fd3bf91449183fa41f01afb8e306197a5d493",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ea4e9dec_add4378f",
        "filename": "firmware/avb/vboot_avb_ops.c",
        "patchSetId": 9
      },
      "lineNbr": 285,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2025-01-23T00:52:35Z",
      "side": 1,
      "message": "Put this before the first `return`.",
      "revId": "606fd3bf91449183fa41f01afb8e306197a5d493",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "f2531679_53ebe46c",
        "filename": "firmware/avb/vboot_avb_ops.c",
        "patchSetId": 9
      },
      "lineNbr": 285,
      "author": {
        "id": 1562687
      },
      "writtenOn": "2025-01-29T14:06:49Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "ea4e9dec_add4378f",
      "revId": "606fd3bf91449183fa41f01afb8e306197a5d493",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    }
  ]
}