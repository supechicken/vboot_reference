{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "58a26ab7_b8d22b0e",
        "filename": "firmware/2lib/2kernel.c",
        "patchSetId": 2
      },
      "lineNbr": 258,
      "author": {
        "id": 1353551
      },
      "writtenOn": "2022-06-24T07:01:07Z",
      "side": 1,
      "message": "This can be moved outside the switch statement, because `recovery_reason !\u003d 0` is equivalent to `VB2_BOOT_MODE_MANUAL_RECOVERY || VB2_BOOT_MODE_BROKEN_SCREEN`.",
      "range": {
        "startLine": 253,
        "startChar": 2,
        "endLine": 258,
        "endChar": 3
      },
      "revId": "87af50447bbe04f536bd9fc78c1918b738e9c952",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d0f4b075_c3b69d38",
        "filename": "firmware/2lib/2kernel.c",
        "patchSetId": 2
      },
      "lineNbr": 258,
      "author": {
        "id": 1383774
      },
      "writtenOn": "2022-06-24T08:06:13Z",
      "side": 1,
      "message": "nit: actually there was still \"force recovery mode\" (*) so it would be more precise that\n\"recovery_reason !\u003d 0\" implies \"VB2_BOOT_MODE_MANUAL_RECOVERY || VB2_BOOT_MODE_BROKEN_SCREEN\"\n\n(*): https://source.chromium.org/chromiumos/chromiumos/codesearch/+/main:src/platform/vboot_reference/firmware/2lib/2misc.c;l\u003d727",
      "parentUuid": "58a26ab7_b8d22b0e",
      "range": {
        "startLine": 253,
        "startChar": 2,
        "endLine": 258,
        "endChar": 3
      },
      "revId": "87af50447bbe04f536bd9fc78c1918b738e9c952",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e08f09a1_d7b801ed",
        "filename": "firmware/2lib/2kernel.c",
        "patchSetId": 2
      },
      "lineNbr": 258,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2022-06-24T23:24:09Z",
      "side": 1,
      "message": "I would suggest to stick to the boot_mode field as the source of truth, as it\u0027s written here. Just to keep things simple.",
      "parentUuid": "d0f4b075_c3b69d38",
      "range": {
        "startLine": 253,
        "startChar": 2,
        "endLine": 258,
        "endChar": 3
      },
      "revId": "87af50447bbe04f536bd9fc78c1918b738e9c952",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "da5749b0_fd642adb",
        "filename": "firmware/2lib/2kernel.c",
        "patchSetId": 2
      },
      "lineNbr": 258,
      "author": {
        "id": 1547233
      },
      "writtenOn": "2022-06-27T07:03:35Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "e08f09a1_d7b801ed",
      "range": {
        "startLine": 253,
        "startChar": 2,
        "endLine": 258,
        "endChar": 3
      },
      "revId": "87af50447bbe04f536bd9fc78c1918b738e9c952",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "21a96683_d0d55815",
        "filename": "firmware/2lib/2kernel.c",
        "patchSetId": 2
      },
      "lineNbr": 274,
      "author": {
        "id": 1353551
      },
      "writtenOn": "2022-06-24T07:01:07Z",
      "side": 1,
      "message": "Since this debug message is to explain why we end up in broken screen instead of manual recovery screen, it looks more reasonable to move it to depthcharge (i.e., `VbSelectAndLoadKernel` in this CL).",
      "range": {
        "startLine": 273,
        "startChar": 2,
        "endLine": 274,
        "endChar": 43
      },
      "revId": "87af50447bbe04f536bd9fc78c1918b738e9c952",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "2a8092c5_2d387ebf",
        "filename": "firmware/2lib/2kernel.c",
        "patchSetId": 2
      },
      "lineNbr": 274,
      "author": {
        "id": 1547233
      },
      "writtenOn": "2022-06-27T07:03:35Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "21a96683_d0d55815",
      "range": {
        "startLine": 273,
        "startChar": 2,
        "endLine": 274,
        "endChar": 43
      },
      "revId": "87af50447bbe04f536bd9fc78c1918b738e9c952",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b3cf9bb0_d645681c",
        "filename": "firmware/2lib/2kernel.c",
        "patchSetId": 2
      },
      "lineNbr": 282,
      "author": {
        "id": 1353551
      },
      "writtenOn": "2022-06-24T07:01:07Z",
      "side": 1,
      "message": "This can also be cleared regardless of the boot mode. For the `vb2ex_commit_data()` call below, however, I think we can do it only in:\n\n- VB2_BOOT_MODE_MANUAL_RECOVERY\n- VB2_BOOT_MODE_BROKEN_SCREEN\n- VB2_BOOT_MODE_DIAGNOSTICS\n\n```\nvb2_nv_set(ctx, VB2_NV_DIAG_REQUEST, 0);\n\nif (ctx-\u003eflags \u0026 VB2_CONTEXT_RECOVERY_MODE ||\n    ctx-\u003eboot_mode \u003d\u003d VB2_BOOT_MODE_DIAGNOSTICS) {\n    // Combine to 2 comment block here\n    vb2ex_commit_data(ctx);\n}\n```\n\nIf `VB2_NV_DIAG_REQUEST` is changed from 1 to 0 in developer or normal mode, not calling `vb2ex_commit_data()` should be fine, because it will be called from `commit_and_lock_cleanup_func()` in depthcharge.",
      "range": {
        "startLine": 282,
        "startChar": 18,
        "endLine": 282,
        "endChar": 37
      },
      "revId": "87af50447bbe04f536bd9fc78c1918b738e9c952",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ded43fb8_c82b4f65",
        "filename": "firmware/2lib/2kernel.c",
        "patchSetId": 2
      },
      "lineNbr": 282,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2022-06-24T23:24:09Z",
      "side": 1,
      "message": "I\u0027m not sure if we still need to have this anyway, since minidiag is in depthcharge now and even if we did third-party diag again, the current depthcharge code will commit nvdata for CleanupOnLegacy (which I don\u0027t think we had yet when this was added here). So there should be no path where it exits the diagnostics without writing back nvdata.\n\nI think it should be enough to clear this flag unconditionally (like you said) and get rid of the commit_data() here.",
      "parentUuid": "b3cf9bb0_d645681c",
      "range": {
        "startLine": 282,
        "startChar": 18,
        "endLine": 282,
        "endChar": 37
      },
      "revId": "87af50447bbe04f536bd9fc78c1918b738e9c952",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "60e82069_f477b822",
        "filename": "firmware/2lib/2kernel.c",
        "patchSetId": 2
      },
      "lineNbr": 282,
      "author": {
        "id": 1353551
      },
      "writtenOn": "2022-06-25T11:24:57Z",
      "side": 1,
      "message": "+menghuan@\n\nI\u0027m not sure what \"forced system reset\" means here (like HW reset?), but this seems to be added intentionally in CL:2624110. menghuan@, do you remember what this is about?",
      "parentUuid": "ded43fb8_c82b4f65",
      "range": {
        "startLine": 282,
        "startChar": 18,
        "endLine": 282,
        "endChar": 37
      },
      "revId": "87af50447bbe04f536bd9fc78c1918b738e9c952",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e8ec136d_cf5c51dd",
        "filename": "firmware/2lib/2kernel.c",
        "patchSetId": 2
      },
      "lineNbr": 282,
      "author": {
        "id": 1547233
      },
      "writtenOn": "2022-06-27T07:03:35Z",
      "side": 1,
      "message": "If we clear the `VB2_NV_DIAG_REQUEST` unconditionally, this test (https://source.corp.google.com/chromeos_public/src/platform/vboot_reference/tests/vboot_api_kernel4_tests.c;l\u003d254) will fail. The reason is when vb2api_diagnostic_ui_enabled return 0, the original code will enter normal boot and reboot (see https://chromium-review.googlesource.com/c/chromiumos/platform/vboot_reference/+/1634451 for detail), but it will not reboot if we clear this flag beforehand.",
      "parentUuid": "60e82069_f477b822",
      "range": {
        "startLine": 282,
        "startChar": 18,
        "endLine": 282,
        "endChar": 37
      },
      "revId": "87af50447bbe04f536bd9fc78c1918b738e9c952",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "947262b1_817bb673",
        "filename": "firmware/2lib/2kernel.c",
        "patchSetId": 2
      },
      "lineNbr": 282,
      "author": {
        "id": 1353551
      },
      "writtenOn": "2022-06-27T08:10:05Z",
      "side": 1,
      "message": "Okay let\u0027s leave this unchanged for now. We can have a follow-up discussion about this.",
      "parentUuid": "e8ec136d_cf5c51dd",
      "range": {
        "startLine": 282,
        "startChar": 18,
        "endLine": 282,
        "endChar": 37
      },
      "revId": "87af50447bbe04f536bd9fc78c1918b738e9c952",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ce0126b5_5cb8e9ac",
        "filename": "firmware/2lib/2kernel.c",
        "patchSetId": 2
      },
      "lineNbr": 289,
      "author": {
        "id": 1353551
      },
      "writtenOn": "2022-06-24T07:01:07Z",
      "side": 1,
      "message": "Move this as well. Eventually we will want call it from depthcharge.",
      "range": {
        "startLine": 289,
        "startChar": 10,
        "endLine": 289,
        "endChar": 25
      },
      "revId": "87af50447bbe04f536bd9fc78c1918b738e9c952",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "e28ad59b_59ed583d",
        "filename": "firmware/2lib/2kernel.c",
        "patchSetId": 2
      },
      "lineNbr": 289,
      "author": {
        "id": 1547233
      },
      "writtenOn": "2022-06-27T07:03:35Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "ce0126b5_5cb8e9ac",
      "range": {
        "startLine": 289,
        "startChar": 10,
        "endLine": 289,
        "endChar": 25
      },
      "revId": "87af50447bbe04f536bd9fc78c1918b738e9c952",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "927ca508_9d9a5790",
        "filename": "firmware/2lib/2kernel.c",
        "patchSetId": 2
      },
      "lineNbr": 292,
      "author": {
        "id": 1353551
      },
      "writtenOn": "2022-06-24T07:01:07Z",
      "side": 1,
      "message": "IMO this also belongs to `VbSelectAndLoadKernel`.",
      "range": {
        "startLine": 292,
        "startChar": 9,
        "endLine": 292,
        "endChar": 33
      },
      "revId": "87af50447bbe04f536bd9fc78c1918b738e9c952",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "8633c4ec_f0e93b6a",
        "filename": "firmware/lib/vboot_api_kernel.c",
        "patchSetId": 2
      },
      "lineNbr": 146,
      "author": {
        "id": 1353551
      },
      "writtenOn": "2022-06-24T07:01:07Z",
      "side": 1,
      "message": "One blank line below, and no need for above.",
      "revId": "87af50447bbe04f536bd9fc78c1918b738e9c952",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "ee781f8f_8d5f014b",
        "filename": "firmware/lib/vboot_api_kernel.c",
        "patchSetId": 2
      },
      "lineNbr": 146,
      "author": {
        "id": 1547233
      },
      "writtenOn": "2022-06-27T07:03:35Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "8633c4ec_f0e93b6a",
      "revId": "87af50447bbe04f536bd9fc78c1918b738e9c952",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "71b6ad13_cc2b780f",
        "filename": "firmware/lib/vboot_api_kernel.c",
        "patchSetId": 2
      },
      "lineNbr": 151,
      "author": {
        "id": 1353551
      },
      "writtenOn": "2022-06-24T07:01:07Z",
      "side": 1,
      "message": "We don\u0027t need the `if` anymore. Just move `vb2ex_manual_recovery_ui` to the `VB2_BOOT_MODE_MANUAL_RECOVERY` switch case.",
      "range": {
        "startLine": 151,
        "startChar": 2,
        "endLine": 151,
        "endChar": 4
      },
      "revId": "87af50447bbe04f536bd9fc78c1918b738e9c952",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "62838ce2_b10681bd",
        "filename": "firmware/lib/vboot_api_kernel.c",
        "patchSetId": 2
      },
      "lineNbr": 151,
      "author": {
        "id": 1547233
      },
      "writtenOn": "2022-06-27T07:03:35Z",
      "side": 1,
      "message": "Since we move\n```\nif (tcx-\u003eflags \u0026 VB2_CONTEXT_NO_BOOT)\n        VB2_DEBUG(\"NO_BOOT in RECOVERY mode\\n\");\n```\nis moved to here, we still need the `if` here.",
      "parentUuid": "71b6ad13_cc2b780f",
      "range": {
        "startLine": 151,
        "startChar": 2,
        "endLine": 151,
        "endChar": 4
      },
      "revId": "87af50447bbe04f536bd9fc78c1918b738e9c952",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "739bc6e7_14cdd768",
        "filename": "firmware/lib/vboot_api_kernel.c",
        "patchSetId": 2
      },
      "lineNbr": 151,
      "author": {
        "id": 1353551
      },
      "writtenOn": "2022-06-27T08:10:05Z",
      "side": 1,
      "message": "Ack",
      "parentUuid": "62838ce2_b10681bd",
      "range": {
        "startLine": 151,
        "startChar": 2,
        "endLine": 151,
        "endChar": 4
      },
      "revId": "87af50447bbe04f536bd9fc78c1918b738e9c952",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "bd0d5f14_49850e42",
        "filename": "firmware/lib/vboot_api_kernel.c",
        "patchSetId": 2
      },
      "lineNbr": 171,
      "author": {
        "id": 1353551
      },
      "writtenOn": "2022-06-24T07:01:07Z",
      "side": 1,
      "message": "One blank line above.",
      "revId": "87af50447bbe04f536bd9fc78c1918b738e9c952",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "17b488ea_4faf3090",
        "filename": "firmware/lib/vboot_api_kernel.c",
        "patchSetId": 2
      },
      "lineNbr": 171,
      "author": {
        "id": 1547233
      },
      "writtenOn": "2022-06-27T07:03:35Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "bd0d5f14_49850e42",
      "revId": "87af50447bbe04f536bd9fc78c1918b738e9c952",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    }
  ]
}