{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "4f2620e6_0c717307",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2021-07-16T00:59:39Z",
      "side": 1,
      "message": "Yeah, with vboot2 we have started using more C standard library functions directly again, when they are really common and their behavior is really universal. I\u0027m not sure if I want to go back on that trend, because if you go all the way to the other extreme you have things like vb2ex_memset() and vb2_uint32_t everywhere, and I don\u0027t think we want that sort of clutter either.\n\nCan you not just solve this on the caller side instead? You can make a special include directory specifically for vboot system headers, that you put in the include path in front of everything else in the CFLAGS specific to vboot. And there you can have a stub \u003cstdlib.h\u003e that both includes the real stblib.h (e.g. through \"../../real/path/stdlib.h\") and defines a macro for malloc that does whatever special thing you want it to do. If you already have a conforming malloc() prototype in stdlib and you just don\u0027t want to use that function for vboot, you can also pass a --wrap LDFLAG to vboot, or objcopy the output library with --redefine-sym.",
      "revId": "4b0b8db6c45b8702e3b2ecebcd6034739275f084",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "61349a91_09553206",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1165921
      },
      "writtenOn": "2021-07-16T13:45:48Z",
      "side": 1,
      "message": "I\u0027m not suggesting changing string.h or types and I agree that would just be clutter. Note however that we do have vb2_safe_memcmp(), perhaps for the opposite reason.\n\nmalloc() is special in some ways, because it is an extremely dangerous function to use in a library. It can cause run-time failure if memory is exhausted, so it seems right to me for it to be part of the interface,\n\nRe the last idea, I certainly don\u0027t like the idea of requiring linker magic to link vboot. That is the tail wagging the dog.\n\nAs to solving it on the caller side, there are several issues. One is that malloc() does get hacked around by things like valgrind. We want to check some allocations but when you are testing you want to fence off the system libraries (which can call malloc())) from the things you actually care about. Otherwise debugging or allocation logging becomes unmanageable - lots of irrelevant activity. Another is that malloc() may be defined to something else, meaning that you have to have a stub stdlib.h as you suggest. But stdlib.h is a standard library so it seems weird to require it to be perverted to do what you are suggesting.\n\nOverall I think vboot should be a library and should be easy to integrate. Things like this make it harder.",
      "parentUuid": "4f2620e6_0c717307",
      "revId": "4b0b8db6c45b8702e3b2ecebcd6034739275f084",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "c953d3f9_41850d93",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2021-07-20T23:44:43Z",
      "side": 1,
      "message": "\u003e Overall I think vboot should be a library and should be easy to integrate. Things like this make it harder.\n\nWell, I would say requiring all of these to be separate APIs actually makes it harder. Basically, when you require a vb2ex_ wrapper for all the libc stuff, you require the caller to provide an extra stub header that defines all of them (and usually just with a single macro or static inline each that redirect them to the function you actually meant). That\u0027s about the same extra effort as it is to provide the stub header I described to redirect a normal libc call. But the difference is that most callers already have a malloc() and are fine with just using that directly, so using this scheme we can save them the effort of adding extra wrapper headers, and only projects like U-Boot that actually have an interest in keeping vboot malloc()s apart from other ones need to invest the extra effort.\n\nI\u0027d prefer to avoid the inconsistency of treating malloc() different from other standard library functions, and I don\u0027t think we want to start having wrappers for all of them. So I would prefer to continue with what we have and have callers use the techniques I described if they want to fine-tune their vboot bindings. (vb2_safe_memcmp() is a separate thing, that\u0027s just about the `safe` aspect, not about wrapping memcmp(). And it\u0027s probably unnecessary for the things we do with it, but it hasn\u0027t bothered anyone enough to get rid of it yet.)",
      "parentUuid": "61349a91_09553206",
      "revId": "4b0b8db6c45b8702e3b2ecebcd6034739275f084",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "45647039_b9eaa5d4",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1165921
      },
      "writtenOn": "2021-08-12T16:53:30Z",
      "side": 1,
      "message": "As I said, linker magic is really not a good solution. I have fiddled with it but it really doesn\u0027t work. If your library requires that, it is not really a library IMO. I feel that vboot should be more free-standing. It also means that malloc() is inconsistent (e.g. with sandbox there is a system malloc() and an free-standing malloc()).\n\nThe change to DC is pretty small:\nhttps://chromium-review.googlesource.com/c/chromiumos/platform/depthcharge/+/3033329\n\nCoreboot doesn\u0027t need anything so far as I can tell.\n\nmalloc() is special IMO. It allocates memory and can fail. So treating it in a special way (as vboot used to do) seems like a good idea to me.\n\nIf you are really dead set against this, we could perhaps handle this with a weak function provided by vboot, or a CONFIG option to enable the malloc() naming. Would either of those work?",
      "parentUuid": "c953d3f9_41850d93",
      "revId": "4b0b8db6c45b8702e3b2ecebcd6034739275f084",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "ee3cd00b_5043d64d",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2021-08-17T23:27:09Z",
      "side": 1,
      "message": "Well you don\u0027t need to use linker magic, you just need to create an extra stub header in a separate directory? (I said you can use --wrap or --redefine-sym as a shortcut if that works for you, but you don\u0027t have to... providing custom headers is the most flexible approach.) Sorry, I fail to see what\u0027s so problematic about that. If you can\u0027t get it to work I\u0027m happy to help look at the patch.",
      "parentUuid": "45647039_b9eaa5d4",
      "revId": "4b0b8db6c45b8702e3b2ecebcd6034739275f084",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    }
  ]
}