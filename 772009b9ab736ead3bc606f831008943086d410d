{
  "comments": [
    {
      "key": {
        "uuid": "12c59930_92118e6d",
        "filename": "firmware/lib/vboot_api_kernel.c",
        "patchSetId": 6
      },
      "lineNbr": 336,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2019-08-16T20:38:52Z",
      "side": 1,
      "message": "You need to be careful with recovery mode... it should always continue, even if all TPM communication is broken.",
      "revId": "772009b9ab736ead3bc606f831008943086d410d",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "6f558f84_f85a4de7",
        "filename": "firmware/lib/vboot_api_kernel.c",
        "patchSetId": 6
      },
      "lineNbr": 336,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2019-08-19T10:55:43Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "12c59930_92118e6d",
      "revId": "772009b9ab736ead3bc606f831008943086d410d",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "f5939dae_ced79f9d",
        "filename": "firmware/lib/vboot_api_kernel.c",
        "patchSetId": 6
      },
      "lineNbr": 347,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2019-08-16T20:38:52Z",
      "side": 1,
      "message": "I think this is the first time we\u0027re using the secdatak code in production? Looking through it, secdatak_check() needs some work (should also check struct version).",
      "revId": "772009b9ab736ead3bc606f831008943086d410d",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "fe693963_db9b5d46",
        "filename": "firmware/lib/vboot_api_kernel.c",
        "patchSetId": 6
      },
      "lineNbr": 347,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2019-08-19T10:55:43Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "f5939dae_ced79f9d",
      "revId": "772009b9ab736ead3bc606f831008943086d410d",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "0cf1e25d_fee00fb2",
        "filename": "firmware/lib/vboot_api_kernel.c",
        "patchSetId": 6
      },
      "lineNbr": 347,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2019-08-20T07:05:26Z",
      "side": 1,
      "message": "Moved to CL:1758149.",
      "parentUuid": "fe693963_db9b5d46",
      "revId": "772009b9ab736ead3bc606f831008943086d410d",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "0aa8427c_47f14a75",
        "filename": "firmware/lib/vboot_api_kernel.c",
        "patchSetId": 6
      },
      "lineNbr": 408,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2019-08-16T20:38:52Z",
      "side": 1,
      "message": "Might be good to at least print a warning here if SECDATA_CHANGED is true but we\u0027re not in recovery mode.",
      "revId": "772009b9ab736ead3bc606f831008943086d410d",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "9f425e46_7a03ac99",
        "filename": "firmware/lib/vboot_api_kernel.c",
        "patchSetId": 6
      },
      "lineNbr": 408,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2019-08-19T10:55:43Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "0aa8427c_47f14a75",
      "revId": "772009b9ab736ead3bc606f831008943086d410d",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "764417c9_b6fa346c",
        "filename": "firmware/lib/vboot_api_kernel.c",
        "patchSetId": 6
      },
      "lineNbr": 666,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2019-08-16T20:38:52Z",
      "side": 1,
      "message": "Why not just call this from kernel_cleanup?",
      "revId": "772009b9ab736ead3bc606f831008943086d410d",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "4ce92158_9b45abc3",
        "filename": "firmware/lib/vboot_api_kernel.c",
        "patchSetId": 6
      },
      "lineNbr": 666,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2019-08-19T10:55:43Z",
      "side": 1,
      "message": "Well, actually it\u0027s kind of awkward, because vb2_kernel_phase4 locks secdatak space, so it needs to occur before vb2_kernel_cleanup.\n\nOn top of that we have the two cases to consider: the typical VbSelectAndLoadKernel case, and the VbVerifyMemoryBootImage case (for fastboot).  The former doesn\u0027t lock secdatak.  (It\u0027s also not used anywhere currently...)\n\nIn the latest patchset, I added an argument to vb2_kernel_cleanup to decide whether locking should be performed, and the argument is passed onto vb2_secdatak_commit.  Not really sure I like this \"mixing arguments and context checking\" together.  If we really want to keep the VbVerifyMemoryBootImage case, then maybe we should introduce a context flag called VB2_CONTEXT_LOCK_SECDATAK.\n\nNot to mention when the step is moved into depthcharge, it\u0027ll need that information somehow.  (Although if the calling code is separate [i.e. from fastboot], then it\u0027ll already know whether or not it should lock secdatak.)",
      "parentUuid": "764417c9_b6fa346c",
      "revId": "772009b9ab736ead3bc606f831008943086d410d",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "fb5ce30b_f95a83b1",
        "filename": "firmware/lib/vboot_api_kernel.c",
        "patchSetId": 6
      },
      "lineNbr": 666,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2019-08-19T22:32:53Z",
      "side": 1,
      "message": "\u003e On top of that we have the two cases to consider: the typical VbSelectAndLoadKernel case, and the VbVerifyMemoryBootImage case (for fastboot).  The former doesn\u0027t lock secdatak.\n\nI assume you meant \"the latter\"? If VbVerifyMemoryBootImage() doesn\u0027t lock the TPM, I\u0027m pretty sure that\u0027s a bug. The TPM should always be locked for all boot modes.\n\nI\u0027m fine with putting both the writeback and the locking into kernel_phase4(), or both into kernel_cleanup() (not quite sure what the difference is supposed to be anyway). Either way they should probably be together. When we move that stuff into depthcharge, I expect the locking should move there as well... the same is done for firmware verification.",
      "parentUuid": "4ce92158_9b45abc3",
      "revId": "772009b9ab736ead3bc606f831008943086d410d",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ef6a5618_535914fd",
        "filename": "firmware/lib/vboot_api_kernel.c",
        "patchSetId": 6
      },
      "lineNbr": 666,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2019-08-20T07:05:26Z",
      "side": 1,
      "message": "In theory VbVerifyMemoryBootImage \"verifies\" that the image can be booted, and the rest of the process is taken care of in fb_boot(), iff VbVerifyMemoryBootImage succeeds.  So I\u0027m not totally sure it makes sense to do the locking within VbVerifyMemoryBootImage?  (But again, wait and see if we decide to nuke fastboot.)\n\nMore about VbVerifyMemoryBootImage -- the boot image is passed directly to the function, so it doesn\u0027t make sense to call vb2_kernel_phase4, which grabs the disk parameters from the lkp global.",
      "parentUuid": "fb5ce30b_f95a83b1",
      "revId": "772009b9ab736ead3bc606f831008943086d410d",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "de090445_3943c295",
        "filename": "firmware/lib/vboot_api_kernel.c",
        "patchSetId": 6
      },
      "lineNbr": 666,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2019-08-21T01:19:13Z",
      "side": 1,
      "message": "Well, fb_boot() certainly isn\u0027t locking it either. It should be locked somewhere.",
      "parentUuid": "ef6a5618_535914fd",
      "revId": "772009b9ab736ead3bc606f831008943086d410d",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "956fd2bb_0872ae52",
        "filename": "firmware/lib/vboot_api_kernel.c",
        "patchSetId": 6
      },
      "lineNbr": 666,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2019-08-21T04:20:01Z",
      "side": 1,
      "message": "Fair enough.  Let\u0027s just lock it in both paths.",
      "parentUuid": "de090445_3943c295",
      "revId": "772009b9ab736ead3bc606f831008943086d410d",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    }
  ]
}