{
  "comments": [
    {
      "key": {
        "uuid": "3a5e3919_26b71fc2",
        "filename": "firmware/2lib/2ec_sync.c",
        "patchSetId": 1
      },
      "lineNbr": 368,
      "author": {
        "id": 1353551
      },
      "writtenOn": "2020-01-16T09:09:08Z",
      "side": 1,
      "message": "Since this is already checked at the beginning of vb2api_ec_sync(), why do we need to check again in both ec_sync_phase1() and ec_sync_phase2()? Is there a chance that the flags/recovery_reason would change between the calls? Or is it just for safety?",
      "revId": "26ed4464e2be0d54a56cf05a38e243dc1f6c7041",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "4c233f6c_70bb9bb5",
        "filename": "firmware/2lib/2ec_sync.c",
        "patchSetId": 1
      },
      "lineNbr": 435,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2020-01-16T19:24:57Z",
      "side": 1,
      "message": "Agree with Yu-Ping that we can take all these out now if we return immediately from the check up front.",
      "revId": "26ed4464e2be0d54a56cf05a38e243dc1f6c7041",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "54ab20c2_f272765c",
        "filename": "firmware/2lib/2ec_sync.c",
        "patchSetId": 1
      },
      "lineNbr": 454,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2020-01-16T19:24:57Z",
      "side": 1,
      "message": "Should merge this into ec_sync_allowed().",
      "revId": "26ed4464e2be0d54a56cf05a38e243dc1f6c7041",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "1dbf0333_0248cad2",
        "filename": "firmware/2lib/2ec_sync.c",
        "patchSetId": 1
      },
      "lineNbr": 478,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2020-01-16T19:24:57Z",
      "side": 1,
      "message": "I think our current code still calls this when EC sync was disabled, so we probably want to keep doing that. One problem is that we only want it called once, even when both coreboot and depthcharge run the sync code. So I think we may need to set the SYNC_COMPLETE flag for that reason after all.",
      "revId": "26ed4464e2be0d54a56cf05a38e243dc1f6c7041",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "99057d48_6878f367",
        "filename": "firmware/2lib/2ec_sync.c",
        "patchSetId": 1
      },
      "lineNbr": 478,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2020-01-17T05:12:10Z",
      "side": 1,
      "message": "It looks like all this function is doing is ensuring that EC is ready to continue with the boot process (specifically that it has enough power).\n\nCould we extricate it from the EC sync and just call it separately -- perhaps right after EC sync in depthcharge?  This could potentially also speed up boot time on EC-sync-in-coreboot machines, unless I\u0027m mistaken.\n\nIs there any requirement for this call to be before or after EC sync (when EC sync is enabled)?",
      "parentUuid": "1dbf0333_0248cad2",
      "revId": "26ed4464e2be0d54a56cf05a38e243dc1f6c7041",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "c0639dfd_73205267",
        "filename": "firmware/2lib/2ec_sync.c",
        "patchSetId": 1
      },
      "lineNbr": 478,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2020-01-22T00:33:34Z",
      "side": 1,
      "message": "Well, it needs to be called immediately after software sync, so when that happens in coreboot it should be called in coreboot (because the point of doing software sync in coreboot was that the system may not have enough power to boot further, and this call is used to determine that there).",
      "parentUuid": "99057d48_6878f367",
      "revId": "26ed4464e2be0d54a56cf05a38e243dc1f6c7041",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "fa60d53c_39208dda",
        "filename": "firmware/2lib/2ec_sync.c",
        "patchSetId": 1
      },
      "lineNbr": 478,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2020-02-03T09:52:38Z",
      "side": 1,
      "message": "\u003e I think our current code still calls this when EC sync was disabled\n\nIn coreboot, the call to vboot_sync_ec() is guarded by a conditional which checks VBOOT_EARLY_EC_SYNC.  Unless you\u0027re talking about disabling it via GBB flag?\n\n\ncoreboot has no way of knowing whether EC sync is enabled in depthcharge.\n\nTherefore it makes no sense for it to call vb2ex_ec_vboot_done() in the case that VBOOT_EARLY_EC_SYNC is disabled.  So coreboot would never set SYNC_COMPLETE unless it actually performs EC sync.\n\nIf we want to give coreboot the ability to call vb2ex_ec_vboot_done() when EC sync is disabled in BOTH coreboot and depthcharge, then we need to make some changes.\n\n\nIf we don\u0027t care about that case, and if we guarantee that vboot_sync_ec() is always guarded by VBOOT_EARLY_EC_SYNC, then I suppose this CL is a moot point, functionally speaking.  But I still think the current logic in this file is unnecessarily confusing, and could benefit from these changes.\n\nWaiting for your feedback before responding to the other comments.",
      "parentUuid": "c0639dfd_73205267",
      "revId": "26ed4464e2be0d54a56cf05a38e243dc1f6c7041",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "38839f5e_7e0056e4",
        "filename": "firmware/2lib/2ec_sync.c",
        "patchSetId": 1
      },
      "lineNbr": 478,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2020-02-06T01:10:51Z",
      "side": 1,
      "message": "Yes, I was talking about disabling via GBB flag. Whether to sync in coreboot or depthcharge is a compile-time decision, but whether that sync is enabled or not is a runtime decision (based on GBB flags, recovery mode, etc). vboot_done() is supposed to always run right after the point where EC sync was meant to happen (by compile-time decision), and only at that point, regardless of whether the sync was actually enabled during this boot or not.",
      "parentUuid": "fa60d53c_39208dda",
      "revId": "26ed4464e2be0d54a56cf05a38e243dc1f6c7041",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "dc3fc16f_5e51e262",
        "filename": "firmware/2lib/2ec_sync.c",
        "patchSetId": 1
      },
      "lineNbr": 478,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2020-02-06T03:40:33Z",
      "side": 1,
      "message": "I think we are well-equipped to handle the cases you have mentioned here:\n\n- sync in coreboot/depthcharge (compile-time decision)\n- sync enabled/disabled (runtime decision)\n\nBut as I mentioned before, we have no way of handling the case where EC sync is completely disabled.  Should we assume that one of the two will always be enabled, or should we make changes to allow for this situation?",
      "parentUuid": "38839f5e_7e0056e4",
      "revId": "26ed4464e2be0d54a56cf05a38e243dc1f6c7041",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "e239fe49_4f3e1cb7",
        "filename": "firmware/2lib/2ec_sync.c",
        "patchSetId": 1
      },
      "lineNbr": 478,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2020-02-06T03:51:58Z",
      "side": 1,
      "message": "Sorry, I\u0027m still not sure if we\u0027re talking along the same lines here. I think we need to preserve existing behavior of when vb2ex_vboot_done() is called (in all cases). This CL doesn\u0027t do that because it doesn\u0027t call it in the sync disabled (via GBB flag or because we\u0027re in recovery mode) case.",
      "parentUuid": "dc3fc16f_5e51e262",
      "revId": "26ed4464e2be0d54a56cf05a38e243dc1f6c7041",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "a4f835e8_45754bbb",
        "filename": "firmware/2lib/2ec_sync.c",
        "patchSetId": 1
      },
      "lineNbr": 478,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2020-02-09T09:30:07Z",
      "side": 1,
      "message": "I agree that we need to preserve the behaviour of vb2ex_vboot_done() being called.  I\u0027m just saying that our current code looks really weird.\n\nLet\u0027s just leave 2ec_sync.c untouched and increase the test coverage for now, and formalize the fact that we are expecting SYNC_COMPLETE to be set in all cases.  Is that okay?",
      "parentUuid": "e239fe49_4f3e1cb7",
      "revId": "26ed4464e2be0d54a56cf05a38e243dc1f6c7041",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    }
  ]
}