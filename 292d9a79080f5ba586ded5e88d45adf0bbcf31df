{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "5ad82e71_f5d052ff",
        "filename": "firmware/2lib/2load_android_kernel.c",
        "patchSetId": 16
      },
      "lineNbr": 55,
      "author": {
        "id": 1512562
      },
      "writtenOn": "2025-09-11T09:51:31Z",
      "side": 1,
      "message": "There are 3 basic boot modes: normal, dev, recovery. You cannot cover them with a boolean value.",
      "range": {
        "startLine": 55,
        "startChar": 65,
        "endLine": 55,
        "endChar": 81
      },
      "revId": "292d9a79080f5ba586ded5e88d45adf0bbcf31df",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "8e47f354_238991b9",
        "filename": "firmware/2lib/2load_android_kernel.c",
        "patchSetId": 16
      },
      "lineNbr": 55,
      "author": {
        "id": 1430007
      },
      "writtenOn": "2025-09-11T14:22:14Z",
      "side": 1,
      "message": "I\u0027m confused by this statement - normal/dev mode have to do with loading a modified/unverified OS, while IIUC recovery mode is it\u0027s own thing. The only two actual \"boot\" modes are normal and recovery as far as the bootloader is concerned - covered in vb2ex_get_android_bootmode?",
      "parentUuid": "5ad82e71_f5d052ff",
      "range": {
        "startLine": 55,
        "startChar": 65,
        "endLine": 55,
        "endChar": 81
      },
      "revId": "292d9a79080f5ba586ded5e88d45adf0bbcf31df",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "70aefb70_8619cbfb",
        "filename": "firmware/2lib/2load_android_kernel.c",
        "patchSetId": 16
      },
      "lineNbr": 55,
      "author": {
        "id": 1512562
      },
      "writtenOn": "2025-09-11T15:14:18Z",
      "side": 1,
      "message": "\u003e I\u0027m confused by this statement - normal/dev mode have to do with loading a modified/unverified OS, while IIUC recovery mode is it\u0027s own thing\n\nRecovery mode in vboot is not related to the OS recovery mode. vboot\u0027s recovery is staying in the RO (Read-Only) firmware version. There we can run either the ChromeOS-type recovery image or we can boot ChromeOS testimage. AFAIK for now Android is not supported in this mode. AL recovery is done through a specially prepared image.\n\n\u003e The only two actual \"boot\" modes are normal and recovery as far as the bootloader is concerned - covered in vb2ex_get_android_bootmode?\n\nThis is true for Android OS, but not the AL Firmware. \n\n---\n\nI got confused by the `dev_mode_transitioning` and `current_dev_mode` names. This actually describes changes between verified vs unverified OS which is not equal to transitioning between dev and normal modes (PTAL: `vb2_need_kernel_verification()`). I think that changing the name from `PREVIOUS_BOOT_DEV_MODE` to something like `KERNEL_VERIFICATION_PREVIOUS_BOOT` would make the intent clearer.",
      "parentUuid": "8e47f354_238991b9",
      "range": {
        "startLine": 55,
        "startChar": 65,
        "endLine": 55,
        "endChar": 81
      },
      "revId": "292d9a79080f5ba586ded5e88d45adf0bbcf31df",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "e826a913_2a365f34",
        "filename": "firmware/2lib/2load_android_kernel.c",
        "patchSetId": 16
      },
      "lineNbr": 55,
      "author": {
        "id": 1430007
      },
      "writtenOn": "2025-09-12T16:20:30Z",
      "side": 1,
      "message": "I see that kernel verification can be skipped even if were not in dev mode - what we care about in this case is the unlocked bootloader status which IIUC is \u003d\u003d to \"androidboot.verifiedbootstate\u003dorange\". I\u0027ve changed the name to be KERNEL_VERIFICATION_PREVIOUS_BOOT to match this closely",
      "parentUuid": "70aefb70_8619cbfb",
      "range": {
        "startLine": 55,
        "startChar": 65,
        "endLine": 55,
        "endChar": 81
      },
      "revId": "292d9a79080f5ba586ded5e88d45adf0bbcf31df",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e66a79a3_d3888d90",
        "filename": "firmware/2lib/2load_android_kernel.c",
        "patchSetId": 16
      },
      "lineNbr": 58,
      "author": {
        "id": 1512562
      },
      "writtenOn": "2025-09-11T09:51:31Z",
      "side": 1,
      "message": "This function is complicating the logic here. There is only a single use of it, so it can be removed and comment can be moved to the place of the usage.",
      "range": {
        "startLine": 55,
        "startChar": 0,
        "endLine": 58,
        "endChar": 1
      },
      "revId": "292d9a79080f5ba586ded5e88d45adf0bbcf31df",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "100310b8_fa139808",
        "filename": "firmware/2lib/2load_android_kernel.c",
        "patchSetId": 16
      },
      "lineNbr": 58,
      "author": {
        "id": 1430007
      },
      "writtenOn": "2025-09-11T14:22:14Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "e66a79a3_d3888d90",
      "range": {
        "startLine": 55,
        "startChar": 0,
        "endLine": 58,
        "endChar": 1
      },
      "revId": "292d9a79080f5ba586ded5e88d45adf0bbcf31df",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "09fbcb5d_7e92af79",
        "filename": "firmware/2lib/2load_android_kernel.c",
        "patchSetId": 16
      },
      "lineNbr": 379,
      "author": {
        "id": 1512562
      },
      "writtenOn": "2025-09-11T09:51:31Z",
      "side": 1,
      "message": "style: comment not matching requirements. Please use one of the styles below:\n```\n/* Short multiline\n   comment */\n\n/* \n * Long\n * multiline\n * comment\n */\n ```",
      "range": {
        "startLine": 378,
        "startChar": 1,
        "endLine": 379,
        "endChar": 43
      },
      "revId": "292d9a79080f5ba586ded5e88d45adf0bbcf31df",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "34cb8666_613b5962",
        "filename": "firmware/2lib/2load_android_kernel.c",
        "patchSetId": 16
      },
      "lineNbr": 379,
      "author": {
        "id": 1430007
      },
      "writtenOn": "2025-09-11T14:22:14Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "09fbcb5d_7e92af79",
      "range": {
        "startLine": 378,
        "startChar": 1,
        "endLine": 379,
        "endChar": 43
      },
      "revId": "292d9a79080f5ba586ded5e88d45adf0bbcf31df",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b2a331e0_ea3350c3",
        "filename": "firmware/2lib/2load_android_kernel.c",
        "patchSetId": 16
      },
      "lineNbr": 380,
      "author": {
        "id": 1512562
      },
      "writtenOn": "2025-09-11T09:51:31Z",
      "side": 1,
      "message": "Kernel verification does not imply dev mode. There is `vb2_check_dev_switch()` to check for the real dev mode including the GBB Dev mode flag.",
      "range": {
        "startLine": 380,
        "startChar": 33,
        "endLine": 380,
        "endChar": 50
      },
      "revId": "292d9a79080f5ba586ded5e88d45adf0bbcf31df",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "2b48bcbf_51799573",
        "filename": "firmware/2lib/2load_android_kernel.c",
        "patchSetId": 16
      },
      "lineNbr": 380,
      "author": {
        "id": 1562687
      },
      "writtenOn": "2025-09-11T10:11:56Z",
      "side": 1,
      "message": "I think that the best solution is to used `vb2_check_dev_swith()` to verify that transition happened and pass that info up in `vb2_shared_data-\u003eflags`. @yupingso@chromium.org @jwerner@chromium.org do we have other mechanisms to detect dev\u003c-\u003enormal transition?",
      "parentUuid": "b2a331e0_ea3350c3",
      "range": {
        "startLine": 380,
        "startChar": 33,
        "endLine": 380,
        "endChar": 50
      },
      "revId": "292d9a79080f5ba586ded5e88d45adf0bbcf31df",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b93067c9_f98e2e39",
        "filename": "firmware/2lib/2load_android_kernel.c",
        "patchSetId": 16
      },
      "lineNbr": 380,
      "author": {
        "id": 1430007
      },
      "writtenOn": "2025-09-11T14:22:14Z",
      "side": 1,
      "message": "I already tried to use the vb2_check_dev_switch to check this, @jwerner@chromium.org informed me that modifying/using that function is *almost* impossible since it is in RO firmware. Since the last flag it modifies is VB2_SECDATA_FIRMWARE_FLAG_LAST_BOOT_DEVELOPER (which incorporates all the above concerns), I think that would be better to determine \"Are we in dev mode on the current boot?\"",
      "parentUuid": "2b48bcbf_51799573",
      "range": {
        "startLine": 380,
        "startChar": 33,
        "endLine": 380,
        "endChar": 50
      },
      "revId": "292d9a79080f5ba586ded5e88d45adf0bbcf31df",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "53a05caa_77ebaaf6",
        "filename": "firmware/2lib/2load_android_kernel.c",
        "patchSetId": 16
      },
      "lineNbr": 380,
      "author": {
        "id": 1353551
      },
      "writtenOn": "2025-09-12T09:34:43Z",
      "side": 1,
      "message": "Sorry, but I think there\u0027s a major design problem here (with either `VB2_SECDATA_FIRMWARE_FLAG_LAST_BOOT_DEVELOPER` or `vb2_check_dev_switch`). As the powerwash for dev/norm transition is a security feature, the implementation must take edge cases into account. For example, after enabling dev mode, the user may reboot the device at any time before the powerwash. I think the only way to do this correctly is to clear the `FLAG` (flag indicating powerwash needed) only after the powerwash, no matter where the `FLAG` is stored. That implies that the `FLAG` must be cleared outside firmware.\n\nThat\u0027s also how powerwash is done in ChromeOS, where the `FLAG` is a file `/mnt/stateful_partition/.developer_mode`, maintained by `clobber-state` and checked by [`startup`](https://source.corp.google.com/h/chrome-internal/chromeos/superproject/+/main:src/platform2/init/startup/chromeos_startup.cc;l\u003d518;drc\u003d3358d3d5811c7ceb6f847d177a9eee048d493fe6) for powerwash decision.\n\n@thomascedeno@google.com Has anyone looked into how we can implement a similar mechanism in Android? One possible solution is to have a custom script for AL (with logic similar to `startup`), instead of directly calling `recovery --wipe_data` from `vb2ex_factory_data_reset()`. If that doesn\u0027t work for any reason, I guess we can also check if TPM is owned here in firmware as part of the powerwash condition (in this case \"TPM owned\" is used as the `FLAG`).\n\nIn addition, we also need to consider the use cases of developers and labs (FAFT). If FDR is pretty fast (BTW is the 5-min transition still a requirement for AL?), then that probably isn\u0027t an issue. Otherwise, we\u0027ll need to think about how to skip FDR for those cases (for example by adding a GBB flag to skip FDR, or by having a \"debugging AL image\" similar to ChromeOS test image).",
      "parentUuid": "b93067c9_f98e2e39",
      "range": {
        "startLine": 380,
        "startChar": 33,
        "endLine": 380,
        "endChar": 50
      },
      "revId": "292d9a79080f5ba586ded5e88d45adf0bbcf31df",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "963832a6_cacd37cd",
        "filename": "firmware/2lib/2load_android_kernel.c",
        "patchSetId": 16
      },
      "lineNbr": 380,
      "author": {
        "id": 1430007
      },
      "writtenOn": "2025-09-12T14:59:39Z",
      "side": 1,
      "message": "I have spent some time thinking about this exact scenario you describe, and I think this impl fits the behavior of the old /mnt/stateful_partition/.developer_mode.\n\nIf a user reboots during any arbitrary point in the bootup process one of two things retry the powerwash process\n1) If only the VB2_NV_PREVIOUS_BOOT_DEV_MODE has been written, but the system failed to write to the gpt misc partition in vb2ex_factory_data_reset, it will try again over repeated boots\n2) Once the system has successfully written to the gpt misc partition it will continually try to perform FDR and only AFTER it has successfully done so will it clear the commands in the BCB - see the comments in https://source.corp.google.com/h/googleplex-android/platform/superproject/main/+/main:bootable/recovery/recovery.cpp;l\u003d91?q\u003drecovery%20wipe_data\u0026ss\u003dh%2Fgoogleplex-android%2Fplatform%2Fsuperproject%2Fmain%2F%2B%2Frefs%2Fheads%2Fmain.\n\nPerforming FDR on my machine is very fast (i.e. less than 30 seconds) and for lab scenarios if you are running an eng build it doesn\u0027t reset ADB connections so I think he have are bases covered on that front.",
      "parentUuid": "53a05caa_77ebaaf6",
      "range": {
        "startLine": 380,
        "startChar": 33,
        "endLine": 380,
        "endChar": 50
      },
      "revId": "292d9a79080f5ba586ded5e88d45adf0bbcf31df",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ab44ae55_d9893ca5",
        "filename": "firmware/2lib/2load_android_kernel.c",
        "patchSetId": 16
      },
      "lineNbr": 380,
      "author": {
        "id": 1562687
      },
      "writtenOn": "2025-09-15T07:21:18Z",
      "side": 1,
      "message": "I am not quite sure why we cannot change code in RO FW. I think that cannot update RO FW only for the boards which are after the FSI phase and have its own firmware branch.\n\nSo, if using vb2_check_dev_switch() simplifies the code, then such a change should be implemented on `main`. Any alternative implementation that avoids modifying the RO firmware should be done on board specific firmware-xxx branches.",
      "parentUuid": "963832a6_cacd37cd",
      "range": {
        "startLine": 380,
        "startChar": 33,
        "endLine": 380,
        "endChar": 50
      },
      "revId": "292d9a79080f5ba586ded5e88d45adf0bbcf31df",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "8eb43de8_10b19320",
        "filename": "firmware/2lib/2nvstorage.c",
        "patchSetId": 16
      },
      "lineNbr": 357,
      "author": {
        "id": 1512562
      },
      "writtenOn": "2025-09-11T09:51:31Z",
      "side": 1,
      "message": "extra space",
      "range": {
        "startLine": 357,
        "startChar": 24,
        "endLine": 357,
        "endChar": 25
      },
      "revId": "292d9a79080f5ba586ded5e88d45adf0bbcf31df",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "2e8cfd33_0c20a470",
        "filename": "firmware/2lib/2nvstorage.c",
        "patchSetId": 16
      },
      "lineNbr": 357,
      "author": {
        "id": 1430007
      },
      "writtenOn": "2025-09-11T14:22:14Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "8eb43de8_10b19320",
      "range": {
        "startLine": 357,
        "startChar": 24,
        "endLine": 357,
        "endChar": 25
      },
      "revId": "292d9a79080f5ba586ded5e88d45adf0bbcf31df",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "1365ef80_87488c96",
        "filename": "firmware/2lib/2stub.c",
        "patchSetId": 16
      },
      "lineNbr": 60,
      "author": {
        "id": 1512562
      },
      "writtenOn": "2025-09-11T09:51:31Z",
      "side": 1,
      "message": "style: indentation (there is a `.clang-format` you can use :) )",
      "range": {
        "startLine": 59,
        "startChar": 0,
        "endLine": 60,
        "endChar": 21
      },
      "revId": "292d9a79080f5ba586ded5e88d45adf0bbcf31df",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "7b05b9de_e16e0700",
        "filename": "firmware/2lib/2stub.c",
        "patchSetId": 16
      },
      "lineNbr": 60,
      "author": {
        "id": 1430007
      },
      "writtenOn": "2025-09-11T14:22:14Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "1365ef80_87488c96",
      "range": {
        "startLine": 59,
        "startChar": 0,
        "endLine": 60,
        "endChar": 21
      },
      "revId": "292d9a79080f5ba586ded5e88d45adf0bbcf31df",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "70a34f91_69842e96",
        "filename": "firmware/2lib/include/2api.h",
        "patchSetId": 16
      },
      "lineNbr": 1126,
      "author": {
        "id": 1512562
      },
      "writtenOn": "2025-09-11T09:51:31Z",
      "side": 1,
      "message": "style",
      "range": {
        "startLine": 1125,
        "startChar": 0,
        "endLine": 1126,
        "endChar": 22
      },
      "revId": "292d9a79080f5ba586ded5e88d45adf0bbcf31df",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "c14877f2_22e287ce",
        "filename": "firmware/2lib/include/2api.h",
        "patchSetId": 16
      },
      "lineNbr": 1126,
      "author": {
        "id": 1430007
      },
      "writtenOn": "2025-09-11T14:22:14Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "70a34f91_69842e96",
      "range": {
        "startLine": 1125,
        "startChar": 0,
        "endLine": 1126,
        "endChar": 22
      },
      "revId": "292d9a79080f5ba586ded5e88d45adf0bbcf31df",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b241bfe1_0a2d42fe",
        "filename": "firmware/2lib/include/2nvstorage.h",
        "patchSetId": 16
      },
      "lineNbr": 132,
      "author": {
        "id": 1512562
      },
      "writtenOn": "2025-09-11T09:51:31Z",
      "side": 1,
      "message": "style",
      "range": {
        "startLine": 130,
        "startChar": 1,
        "endLine": 132,
        "endChar": 3
      },
      "revId": "292d9a79080f5ba586ded5e88d45adf0bbcf31df",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "8664f749_5dfd9550",
        "filename": "firmware/2lib/include/2nvstorage.h",
        "patchSetId": 16
      },
      "lineNbr": 132,
      "author": {
        "id": 1430007
      },
      "writtenOn": "2025-09-11T14:22:14Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "b241bfe1_0a2d42fe",
      "range": {
        "startLine": 130,
        "startChar": 1,
        "endLine": 132,
        "endChar": 3
      },
      "revId": "292d9a79080f5ba586ded5e88d45adf0bbcf31df",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d24d4cc6_6acfe026",
        "filename": "firmware/2lib/include/2nvstorage_fields.h",
        "patchSetId": 16
      },
      "lineNbr": 91,
      "author": {
        "id": 1512562
      },
      "writtenOn": "2025-09-11T09:51:31Z",
      "side": 1,
      "message": "No longer correct.",
      "range": {
        "startLine": 91,
        "startChar": 0,
        "endLine": 91,
        "endChar": 47
      },
      "revId": "292d9a79080f5ba586ded5e88d45adf0bbcf31df",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "3c52552b_869c1188",
        "filename": "firmware/2lib/include/2nvstorage_fields.h",
        "patchSetId": 16
      },
      "lineNbr": 91,
      "author": {
        "id": 1430007
      },
      "writtenOn": "2025-09-11T14:22:14Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "d24d4cc6_6acfe026",
      "range": {
        "startLine": 91,
        "startChar": 0,
        "endLine": 91,
        "endChar": 47
      },
      "revId": "292d9a79080f5ba586ded5e88d45adf0bbcf31df",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    }
  ]
}