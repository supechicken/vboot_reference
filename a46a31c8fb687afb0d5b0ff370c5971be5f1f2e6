{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "f6cfb590_437570f1",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1487622
      },
      "writtenOn": "2023-02-24T07:49:58Z",
      "side": 1,
      "message": "This is failing in the case of a factory shim with both KERN-A and KERN-B (built using Chih-Yao\u0027s changes). KERN-A works, but KERN-B fails to boot with a dm-verity failure.\n\nIt\u0027s because update_rootfs_hash() only calculates the hash for ROOT-A. I guess we need to change it so that for factory shims it calculates hashes for both ROOT-A and ROOT-B, and fills them into the corresponding kernels?\n\nThere are also several other places in the script which assume we only have ROOT-A - resign_firmware_payload(), remove_old_container_key(), resign_android_image_if_exists(), sign_uefi_binaries(). So I guess we have to update them too.",
      "revId": "a46a31c8fb687afb0d5b0ff370c5971be5f1f2e6",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "009c5956_3d4a0f75",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2023-02-25T01:40:53Z",
      "side": 1,
      "message": "Ugh... I know we\u0027ve been discussing this back and forth for a bit too long now, but this seems like another good reason to not use a full ROOT-B on the factory shim for me. I feel like we have to add special cases all over the place just to support that shim doing something that\u0027s inefficient to begin with.\n\nCan\u0027t we just give in and disable kernel-level verity for factory shims so we don\u0027t need to deal with all this crap? Just removing the `root\u003d/dev/dm-0` should be good enough, right? Then the kernel won\u0027t do anything, and we can just fall back to doing userland setup_dm_root everywhere, and we don\u0027t need to worry about all these complicated differences between recovery sticks and factory shims on this kernel version vs that kernel version, etc.\n\nThat\u0027s just one little patch to change the build process somewhere, I feel like that would be less complex than trying to respect all these extra special cases in the signing script? If we just have base_image_util.sh or cros_make_image_bootable pass --boot_args\u003d\u0027root\u003d\u0027 through to build_kernel_image.sh when building a factory image, wouldn\u0027t that be enough to do the trick? The boot_args passed as a flag get added after the default root\u003d/dev/dm-0 argument, and when it appears multiple times in the command line the latter should override the earlier. (And then we can go with the 1 sector KERN-B solution where wait_for_gpt_root automatically decides to pick the other partition if the one associated with the current kernel is that small.)",
      "parentUuid": "f6cfb590_437570f1",
      "revId": "a46a31c8fb687afb0d5b0ff370c5971be5f1f2e6",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a8b276a2_52c5ff55",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1487622
      },
      "writtenOn": "2023-02-26T23:59:32Z",
      "side": 1,
      "message": "Was there a reason we decided against changing PARTNROFF\u003d1 to PARTNROFF\u003d-1? If we\u0027re modifying the command line in the build script anyway, it seems like we might as well change it to the correct value instead of making it fail.\n\nWe could add a root_offset argument to build_kernel_image.sh, and have it use that in get_base_root(). It seems reasonable to make this an argument anyway. We already pass a lot of other verity parameters as arguments.\n\nFor the initramfs case, wait_for_gpt_root() could get the offset from the command line, so we wouldn\u0027t need the check if size is \u003e 1 sector logic, and there\u0027s still only a single place where we\u0027re encoding which rootfs to use (the build script which overrides the offset).",
      "parentUuid": "009c5956_3d4a0f75",
      "revId": "a46a31c8fb687afb0d5b0ff370c5971be5f1f2e6",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a66bea0d_0dcee2b3",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2023-02-28T02:20:18Z",
      "side": 1,
      "message": "\u003e Was there a reason we decided against changing PARTNROFF\u003d1 to PARTNROFF\u003d-1? If we\u0027re modifying the command line in the build script anyway, it seems like we might as well change it to the correct value instead of making it fail.\n\nWell... I agree both are possible options. I think my suggestion would have the advantage that it gets rid of kernel-based verity initialization completely (I think if we can just make verity on recovery shims and all factory shims regardless of kernel version work the same way, that would just make all of this a bit easier to maintain by reducing the number of different cases we need to keep in mind), and that it can be implemented with a little less impact on the existing build scripts (basically just one line, rather than piping a whole separate option through to build_kernel_image.sh). But on the other hand, I agree that my suggestion may be seen as a bit of a hack.\n\nI don\u0027t really have a strong opinion towards one or the other, though. Both are much better than trying to put in a whole second rootfs and all the extra changes we\u0027d need for that.",
      "parentUuid": "a8b276a2_52c5ff55",
      "revId": "a46a31c8fb687afb0d5b0ff370c5971be5f1f2e6",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "3a8ac120_4d708148",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1000768
      },
      "writtenOn": "2023-02-28T04:37:58Z",
      "side": 1,
      "message": "yeah, we really need to avoid duplicating the rootfs",
      "parentUuid": "a66bea0d_0dcee2b3",
      "revId": "a46a31c8fb687afb0d5b0ff370c5971be5f1f2e6",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "f173aa26_055eb2cc",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1487622
      },
      "writtenOn": "2023-03-03T02:27:21Z",
      "side": 1,
      "message": "I tested with Chih-Yao\u0027s latest changes. There\u0027s another issue. update_rootfs_hash() gets the dm args from KERN-A, so the KERN-B args end up changed back to PARTNROFF\u003d1.\n\nThe best solution I can think of is to change the substitution in the for loop to preserve the PARTNROFF. E.g. save the current payload and hashtree, replace dm args, then change the payload and hashtree back to their original values. Unless anyone has a better idea?",
      "parentUuid": "3a8ac120_4d708148",
      "revId": "a46a31c8fb687afb0d5b0ff370c5971be5f1f2e6",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e2331b0f_3001338f",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2023-03-03T02:44:55Z",
      "side": 1,
      "message": "Argh... yeah, I guess that\u0027s the best way to solve that. Although it starts feeling like that script is just one big mountain of special cases pretending to be generic functions.\n\nAre we sure we don\u0027t want to just remove the verity stuff from the KERN-B command line completely for factory shims and then use setup_dm_root (with the verity arguments from KERN-A) instead?",
      "parentUuid": "f173aa26_055eb2cc",
      "revId": "a46a31c8fb687afb0d5b0ff370c5971be5f1f2e6",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b7ecbf91_e4085930",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1136349
      },
      "writtenOn": "2023-03-03T03:56:31Z",
      "side": 1,
      "message": "Wouldn\u0027t that still have the same problem: the signer will still copy the verity stuff from KERN-A to KERN-B. So you still need special logic to deal with KERN-B. And in this case, it sounds easier to make update_rootfs_hash to read each kernel partition and sign them individually.",
      "parentUuid": "e2331b0f_3001338f",
      "revId": "a46a31c8fb687afb0d5b0ff370c5971be5f1f2e6",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "cd5c7976_576a9205",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1487622
      },
      "writtenOn": "2023-03-03T04:17:16Z",
      "side": 1,
      "message": "The for loop only substitutes dm args if they exist, so if KERN-B doesn\u0027t have dm args, nothing will change. That\u0027s what happens for KERN-A in recovery images.",
      "parentUuid": "b7ecbf91_e4085930",
      "revId": "a46a31c8fb687afb0d5b0ff370c5971be5f1f2e6",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c2f33e83_b153f637",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1487622
      },
      "writtenOn": "2023-03-03T04:47:47Z",
      "side": 1,
      "message": "Actually, with Julius\u0027 suggestion, KERN-B would have dm args and they would have the wrong PARTNROFF, but the kernel would ignore them due to \"root\u003d\". Then the initramfs would figure out the USB_DEV based on the rootfs size.",
      "parentUuid": "cd5c7976_576a9205",
      "revId": "a46a31c8fb687afb0d5b0ff370c5971be5f1f2e6",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "bc611362_98e13c0e",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1487622
      },
      "writtenOn": "2023-03-03T06:48:05Z",
      "side": 1,
      "message": "I\u0027ve uploaded a patchset preserving payload and hashtree, so let me know what you think.\n\nI don\u0027t really have a strong opinion on which approach we should go with. I just feel like adding \"root\u003d\" is a hack which might break things in places we haven\u0027t thought of. But I agree the alternative isn\u0027t great either.",
      "parentUuid": "c2f33e83_b153f637",
      "revId": "a46a31c8fb687afb0d5b0ff370c5971be5f1f2e6",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "2b7dc689_fc26e9c2",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2023-03-03T07:10:26Z",
      "side": 1,
      "message": "\u003e I just feel like adding \"root\u003d\" is a hack which might break things in places we haven\u0027t thought of.\n\nI just realized that build_kernel_image.sh also has --noenable_rootfs_verification, so I think just using that would be cleaner and make more sense than the --boot_args\u003d\" root\u003d\" I suggested earlier. (If we do this, I would recommend doing it for _both_ factory shim kernels, KERN-A and KERN-B, so that they both use the setup_dm_root path and we don\u0027t have the complexity of two kernels using two different paths.)\n\n\u003e I\u0027ve uploaded a patchset preserving payload and hashtree, so let me know what you think.\n\nI still feel like my suggestion is simpler and has more advantages (e.g. all initramfs environments using the same verity setup path). But I also recognize that we really need to get something merged here soon. So if both of you prefer this approach feel free to land that. (Adding +2 under that consideration.)",
      "parentUuid": "bc611362_98e13c0e",
      "revId": "a46a31c8fb687afb0d5b0ff370c5971be5f1f2e6",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "5ca8b664_f7e645d5",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1487622
      },
      "writtenOn": "2023-03-03T07:31:35Z",
      "side": 1,
      "message": "Ok, I agree that that\u0027s better. It was just the \"root\u003d\" part bothering me, I agree with the advantages.\n\nI\u0027ll wait for Stimim\u0027s thoughts.",
      "parentUuid": "2b7dc689_fc26e9c2",
      "revId": "a46a31c8fb687afb0d5b0ff370c5971be5f1f2e6",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "6557d6a7_38878331",
        "filename": "scripts/image_signing/sign_official_build.sh",
        "patchSetId": 3
      },
      "lineNbr": 231,
      "author": {
        "id": 1136349
      },
      "writtenOn": "2023-03-03T03:48:26Z",
      "side": 1,
      "message": "If we pass different kernel to this function, `update_rootfs_hash` should get the correct kernel config, right?",
      "revId": "a46a31c8fb687afb0d5b0ff370c5971be5f1f2e6",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9e33b383_0ebb94d3",
        "filename": "scripts/image_signing/sign_official_build.sh",
        "patchSetId": 3
      },
      "lineNbr": 231,
      "author": {
        "id": 1487622
      },
      "writtenOn": "2023-03-03T04:06:05Z",
      "side": 1,
      "message": "The problem is we only do this part (extract the dm args and run verity) once for all kernels. So we assume all kernels use the same dm args (which has always been true until now).\n\nI wondered if we could change that by moving all this inside the loop so that we run verity for each kernel with it\u0027s own args. But that doesn\u0027t make sense because we\u0027re only calculating one set of hash data which is shared by all kernels, so the dm args can\u0027t vary arbitrarily anyway.",
      "parentUuid": "6557d6a7_38878331",
      "revId": "a46a31c8fb687afb0d5b0ff370c5971be5f1f2e6",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "68889d69_582f7293",
        "filename": "scripts/image_signing/sign_official_build.sh",
        "patchSetId": 3
      },
      "lineNbr": 1284,
      "author": {
        "id": 1136349
      },
      "writtenOn": "2023-02-24T10:00:58Z",
      "side": 1,
      "message": "Can you create a CL to remove these?  We are not using minios partitions from factory shims.",
      "range": {
        "startLine": 1283,
        "startChar": 0,
        "endLine": 1284,
        "endChar": 47
      },
      "revId": "a46a31c8fb687afb0d5b0ff370c5971be5f1f2e6",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    }
  ]
}