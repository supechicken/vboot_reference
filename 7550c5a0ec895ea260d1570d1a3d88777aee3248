{
  "comments": [
    {
      "key": {
        "uuid": "cd7b8258_62be73b1",
        "filename": "firmware/2lib/2ui_screens.c",
        "patchSetId": 5
      },
      "lineNbr": 20,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2020-05-18T12:38:58Z",
      "side": 1,
      "message": "I wonder if we should call this \"language selection\" or \"select language\"?  Otherwise, to someone who just saw the text in the console, it might not be entirely clear what the menu item is for.  In either case, probably LANGUAGE_SELECT_ITEM works since that\u0027s the screen name.",
      "range": {
        "startLine": 20,
        "startChar": 8,
        "endLine": 20,
        "endChar": 21
      },
      "revId": "7550c5a0ec895ea260d1570d1a3d88777aee3248",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ed642884_b2afd822",
        "filename": "firmware/2lib/2ui_screens.c",
        "patchSetId": 5
      },
      "lineNbr": 20,
      "author": {
        "id": 1353551
      },
      "writtenOn": "2020-05-20T04:27:24Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "cd7b8258_62be73b1",
      "range": {
        "startLine": 20,
        "startChar": 8,
        "endLine": 20,
        "endChar": 21
      },
      "revId": "7550c5a0ec895ea260d1570d1a3d88777aee3248",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "a66d0bdb_30b323eb",
        "filename": "firmware/2lib/2ui_screens.c",
        "patchSetId": 5
      },
      "lineNbr": 41,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2020-05-18T12:38:58Z",
      "side": 1,
      "message": "I think we want to update nvdata with the new locale and call vb2ex_commit_data() here.",
      "range": {
        "startLine": 41,
        "startChar": 19,
        "endLine": 41,
        "endChar": 41
      },
      "revId": "7550c5a0ec895ea260d1570d1a3d88777aee3248",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "7fe92bde_41e81e4c",
        "filename": "firmware/2lib/2ui_screens.c",
        "patchSetId": 5
      },
      "lineNbr": 41,
      "author": {
        "id": 1353551
      },
      "writtenOn": "2020-05-20T04:27:24Z",
      "side": 1,
      "message": "Done. How could I forget this?",
      "parentUuid": "a66d0bdb_30b323eb",
      "range": {
        "startLine": 41,
        "startChar": 19,
        "endLine": 41,
        "endChar": 41
      },
      "revId": "7550c5a0ec895ea260d1570d1a3d88777aee3248",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "11ebb909_0ae59895",
        "filename": "firmware/2lib/2ui_screens.c",
        "patchSetId": 5
      },
      "lineNbr": 50,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2020-05-18T12:38:58Z",
      "side": 1,
      "message": "I don\u0027t think it\u0027s really important for this to follow the \"action\" function argument signature if it isn\u0027t called by core UI functions, especially when it doesn\u0027t even use the ui argument.\n\nMaybe change it to void init_language_menu_items(void)?",
      "range": {
        "startLine": 50,
        "startChar": 0,
        "endLine": 50,
        "endChar": 70
      },
      "revId": "7550c5a0ec895ea260d1570d1a3d88777aee3248",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "5ed497cc_a32e4aae",
        "filename": "firmware/2lib/2ui_screens.c",
        "patchSetId": 5
      },
      "lineNbr": 50,
      "author": {
        "id": 1353551
      },
      "writtenOn": "2020-05-20T04:27:24Z",
      "side": 1,
      "message": "Sure. This is simply because I decided to split into 2 functions.",
      "parentUuid": "11ebb909_0ae59895",
      "range": {
        "startLine": 50,
        "startChar": 0,
        "endLine": 50,
        "endChar": 70
      },
      "revId": "7550c5a0ec895ea260d1570d1a3d88777aee3248",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "0b811d4b_70f661a7",
        "filename": "firmware/2lib/2ui_screens.c",
        "patchSetId": 5
      },
      "lineNbr": 79,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2020-05-18T12:38:58Z",
      "side": 1,
      "message": "Modifying the vb2_screen_info struct makes me uncomfortable, especially since we decided we wouldn\u0027t do that on the depthcharge side.  What do you think about introducing a vb2_screen_info.get_items function, which returns a list of vb2_menu_item?  We\u0027d have to pull the .num_items and .items out into a separate struct like in depthcharge too.",
      "range": {
        "startLine": 79,
        "startChar": 2,
        "endLine": 79,
        "endChar": 30
      },
      "revId": "7550c5a0ec895ea260d1570d1a3d88777aee3248",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "77d0e316_f64a3811",
        "filename": "firmware/2lib/2ui_screens.c",
        "patchSetId": 5
      },
      "lineNbr": 79,
      "author": {
        "id": 1353551
      },
      "writtenOn": "2020-05-20T10:06:56Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "0b811d4b_70f661a7",
      "range": {
        "startLine": 79,
        "startChar": 2,
        "endLine": 79,
        "endChar": 30
      },
      "revId": "7550c5a0ec895ea260d1570d1a3d88777aee3248",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "290061f4_bb3eb8fb",
        "filename": "firmware/2lib/2ui_screens.c",
        "patchSetId": 5
      },
      "lineNbr": 84,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2020-05-18T12:38:58Z",
      "side": 1,
      "message": "Not sure if it\u0027s worth the extra code here just for the case that a malloc() call failed.  Probably other stuff is going to fail anyways, so I\u0027d be fine just calling VB2_DIE().",
      "range": {
        "startLine": 81,
        "startChar": 0,
        "endLine": 84,
        "endChar": 48
      },
      "revId": "7550c5a0ec895ea260d1570d1a3d88777aee3248",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "26220299_758e2b0e",
        "filename": "firmware/2lib/2ui_screens.c",
        "patchSetId": 5
      },
      "lineNbr": 84,
      "author": {
        "id": 1353551
      },
      "writtenOn": "2020-05-20T04:27:24Z",
      "side": 1,
      "message": "How about returning VB2_ERROR_UI_MEMORY_ALLOC?",
      "parentUuid": "290061f4_bb3eb8fb",
      "range": {
        "startLine": 81,
        "startChar": 0,
        "endLine": 84,
        "endChar": 48
      },
      "revId": "7550c5a0ec895ea260d1570d1a3d88777aee3248",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "0e215f05_6e66b979",
        "filename": "firmware/2lib/2ui_screens.c",
        "patchSetId": 5
      },
      "lineNbr": 84,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2020-05-20T04:51:24Z",
      "side": 1,
      "message": "On second thought, we want to try and make UI code as bulletproof as possible, to increase chances that recovery will succeed.\n\nWhat if we just kick the user back to the previous screen instead?  I.e. init() calls vb2_ui_screen_back() [I know you still aren\u0027t a fan of this though.]",
      "parentUuid": "26220299_758e2b0e",
      "range": {
        "startLine": 81,
        "startChar": 0,
        "endLine": 84,
        "endChar": 48
      },
      "revId": "7550c5a0ec895ea260d1570d1a3d88777aee3248",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "a7959725_353cc792",
        "filename": "firmware/2lib/2ui_screens.c",
        "patchSetId": 5
      },
      "lineNbr": 84,
      "author": {
        "id": 1353551
      },
      "writtenOn": "2020-05-20T07:17:00Z",
      "side": 1,
      "message": "Instead of calling vb2_ui_screen_back() in init(), I\u0027d prefer doing something more general: restoring the state in vb2_ui_change_screen() whenever init() fails\n\n vb2_ui_change_screen()\n {\n     // backup state\n     memcpy(prev_state, state);\n     if (!ui-\u003estate.screen-\u003einit())\n         // reject screen change\n         memcpy(state, prev_state);\n     return UI_CONTINUE;\n }\n\nso that vb2_ui_change_screen() never fails. Once we have the stack, we don\u0027t need the \u0027prev_state\u0027 variable anymore. What do you think?",
      "parentUuid": "0e215f05_6e66b979",
      "range": {
        "startLine": 81,
        "startChar": 0,
        "endLine": 84,
        "endChar": 48
      },
      "revId": "7550c5a0ec895ea260d1570d1a3d88777aee3248",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "dc0587ed_12f51fb5",
        "filename": "firmware/2lib/2ui_screens.c",
        "patchSetId": 5
      },
      "lineNbr": 84,
      "author": {
        "id": 1353551
      },
      "writtenOn": "2020-05-27T04:37:44Z",
      "side": 1,
      "message": "Did you miss the above comment?",
      "parentUuid": "a7959725_353cc792",
      "range": {
        "startLine": 81,
        "startChar": 0,
        "endLine": 84,
        "endChar": 48
      },
      "revId": "7550c5a0ec895ea260d1570d1a3d88777aee3248",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "1d267b9c_88e6856c",
        "filename": "firmware/2lib/2ui_screens.c",
        "patchSetId": 5
      },
      "lineNbr": 84,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2020-05-27T08:19:36Z",
      "side": 1,
      "message": "I think just calling back() directly in .init is simplest -- otherwise we have to remember that .init and .action functions behave differently (\"when an .action function fail, it doesn\u0027t pop up to the previous screen\").  But if you prefer this method, then that\u0027s fine too.\n\nThe more important issue here is how to bubble error codes down to ui_loop(), and how to deal with them there.  Perhaps these principles could be sufficient:\n\n  * All executed .action and .init function calls originate in ui_loop(), but may recurse\n  * In the case of an error, code called by ui_loop() may either:\n    (1) Call vb2api_fail() if there is a suitable recovery code, and return with VB2_REQUEST_REBOOT\n    (2) Return some other error code, which should bubble down to the original call in ui_loop()\n  * If ui_loop() encounters a non-request error, it calls vb2api_fail() with a UI-specific recovery code\n    (1) If in recovery mode, ui_loop() continues executing even after an error is encountered\n    (2) If in developer mode, ui_loop() returns VB2_REQUEST_REBOOT, triggering a reboot into recovery mode\n\nWhat do you think?",
      "parentUuid": "dc0587ed_12f51fb5",
      "range": {
        "startLine": 81,
        "startChar": 0,
        "endLine": 84,
        "endChar": 48
      },
      "revId": "7550c5a0ec895ea260d1570d1a3d88777aee3248",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "c70fb985_60d7f5f9",
        "filename": "firmware/2lib/2ui_screens.c",
        "patchSetId": 5
      },
      "lineNbr": 84,
      "author": {
        "id": 1353551
      },
      "writtenOn": "2020-05-28T04:49:00Z",
      "side": 1,
      "message": "\u003e I think just calling back() directly in .init is simplest -- otherwise we have to remember that .init and .action functions behave differently (\"when an .action function fail, it doesn\u0027t pop up to the previous screen\").\n\nThat\u0027s a good point. Let\u0027s leave it as is for now until we have a better solution, although I don\u0027t like init() and action() to recursively call each other.\n\n\u003e  * In the case of an error, code called by ui_loop() may either:\n\nSounds good to me.\n\n\u003e  * If ui_loop() encounters a non-request error, it calls vb2api_fail() with a UI-specific recovery code\n\u003e    (2) If in developer mode, ui_loop() returns VB2_REQUEST_REBOOT, triggering a reboot into recovery mode\n\nFor (2), why not simply return the error code so that VB2_TRY() in VbSelectAndLoadKernel() will request recovery and reboot?\n\nSeeing lots of (rv !\u003d VB2_REQUEST_UI_CONTINUE) checks in the code, I wonder if there\u0027s a way to utilize the VB2_TRY macro. I can see 2 possible options.\n\n(a) Use VB2_SUCCESS to mean \"continuing in the loop\", and use VB2_REQUEST_UI_BREAK throughout the UI code to notify ui_loop() to return VB2_SUCCESS. This way, we may use the existing VB2_TRY.\n\n(b) Add a new macro VB2_UI_TRY(), which basically does the following:\n\n VB2_UI_TRY(rv) {\n     if (rv \u003d\u003d VB2_SUCCESS || rv \u003d\u003d VB2_REQUEST_UI_CONTINUE)\n         return rv;\n     if (recovery_mode) {\n         return VB2_REQUEST_UI_CONTINUE;\n     } else {\n         vb2api_fail();\n         return rv;\n     }\n }",
      "parentUuid": "1d267b9c_88e6856c",
      "range": {
        "startLine": 81,
        "startChar": 0,
        "endLine": 84,
        "endChar": 48
      },
      "revId": "7550c5a0ec895ea260d1570d1a3d88777aee3248",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "03698070_baaf2826",
        "filename": "firmware/2lib/2ui_screens.c",
        "patchSetId": 5
      },
      "lineNbr": 84,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2020-05-28T05:23:34Z",
      "side": 1,
      "message": "\u003e For (2), why not simply return the error code so that VB2_TRY() in VbSelectAndLoadKernel() will request recovery and reboot?\n\nAssuming we deal with the REQUEST_UI_CONTINUE problem you mention, then it seems like we can just call VB2_TRY and have everything magically work (?).  VB2_TRY can either be called with a recovery reason (for cases which aren\u0027t related to the UI -- for example in VbTryLoadKernel), or without a recovery reason (for cases which are related to the UI -- for example malloc failures).  We can just check for any error values at the end of UI as you suggested.  I\u0027m not sure if the best place for this is at the end of ui_loop() (so we only need to write it once), in vb2_developer_menu() and friends, or in VbSelectAndLoadKernel().\n\nNote that lots of the UI cases may not be as simple as just wrapping a function call in a VB2_TRY.  For example, in the case of our language selection malloc() failure, assuming that we keep .init return value behaviour as-is, then we\u0027d need to call menu_back() in the case of failure, and *then* return the error code.\n\n\n\u003e Seeing lots of (rv !\u003d VB2_REQUEST_UI_CONTINUE) checks in the code, I wonder if there\u0027s a way to utilize the VB2_TRY macro.\n\nThis is what\u0027s been keeping me up at night for the past few weeks.  \u003d)  The option (a) that you mention is exactly what I\u0027ve been thinking about.  The only case we\u0027d need to worry about is converting the return value of VbExLegacy from VB2_SUCCESS to VB2_REQUEST_UI_BREAK (I\u0027d suggest UI_EXIT as a more generic term).\n\nThe only problem with this strategy is that we couldn\u0027t directly use VB2_TRY around the action/init calls in ui_loop(), since we\u0027d want to filter out the UI_EXIT request and change it to VB2_SUCCESS.  But that seems like a small price to pay.\n\n\nIf we can nail down the details, then maybe it\u0027d be best to create a separate change either before/after this CL, so that we can deal with this malloc() failure problem right away?  What do you think?",
      "parentUuid": "c70fb985_60d7f5f9",
      "range": {
        "startLine": 81,
        "startChar": 0,
        "endLine": 84,
        "endChar": 48
      },
      "revId": "7550c5a0ec895ea260d1570d1a3d88777aee3248",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "923f073d_7d61e3bc",
        "filename": "firmware/2lib/2ui_screens.c",
        "patchSetId": 5
      },
      "lineNbr": 84,
      "author": {
        "id": 1353551
      },
      "writtenOn": "2020-05-28T07:59:40Z",
      "side": 1,
      "message": "\u003e Note that lots of the UI cases may not be as simple as just wrapping a function call in a VB2_TRY.  For example, in the case of our language selection malloc() failure, assuming that we keep .init return value behaviour as-is, then we\u0027d need to call menu_back() in the case of failure, and *then* return the error code.\n\nThat\u0027s part of the reason that I don\u0027t like the \"rollback\" action (menu_back()) in init().\n\n\u003e If we can nail down the details, then maybe it\u0027d be best to create a separate change either before/after this CL, so that we can deal with this malloc() failure problem right away?  What do you think?\n\nOkay, let\u0027s call menu_back() on language menu malloc failure in this CL, and deal with this problem in a follow-up CL.",
      "parentUuid": "03698070_baaf2826",
      "range": {
        "startLine": 81,
        "startChar": 0,
        "endLine": 84,
        "endChar": 48
      },
      "revId": "7550c5a0ec895ea260d1570d1a3d88777aee3248",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "f2724a20_5285ba18",
        "filename": "firmware/2lib/2ui_screens.c",
        "patchSetId": 5
      },
      "lineNbr": 84,
      "author": {
        "id": 1353551
      },
      "writtenOn": "2020-05-28T08:14:13Z",
      "side": 1,
      "message": "Filed b/157625765.",
      "parentUuid": "923f073d_7d61e3bc",
      "range": {
        "startLine": 81,
        "startChar": 0,
        "endLine": 84,
        "endChar": 48
      },
      "revId": "7550c5a0ec895ea260d1570d1a3d88777aee3248",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "dd8cc0e6_bc131e5c",
        "filename": "firmware/2lib/2ui_screens.c",
        "patchSetId": 5
      },
      "lineNbr": 84,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2020-05-29T07:08:23Z",
      "side": 1,
      "message": "Thanks!  Would you want to work on the CL to change REQUEST_UI_CONTINUE --\u003e VB2_SUCCESS?",
      "parentUuid": "f2724a20_5285ba18",
      "range": {
        "startLine": 81,
        "startChar": 0,
        "endLine": 84,
        "endChar": 48
      },
      "revId": "7550c5a0ec895ea260d1570d1a3d88777aee3248",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    }
  ]
}