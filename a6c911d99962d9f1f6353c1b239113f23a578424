{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "f6db75e7_17171e14",
        "filename": "scripts/image_signing/sign_official_build.sh",
        "patchSetId": 3
      },
      "lineNbr": 37,
      "author": {
        "id": 1000768
      },
      "writtenOn": "2021-06-16T04:09:02Z",
      "side": 1,
      "message": "i thought minios was backed into an existing image as a dedicated partition.  why would we sign the kernel as a standalone file ?",
      "revId": "a6c911d99962d9f1f6353c1b239113f23a578424",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "0bdfdecb_b089624c",
        "filename": "scripts/image_signing/sign_official_build.sh",
        "patchSetId": 3
      },
      "lineNbr": 37,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2021-06-16T13:55:36Z",
      "side": 1,
      "message": "Hey vapier, based on your email which tells me to update vboot_reference/scripts/keygeneration and vboot_reference/scripts/image_signing, I\u0027m working under the assumption that this script (sign_official_build.sh) is used as part of the signer logic to get miniOS signed and copied to its two dedicated partitions.  If that\u0027s not the case, please let me know what script needs to be updated.",
      "parentUuid": "f6db75e7_17171e14",
      "revId": "a6c911d99962d9f1f6353c1b239113f23a578424",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "375468bb_dcc86397",
        "filename": "scripts/image_signing/sign_official_build.sh",
        "patchSetId": 3
      },
      "lineNbr": 37,
      "author": {
        "id": 1000768
      },
      "writtenOn": "2021-06-16T14:21:11Z",
      "side": 1,
      "message": "that doesn\u0027t answer my question here.  i\u0027m not asking \"why this file\", i\u0027m asking \"why this way\".",
      "parentUuid": "0bdfdecb_b089624c",
      "revId": "a6c911d99962d9f1f6353c1b239113f23a578424",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "5991f23b_86502df4",
        "filename": "scripts/image_signing/sign_official_build.sh",
        "patchSetId": 3
      },
      "lineNbr": 37,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2021-06-17T02:13:51Z",
      "side": 1,
      "message": "Is there an overview of which types are actually used how somewhere, Mike? As far as I can tell from the signer code, it just takes this as a string from the instruction file and passes it straight through to this script. I don\u0027t really know how the instruction files get made.\n\nAre we actually using all of these types, or can we maybe deprecate some of them (or at least clearly mark them as unused)? The list is a bit confusing at the moment, e.g. I\u0027m not actually sure what the difference between `recovery` and `recovery_kernel` is, or why `usb` is available as a separate type and what exactly that does. My understanding was always that `recovery` signing basically does most of these things in one go, but documenting the details better would be very helpful.\n\n(@Joel: I think if I understand this right, we bascially want this functionality to go into sign_image_file() and then the modes we care about (notably `recovery`) should do it. Not exactly clear how `factory` works and what we need to do in the whole factory install flow to support this anyway. We don\u0027t need a minios on the actual factory image that contains all the factory tests and stuff, but we need to make sure it is there and correctly signed in the part that\u0027s copied to the disk as part of the factory install flow. I don\u0027t know exactly how that works, I\u0027d suggest asking Hung-Te.)",
      "parentUuid": "375468bb_dcc86397",
      "revId": "a6c911d99962d9f1f6353c1b239113f23a578424",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "967705cb_2eee547d",
        "filename": "scripts/image_signing/sign_official_build.sh",
        "patchSetId": 3
      },
      "lineNbr": 37,
      "author": {
        "id": 1000768
      },
      "writtenOn": "2021-06-18T02:22:20Z",
      "side": 1,
      "message": "i\u0027m sure some of these aren\u0027t useful anymore.  chromite/scripts/pushimage.py:_SUPPORTED_IMAGE_TYPES is prob the best list of what\u0027s still active.\n\nrecovery is a disk image with the kernel inside it.  recovery_kernel is just the kernel.\n\nthe signer itself treats inputs \u0026 outputs as opaque by design.  this way the platform/firmware side can maintain everything without having to worry about the infrastructure behavior, and the infra team doesn\u0027t have to understand what it means to \"sign a file\".",
      "parentUuid": "5991f23b_86502df4",
      "revId": "a6c911d99962d9f1f6353c1b239113f23a578424",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "53a6c3d2_e5eec2c7",
        "filename": "scripts/image_signing/sign_official_build.sh",
        "patchSetId": 3
      },
      "lineNbr": 37,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2021-06-18T22:29:13Z",
      "side": 1,
      "message": "Thanks for the list! (There\u0027s also chromite/lib/paygen/signer_payloads_client.py which calls this with `update_payload` directly, so gotta count that towards the in-use ones as well.)\n\nSo looking at this more closely, it seems that \"SSD\", \"USB\" and \"base\" are fully indistinguishable in what they actually do. @Joel, I\u0027d suggest we just remove \"SSD\" and \"USB\" then to avoid confusion. That leaves \"kernel\", \"recovery_kernel\" and \"minios_kernel\" (if we want to add it) -- we can decide whether we want to keep those and explicitly label them as \"for manual use only, not needed by infrastructure\" or just get rid of them as well. (I don\u0027t think we ever really have a practical need for someone to manually sign a kernel or something, so I\u0027m leaning towards getting rid of them. They\u0027re just super thin wrappers around vbutil_kernel anyway.)",
      "parentUuid": "967705cb_2eee547d",
      "revId": "a6c911d99962d9f1f6353c1b239113f23a578424",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "7d6a6a6f_be247399",
        "filename": "scripts/image_signing/sign_official_build.sh",
        "patchSetId": 3
      },
      "lineNbr": 37,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2021-06-22T19:23:49Z",
      "side": 1,
      "message": "\u003e it seems that \"SSD\", \"USB\" and \"base\" are fully indistinguishable in what they actually do.\n\nLooks like \"base\" isn\u0027t even a valid argument.  For SSD and USB -- seems like they are doing different things?  And are you saying that we should remove all of them, or merge them into one option / keep them?\n\n\u003e That leaves \"kernel\", \"recovery_kernel\" and \"minios_kernel\" [...] or just get rid of them as well\n\nSure, we can just get rid of these.\n\n\u003e @Joel: I think if I understand this right, we bascially want this functionality to go into sign_image_file() and then the modes we care about (notably `recovery`) should do it.\n\nNot sure I totally grok what\u0027s going on here.  Do we need to add some functionality within sign_image_file to do the minios signing?  And you\u0027re suggesting we do this under the \"recovery\" mode -- but aren\u0027t we dealing with a full Chrome OS image which has two new MINIOS-A and MINIOS-B partitions?  Isn\u0027t \"recovery\" mode for signing a USB recovery image?",
      "parentUuid": "53a6c3d2_e5eec2c7",
      "revId": "a6c911d99962d9f1f6353c1b239113f23a578424",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d22bb4fa_fbff9aa5",
        "filename": "scripts/image_signing/sign_official_build.sh",
        "patchSetId": 3
      },
      "lineNbr": 37,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2021-06-24T00:25:48Z",
      "side": 1,
      "message": "\u003e Looks like \"base\" isn\u0027t even a valid argument.\n\nIt\u0027s checked on the same line line as SSD (1080), maybe you missed it?\n\n\u003e For SSD and USB -- seems like they are doing different things?\n\nOh, right, the USB is using a different set of keys I guess... but still, I don\u0027t think we really have a need for that. The chromite scripts only know \"base\", so I\u0027d consider getting rid of the other two.\n\n\u003e Do we need to add some functionality within sign_image_file to do the minios signing?\n\nYes, you\u0027ll basically need to check if minios partitions are present, and if so sign them.\n\n\u003e And you\u0027re suggesting we do this under the \"recovery\" mode.\n\nI think we should do this in sign_image_file() which is used both for recovery and to sign a normal disk image. Although I\u0027m not sure if/when the latter actually ever happens in practice. I don\u0027t think Chrome OS disk images are ever really created in full outside of developer-only flows (Mike may correct me here if I\u0027m wrong). I think the Chrome OS disk image on a customer\u0027s device always gets there because it was created in place by a recovery or factory installer. So in order to get the minios images in there, we\u0027ll need to change the installer to take care of that. For the recovery flow I think the most simple option would be to just have the signed minios partition on the recovery USB stick so that the installer can simply copy it to the disk that is being installed upon (that is basically how the normal kernel and rootfs partitions work as well -- they already exist fully formed and signed in the recovery USB image and just get copied over). You should talk to Amin to confirm that matches their plans, though (I assume they\u0027ll be taking care of the installer patches). For the factory installer I\u0027m not that sure how it works, it would be better if you talked to Hung-Te about that... but I think it should be pretty similar to the recovery flow.\n\nThis is all just for getting the minios onto the disk in the first place when a device is newly installed from scratch. Updates are a different process that I don\u0027t know anything about. I assume that when we release a new version we first create and sign a recovery image, and then whatever makes the differential update payloads extracts the already signed kernel partitions from that (and then minios could work analogously). But that\u0027s just my guess, hopefully Mike or Amin can give more definitive answers.",
      "parentUuid": "7d6a6a6f_be247399",
      "revId": "a6c911d99962d9f1f6353c1b239113f23a578424",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "4bd98896_e07626fb",
        "filename": "scripts/image_signing/sign_official_build.sh",
        "patchSetId": 3
      },
      "lineNbr": 37,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2021-06-25T23:38:49Z",
      "side": 1,
      "message": "Check the new CLs in this stack for the work on sign_official_build.sh.  I think I\u0027d prefer to keep that separate from this CL, but if you prefer I can also squash them together.\n\nSounds like the takeaway here is (1) we still need to check that all the different installation paths will install two miniOS kernels to disk if necessary, and (2) we need to follow up on the miniOS update story.",
      "parentUuid": "d22bb4fa_fbff9aa5",
      "revId": "a6c911d99962d9f1f6353c1b239113f23a578424",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b38ea3c4_04bb42e7",
        "filename": "scripts/image_signing/sign_official_build.sh",
        "patchSetId": 3
      },
      "lineNbr": 467,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2021-06-17T02:13:51Z",
      "side": 1,
      "message": "We need a separate minios_kernel_data_key pair as well. Otherwise, you have two keyblocks with different flags signing the same data key and then you could just paste a USB recovery keyblock onto the minios image and since it uses the same key it would verify just fine (which is exactly what we want to prevent).",
      "range": {
        "startLine": 467,
        "startChar": 30,
        "endLine": 467,
        "endChar": 62
      },
      "revId": "a6c911d99962d9f1f6353c1b239113f23a578424",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "3dd92de4_9685d405",
        "filename": "scripts/image_signing/sign_official_build.sh",
        "patchSetId": 3
      },
      "lineNbr": 467,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2021-06-22T19:23:49Z",
      "side": 1,
      "message": "From https://crrev.com/c/2964479/comment/798711dd_e43f355a/ (jwerner):\n\n\u003e I assume you meant minios_kernel_data_key.vbpubk / minios_kernel_data_key.vbprivk, and the answer is yes. Then you\u0027ll create a minios_kernel.keyblock that\u0027s signed by recovery_key.vbprivk and wraps minios_kernel_data_key.vbpubk with RECOVERY_1 | MINIOS_1 | DEV_0 | DEV_1 flags.\n\u003e Key strength should presumably be the same as recovery_kernel_data_key, so RSA4096.\n\nLooks like recovery_kernel_data_key is marked down in scripts/keygeneration/common.sh as RSA8192, but the actual dev key is RSA4096.  Which should the new minios_kernel_data_key match?",
      "parentUuid": "b38ea3c4_04bb42e7",
      "range": {
        "startLine": 467,
        "startChar": 30,
        "endLine": 467,
        "endChar": 62
      },
      "revId": "a6c911d99962d9f1f6353c1b239113f23a578424",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a614d5a7_f9a76203",
        "filename": "scripts/image_signing/sign_official_build.sh",
        "patchSetId": 3
      },
      "lineNbr": 467,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2021-06-24T00:25:48Z",
      "side": 1,
      "message": "Are you looking at an old version? Seems like we got rid of the last 8K keys a while ago in CL:1680641. So I guess that means the minios keys should also be 4K.",
      "parentUuid": "3dd92de4_9685d405",
      "range": {
        "startLine": 467,
        "startChar": 30,
        "endLine": 467,
        "endChar": 62
      },
      "revId": "a6c911d99962d9f1f6353c1b239113f23a578424",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "3df583c2_0aa12f5e",
        "filename": "scripts/image_signing/sign_official_build.sh",
        "patchSetId": 3
      },
      "lineNbr": 467,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2021-06-25T23:38:49Z",
      "side": 1,
      "message": "It\u0027s marked as such in keygeneration/common.sh, but the actual dev key is still 8K:\n\n  vboot_reference:remotes/cros/main $ futility show tests/devkeys/recovery_kernel_data_key.vbpubk\n  Public Key file:       tests/devkeys/recovery_kernel_data_key.vbpubk\n    Vboot API:           1.0\n    Algorithm:           11 RSA8192 SHA512\n    Key Version:         1\n    Key sha1sum:         e78ce746a037837155388a1096212ded04fb86eb\n\nCurrently keygeneration/common.sh has miniOS data key as 4K as you requested, but I\u0027m wondering if we should keep the dev key as 8K to match recovery_kernel_data_key.",
      "parentUuid": "a614d5a7_f9a76203",
      "range": {
        "startLine": 467,
        "startChar": 30,
        "endLine": 467,
        "endChar": 62
      },
      "revId": "a6c911d99962d9f1f6353c1b239113f23a578424",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "398250d8_6753f5bd",
        "filename": "scripts/image_signing/sign_official_build.sh",
        "patchSetId": 3
      },
      "lineNbr": 467,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2021-06-26T02:01:47Z",
      "side": 1,
      "message": "Okay, I think you just mixed things up in your earlier comment. You said\n\n\u003e Looks like recovery_kernel_data_key is marked down in scripts/keygeneration/common.sh as RSA8192, but the actual dev key is RSA4096.\n\nbut I guess you meant it the other way around. That\u0027s expected. The dev keys were created ages ago and we don\u0027t really want to update them (that would cause a lot of people pain), so they no longer match current defaults for newly created keys. I don\u0027t see a reason why the new minios dev key shouldn\u0027t match what we\u0027d want to use in production going forward.",
      "parentUuid": "3df583c2_0aa12f5e",
      "range": {
        "startLine": 467,
        "startChar": 30,
        "endLine": 467,
        "endChar": 62
      },
      "revId": "a6c911d99962d9f1f6353c1b239113f23a578424",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "6bf6feab_3d82ad41",
        "filename": "scripts/keygeneration/common.sh",
        "patchSetId": 3
      },
      "lineNbr": 70,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2021-06-17T02:13:51Z",
      "side": 1,
      "message": "Can we write these in hex somehow (does `RECOVERY_KERNEL_KEYBLOCK_MODE\u003d$((0x1b))` work?) so it\u0027s easier to follow?",
      "range": {
        "startLine": 70,
        "startChar": 30,
        "endLine": 70,
        "endChar": 32
      },
      "revId": "a6c911d99962d9f1f6353c1b239113f23a578424",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "a735af55_2c2c2369",
        "filename": "scripts/keygeneration/common.sh",
        "patchSetId": 3
      },
      "lineNbr": 70,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2021-06-22T19:23:49Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "6bf6feab_3d82ad41",
      "range": {
        "startLine": 70,
        "startChar": 30,
        "endLine": 70,
        "endChar": 32
      },
      "revId": "a6c911d99962d9f1f6353c1b239113f23a578424",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    }
  ]
}