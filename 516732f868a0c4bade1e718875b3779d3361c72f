{
  "comments": [
    {
      "key": {
        "uuid": "cff1e955_bbd02c57",
        "filename": "firmware/lib/vboot_api_kernel.c",
        "patchSetId": 1
      },
      "lineNbr": 433,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2019-04-12T04:40:29Z",
      "side": 0,
      "message": "nit: not quite sure why this line needs to move, I kinda like how it gets cleared immediately after the check (even though your patch just moves that a few functions further down the same call stack, this way it\u0027s immediately obvious that this can never stay stuck on in some weird edge case).",
      "revId": "516732f868a0c4bade1e718875b3779d3361c72f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "98c7c954_d0be6ed1",
        "filename": "firmware/lib/vboot_api_kernel.c",
        "patchSetId": 1
      },
      "lineNbr": 433,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2019-04-12T05:31:12Z",
      "side": 0,
      "message": "I agree that it\u0027s a nice property to see that it is checked and cleared right away.  But I don\u0027t think that logic belongs in the main boot path branching point.\n\nIf you prefer not to group everything in the UI function (which admittedly isn\u0027t ideal), then perhaps we should try something like what Campfire did -- add an extra function call right after EC sync, with logic something like:\n\n  if DIAG_REQUEST:\n    unset DIAG_REQUEST\n    set VB2_CONTEXT_DIAGNOSTIC_MODE",
      "parentUuid": "cff1e955_bbd02c57",
      "revId": "516732f868a0c4bade1e718875b3779d3361c72f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "cfd60f67_c99f50ba",
        "filename": "firmware/lib/vboot_api_kernel.c",
        "patchSetId": 1
      },
      "lineNbr": 433,
      "author": {
        "id": 1284883
      },
      "writtenOn": "2019-04-12T06:19:08Z",
      "side": 0,
      "message": "I\u0027m not clear if \"everything in the UI function\" is this current draft or something like:\n\n} else if (DIAGNOSTIC_UI \u0026\u0026 !(retval \u003d VbBootDiagnostic(ctx))) {\n  /* empty */\n} else if (ctx-\u003eflags \u0026 VB2_CONTEXT_DEVELOPER_MODE) {\n\nAnd have VbBootDiagnostic() check vb2_nv_get(ctx, VB2_NV_DIAG_REQUEST). This would be a way to keep the bit read/update in the same function (now in the callee rather than the caller). I\u0027m not sure this would be a net win, and seems more prone to accidental error introduced in a later code change (the compilers in some repos are also configured to be aggressive about prohibiting assignment within conditionals [even when parens are used]).",
      "parentUuid": "98c7c954_d0be6ed1",
      "revId": "516732f868a0c4bade1e718875b3779d3361c72f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "9430c218_dcf7a5e5",
        "filename": "firmware/lib/vboot_api_kernel.c",
        "patchSetId": 1
      },
      "lineNbr": 433,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2019-04-12T06:47:35Z",
      "side": 0,
      "message": "I mean something more like this:\n\nhttps://chromium-review.googlesource.com/c/chromiumos/platform/vboot_reference/+/983312/29/firmware/lib/vboot_api_kernel.c\n\nTwo separate functions.",
      "parentUuid": "cfd60f67_c99f50ba",
      "revId": "516732f868a0c4bade1e718875b3779d3361c72f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "e35498d6_7b1eb04a",
        "filename": "firmware/lib/vboot_api_kernel.c",
        "patchSetId": 1
      },
      "lineNbr": 433,
      "author": {
        "id": 1284883
      },
      "writtenOn": "2019-04-12T08:11:44Z",
      "side": 0,
      "message": "I\u0027d done something akin to that, without a new function, in an earlier draft of the feature:\n\nhttps://chromium-review.googlesource.com/c/chromiumos/platform/vboot_reference/+/1470723/4/firmware/lib/vboot_api_kernel.c\n\nIt was revised to avoid using up another context flag, though that tradeoff has basically provoked the current proposed change.  I can appreciate the reduced flag use more than I can the desire to keep nvram calls out of VbSelectAndLoadKernel(), but I defer to the owner(s) on that.",
      "parentUuid": "9430c218_dcf7a5e5",
      "revId": "516732f868a0c4bade1e718875b3779d3361c72f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "e2944463_56338592",
        "filename": "firmware/lib/vboot_api_kernel.c",
        "patchSetId": 1
      },
      "lineNbr": 433,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2019-04-13T00:15:01Z",
      "side": 0,
      "message": "Yeah, sorry, still don\u0027t see the need for an extra context flag here and don\u0027t understand what\u0027s better about the new patch. There\u0027s no need to allocate a context flag just to communicate something between a function and its caller. If you want to get the logic into a separate function you could just do\n\n } else if (VbCheckDiagnostic(ctx) {\n   retval \u003d VbBootDiagnostic(ctx)\n   if (!retval)\n     retval \u003d VBERROR_REBOOT_REQUIRED;\n }\n\nAlthough I don\u0027t see what\u0027s so bad about checking or clearing NVRAM flags directly in here either.",
      "parentUuid": "e35498d6_7b1eb04a",
      "revId": "516732f868a0c4bade1e718875b3779d3361c72f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "2fdc3a89_d06c9aad",
        "filename": "firmware/lib/vboot_api_kernel.c",
        "patchSetId": 1
      },
      "lineNbr": 433,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2019-04-15T07:39:00Z",
      "side": 0,
      "message": "Two points here...\n(1) We are actually missing some logic in the existing code to check for:\n\n   sd-\u003evbsd-\u003eflags \u0026 VBSD_OPROM_MATTERS \u0026\u0026\n  !(sd-\u003evbsd-\u003eflags \u0026 VBSD_OPROM_LOADED)\n\nAdmittedly this case shouldn\u0027t happen, but if it does, the current code would go ahead and present the diagnostic screen.  If we want to add a check for this case, IMHO the code is getting non-trivial enough to warrant its own function.\n\n(2) Again, looking forward, this also depends on how we decide to make the depthcharge/vboot split in the future.  We may very well want this \"screen selection logic\" to live in depthcharge, in which case we would probably need a vb2_context flag.  [Yes, this is still up for discussion, and we may very well decide that this code should exist in vboot anyways.]\n\nWould it be acceptable if I change the code to use your suggestion of \"if (VbCheckDiagnostic)\"?  Or do you still think it\u0027s not worth breaking out into a separate function?",
      "parentUuid": "e2944463_56338592",
      "revId": "516732f868a0c4bade1e718875b3779d3361c72f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "d6fad235_3fb19e91",
        "filename": "firmware/lib/vboot_api_kernel.c",
        "patchSetId": 1
      },
      "lineNbr": 433,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2019-04-15T22:19:26Z",
      "side": 0,
      "message": "\u003e Would it be acceptable if I change the code to use your suggestion of \"if (VbCheckDiagnostic)\"?  Or do you still think it\u0027s not worth breaking out into a separate function?\n\nSure, I\u0027m fine with that.",
      "parentUuid": "2fdc3a89_d06c9aad",
      "revId": "516732f868a0c4bade1e718875b3779d3361c72f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    }
  ]
}