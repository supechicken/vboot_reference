{
  "comments": [
    {
      "key": {
        "uuid": "841d9517_b75c6355",
        "filename": "/COMMIT_MSG",
        "patchSetId": 4
      },
      "lineNbr": 13,
      "author": {
        "id": 1132414
      },
      "writtenOn": "2020-04-16T19:27:00Z",
      "side": 1,
      "message": "Isn\u0027t that also true of the existing sysfs API? The main \"unstable\" aspect is what the gpiochip base is. Device probe ordering, etc., mean that the gpiochip base may change across kernel versions or perhaps even upon reboot (if ordering is non-deterministic).\n\nI thought the main advantage of this new API is that it has better name-based definition, so proper usage no longer requires memorizing offsets, but just looking up by name. But maybe I\u0027m wrong.\n\nAnyway, that doesn\u0027t mean you can\u0027t switch to the new API, but it\u0027s not clear to me what it\u0027s buying us.",
      "range": {
        "startLine": 12,
        "startChar": 47,
        "endLine": 13,
        "endChar": 55
      },
      "revId": "574925759f4ea65e96d159a850488289ad663384",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "2fe8b829_c75b7237",
        "filename": "/COMMIT_MSG",
        "patchSetId": 4
      },
      "lineNbr": 13,
      "author": {
        "id": 1349498
      },
      "writtenOn": "2020-04-16T22:28:20Z",
      "side": 1,
      "message": "in isn\u0027t stable in the sense that Intel changed the mapping pin-\u003egpio number (somewhere around 4.4 I believe) which made sysfs usage break - hard coded numbers don\u0027t mean the same anymore.",
      "parentUuid": "841d9517_b75c6355",
      "range": {
        "startLine": 12,
        "startChar": 47,
        "endLine": 13,
        "endChar": 55
      },
      "revId": "574925759f4ea65e96d159a850488289ad663384",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "d4dec1bd_0fd706f2",
        "filename": "/COMMIT_MSG",
        "patchSetId": 4
      },
      "lineNbr": 13,
      "author": {
        "id": 1132414
      },
      "writtenOn": "2020-04-17T01:41:34Z",
      "side": 1,
      "message": "So I read through the upstream patch (rejected), and the rest of $BUG. I see the problem is just with the dis-continuity of pin offsets. So you\u0027re right, the pin:index mapping changed.\n\n...but this CL is just changing how we compute the chip base number, not the actual pin offset within each chip. We\u0027re still using the same offset (controller_num \u003d\u003d 0x13).\n\nI tested it out, and I believe this patch does not actually do anything useful. See the following:\n\n# cd /sys/kernel/debug/tracing\n# echo 1 \u003e events/gpio/enable\n# echo 1 \u003e tracing_on\n# cat trace_pipe \u0026\n# /usr/local/crossystem wpsw_cur\n           \u003c...\u003e-4082  [001] ....  2709.771555: gpio_direction: 333  in (0)\n           \u003c...\u003e-4082  [001] ....  2709.771596: gpio_value: 333 get 1\n1\n# crossystem wpsw_cur\n           \u003c...\u003e-4083  [001] ....  2714.883983: gpio_value: 333 get 1\n1\n\nI\u0027m on kefka kernelnext, I pulled in the kernel revert (meaning, this should be \"broken\" again):\nhttps://chromium-review.googlesource.com/c/chromiumos/third_party/kernel/+/2150577\n\n/usr/local/crossystem version includes this patch\n/usr/bin/crossystem is unmodified\n\nThey\u0027re reading the exact same underlying GPIO. (NB: and it\u0027s the wrong one. It should be GPIO 336 --- /sys/class/gpio/gpiochip314/ + offset 22 -- which correctly reads out \"0\" (WP is disabled on this system).)\n\nThe key problem here is nothing about which API (chardev or sysfs) to use -- the chardev API does nothing to fix how we\u0027re computing the value of the \u0027controller_num\u0027 variable. We need to address the discontinuity within the chip, not just compute the gpiochip base/number differently.\n\nI think the best we\u0027ll be able to do is to add hacks into BraswellFindGpioChipOffset(), so that it can undo the dis-continuity \"fixes\" that were made here:\nhttps://chromium-review.googlesource.com/c/chromiumos/third_party/coreboot/+/286534\n\ne.g., do some kind of:\n  if (offset \u003c\u003d 11)\n    return offset;\n  return offset + 3;\n\nNow, that would also have to be kernel-version-aware...",
      "parentUuid": "2fe8b829_c75b7237",
      "range": {
        "startLine": 12,
        "startChar": 47,
        "endLine": 13,
        "endChar": 55
      },
      "revId": "574925759f4ea65e96d159a850488289ad663384",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "a31b4b43_9991c4fc",
        "filename": "/COMMIT_MSG",
        "patchSetId": 4
      },
      "lineNbr": 22,
      "author": {
        "id": 1132414
      },
      "writtenOn": "2020-04-16T19:27:00Z",
      "side": 1,
      "message": "can you test some other platforms too? I have a strong suspicion you\u0027re breaking older kernels, at least",
      "range": {
        "startLine": 22,
        "startChar": 0,
        "endLine": 22,
        "endChar": 35
      },
      "revId": "574925759f4ea65e96d159a850488289ad663384",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "66750a7d_9f394f9a",
        "filename": "/COMMIT_MSG",
        "patchSetId": 4
      },
      "lineNbr": 22,
      "author": {
        "id": 1349498
      },
      "writtenOn": "2020-04-16T22:28:20Z",
      "side": 1,
      "message": "A great callout. ideally we want to test a device on each of our active kernels.",
      "parentUuid": "a31b4b43_9991c4fc",
      "range": {
        "startLine": 22,
        "startChar": 0,
        "endLine": 22,
        "endChar": 35
      },
      "revId": "574925759f4ea65e96d159a850488289ad663384",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "cc8416f2_b4eb7399",
        "filename": "host/arch/x86/lib/crossystem_arch.c",
        "patchSetId": 4
      },
      "lineNbr": 806,
      "author": {
        "id": 1117900
      },
      "writtenOn": "2020-04-16T23:36:35Z",
      "side": 1,
      "message": "Is 0 not a valid uid value?  At least when I cat /sys/class/gpio/gpiochip200/device/firmware_node/uid on one of my CML devices it shows 0.  Is this handled somewhere else for CML?",
      "range": {
        "startLine": 805,
        "startChar": 0,
        "endLine": 806,
        "endChar": 12
      },
      "revId": "574925759f4ea65e96d159a850488289ad663384",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "baa3255f_8f350dfd",
        "filename": "host/arch/x86/lib/crossystem_arch.c",
        "patchSetId": 4
      },
      "lineNbr": 814,
      "author": {
        "id": 1132414
      },
      "writtenOn": "2020-04-16T19:27:00Z",
      "side": 1,
      "message": "doesn\u0027t this fail on all older kernels?",
      "range": {
        "startLine": 808,
        "startChar": 0,
        "endLine": 814,
        "endChar": 12
      },
      "revId": "574925759f4ea65e96d159a850488289ad663384",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "03092f3f_03155a25",
        "filename": "host/arch/x86/lib/crossystem_arch.c",
        "patchSetId": 4
      },
      "lineNbr": 818,
      "author": {
        "id": 1132414
      },
      "writtenOn": "2020-04-16T19:27:00Z",
      "side": 1,
      "message": "this doesn\u0027t feel like the right approach. It feels like you should only be falling back to a different mechanism if you know that for some reason the new API should not work. (e.g., /dev/gpiochipX was missing, or the \u0027uid\u0027 computation above does not work.) ioctl() failures are probably not a good fallback case.",
      "range": {
        "startLine": 818,
        "startChar": 0,
        "endLine": 818,
        "endChar": 53
      },
      "revId": "574925759f4ea65e96d159a850488289ad663384",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "09cf1e12_d9f2cc04",
        "filename": "host/lib/crossystem.c",
        "patchSetId": 4
      },
      "lineNbr": 10,
      "author": {
        "id": 1132414
      },
      "writtenOn": "2020-04-16T19:27:00Z",
      "side": 1,
      "message": "group the \u003csystem.headers\u003e with lines 6-9, not with the \"local.headers\" at lines 16-26.",
      "revId": "574925759f4ea65e96d159a850488289ad663384",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    }
  ]
}