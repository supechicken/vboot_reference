{
  "comments": [
    {
      "key": {
        "uuid": "8b14da30_26bf4621",
        "filename": "tests/vboot_api_kernel4_tests.c",
        "patchSetId": 4
      },
      "lineNbr": 66,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2019-04-12T01:11:42Z",
      "side": 1,
      "message": "nit: maybe also running vb2_init_context() here explicitly would make what the tests do a little closer to what real firmware does? Right now the tests enter the function to be tested with workbuf_used \u003d\u003d 0, whereas for the real code it will already have the previous SD and workbuffer there. It\u0027s not really a notable difference because the tested function will just call vb2_init_context() again anyway, but I feel it would be a bit cleaner... and you\u0027ll need to do this eventually anyway (and then copy additional mock data into the mock workbuffer here) as you proceed further with the migration.",
      "revId": "49481d561b192c1279188c31c72d0c25201b9dd7",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "e43a081f_55b6b3cb",
        "filename": "tests/vboot_api_kernel4_tests.c",
        "patchSetId": 4
      },
      "lineNbr": 66,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2019-04-12T02:03:18Z",
      "side": 1,
      "message": "I was also considering whether or not to make vb2_init_context part of the exposed API, if one of our goals is to break down monolithic \"phases\" into smaller callable parts.  But this seems like it could use some further discussion first.  Maybe we can decide an overall direction before starting to tweak stuff like this?",
      "parentUuid": "8b14da30_26bf4621",
      "revId": "49481d561b192c1279188c31c72d0c25201b9dd7",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "674ae9d4_49aa7cf0",
        "filename": "tests/vboot_api_kernel4_tests.c",
        "patchSetId": 4
      },
      "lineNbr": 66,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2019-04-12T05:27:16Z",
      "side": 1,
      "message": "No, I didn\u0027t mean opening it as part of the API. I just meant calling it from here to mock the state of an already previously initialized workbuffer (in the same way as test code often has to call into internal functions to mock stuff correctly). I see vb2_init_context as an internal function that all API entry points should call as the first thing they do to check that the passed-in context is valid. I don\u0027t see why you\u0027d need it externally.",
      "parentUuid": "e43a081f_55b6b3cb",
      "revId": "49481d561b192c1279188c31c72d0c25201b9dd7",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "5eb4170a_3b41f311",
        "filename": "tests/vboot_api_kernel4_tests.c",
        "patchSetId": 4
      },
      "lineNbr": 66,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2019-04-12T05:41:06Z",
      "side": 1,
      "message": "\u003e I don\u0027t see why you\u0027d need it externally.\nThis really depends on how much vboot functionality we want to chop up and externalize.\n\nRegardless, adding a vb2_init_context call still seems awkward here.  By adding it, we are making the assumption that \"vb2_init_context does initialization equivalent to depthcharge\u0027s vboot_init_context\".  Which if we want to test, perhaps we should test separately?\n\nAlternatively, we can update the requirements of an incoming vb2_context object to \"already have workbuf/vb2_shared_data initialized\" -- since currently for VbSelectAndLoadKernel, there are no use cases where it would not be.\n\nIn this case, we could test that it would be an error to call VbSelectAndLoadKernel with an empty workbuf, and then manually create mock workbuf content as you suggested for all the other existing cases.",
      "parentUuid": "674ae9d4_49aa7cf0",
      "revId": "49481d561b192c1279188c31c72d0c25201b9dd7",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "38bd8376_1363244c",
        "filename": "tests/vboot_api_kernel4_tests.c",
        "patchSetId": 4
      },
      "lineNbr": 66,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2019-04-12T21:16:08Z",
      "side": 1,
      "message": "\u003e By adding it, we are making the assumption that \"vb2_init_context does initialization equivalent to depthcharge\u0027s vboot_init_context\". Which if we want to test, perhaps we should test separately?\n\nWell, you can\u0027t test depthcharge code from here.\n\nWhat you essentially need is a mock of everything coreboot did (because that\u0027s where depthcharge\u0027s vboot_init_context really gets its data from). coreboot did call vb2_init_context() at some point, so that\u0027s the part we can easily replicate here. All the other things coreboot did with it are more complicated and not really relevant to the test here working right, so I\u0027d ignore them.\n\n\u003e Alternatively, we can update the requirements of an incoming vb2_context object to \"already have workbuf/vb2_shared_data initialized\" -- since currently for VbSelectAndLoadKernel, there are no use cases where it would not be.\n\nWe could do that, yes. A problem is that right now vb2_init_context() serves two purposes (validate the magic/version and initialize SD if it hasn\u0027t been initialized yet). We probably still want every kernel verification API entry point to do the first part, so if you don\u0027t want them to do the second one you\u0027d have to split it up.\n\nAnyway, I didn\u0027t mean to hold up this whole CL so long with this, I think it\u0027s also fine if you submit it as is and we can deal with these things when you\u0027re further along with the migration.",
      "parentUuid": "5eb4170a_3b41f311",
      "revId": "49481d561b192c1279188c31c72d0c25201b9dd7",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "2dcbde28_76c18d7d",
        "filename": "tests/vboot_api_kernel4_tests.c",
        "patchSetId": 4
      },
      "lineNbr": 66,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2019-04-13T03:35:22Z",
      "side": 1,
      "message": "\u003e coreboot did call vb2_init_context() at some point, so that\u0027s the part we can easily replicate here.\n\nI suppose, but indirectly, since vboot calls it when in vb2api_fw_phase1.\n\nMaybe what we really need are some new tests that make sure vboot deals with incoming initialized workbuf data correctly?",
      "parentUuid": "38bd8376_1363244c",
      "revId": "49481d561b192c1279188c31c72d0c25201b9dd7",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    }
  ]
}