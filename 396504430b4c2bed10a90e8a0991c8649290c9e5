{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "01702b73_b6a76316",
        "filename": "firmware/2lib/include/2struct.h",
        "patchSetId": 3
      },
      "lineNbr": 368,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2021-05-14T06:28:42Z",
      "side": 1,
      "message": "@jwerner, does this look okay to you?",
      "range": {
        "startLine": 367,
        "startChar": 0,
        "endLine": 368,
        "endChar": 62
      },
      "revId": "396504430b4c2bed10a90e8a0991c8649290c9e5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "7ff2e949_368cffc3",
        "filename": "firmware/2lib/include/2struct.h",
        "patchSetId": 3
      },
      "lineNbr": 368,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2021-05-19T06:55:18Z",
      "side": 1,
      "message": "So, it seems like if we use the NBR_0 and NBR_1 as suggested in the design doc, firmware must know whether it is booting NBR kernel or regular recovery kernel.  This would break the use case of being able to boot NBR from USB disk, unless we had some special UI in Groot to choose between \"regular recovery image\" and \"NBR image\".  That seems kind of counter-intuitive (and counter-productive).\n\nThat\u0027s why I\u0027m suggesting EXTERNAL_0 and EXTERNAL_1 here, as a way of at least differentiating which recovery kernels can be booted from USB, and which cannot.  If we go down this route, then firmware still needs to know what kind of image this is, in order to decide what type of rollback protection to employ (see https://docs.google.com/document/d/1JYLwUlHjFwARhFBSFTw4PeGzqTAeyeHSVxCH2M3CdMI/edit?pli\u003d1\u0026disco\u003dAAAAIEpn8fo).  Thus I also added a NBR flag here.\n\nAny thoughts?  Is it still worth all of this extra work just to support NBR on USB?",
      "parentUuid": "01702b73_b6a76316",
      "range": {
        "startLine": 367,
        "startChar": 0,
        "endLine": 368,
        "endChar": 62
      },
      "revId": "396504430b4c2bed10a90e8a0991c8649290c9e5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "99d9e2d0_62ece86e",
        "filename": "firmware/2lib/include/2struct.h",
        "patchSetId": 3
      },
      "lineNbr": 368,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2021-05-19T23:16:05Z",
      "side": 1,
      "message": "Isn\u0027t your EXTERNAL_0/EXTERNAL_1 just the exact opposite of NBR_0/NBR_1? In my mind, NBR_1 means whether the user selected the \"built-in recovery\" menu option in the recovery mode UI... so images booted in that mode need to have the NBR_1 and RECOVERY_1 flags set (and DEV_x according to their current dev mode state). Images booted from USB in recovery mode would need to have NBR_0 and RECOVERY_1 set. If you want to sign an NBR kernel such that it can both be booted in actual NBR mode (from internal disk using the sector search) and as a normal GPT partition kernel from a recovery USB stick, you can just sign it NBR_0 | NBR_1 | RECOVERY_1 | DEV_0 | DEV_1. (Note that the matrix here isn\u0027t perfect and some things cannot be expressed -- but that has always been the case. You can already not sign an image today so that it can either be booted in recovery mode (without dev mode) or in dev mode with Ctrl+U but *not* in normal/secure mode from disk. In practice, we usually just want to sign each image for one specific mode and this tends to not really be a problem. If we want to ship NBR kernels on USB images, we can always just sign those differently than the ones we install on the internal disks, too.)\n\nI think the rollback protection should be completely independent from all these bootability-in-mode flags. Rollback doesn\u0027t really belong in the keyblock anyway, I think, because we just generally have no rollback protection for the recovery subkey anyway. I originally though that we would just always rollback-check the NBR (sector search) boot flow and never the USB boot flow, regardless of image... but maybe it\u0027s not such a bad idea to tie it to the image after all? Maybe add a preamble flag to enable this?\n\n(And yes, I\u0027m really sure what the point is in trying to boot NBR kernels from USB anyway. But if they want it I think we can support it.)",
      "parentUuid": "7ff2e949_368cffc3",
      "range": {
        "startLine": 367,
        "startChar": 0,
        "endLine": 368,
        "endChar": 62
      },
      "revId": "396504430b4c2bed10a90e8a0991c8649290c9e5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "2418ea8b_98d23dea",
        "filename": "firmware/2lib/include/2struct.h",
        "patchSetId": 3
      },
      "lineNbr": 368,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2021-05-21T12:29:32Z",
      "side": 1,
      "message": "I had intended EXTERNAL_0/EXTERNAL_1 to be checked against the disk in question (external vs. internal), without caring about how the kernel was found.\n\nIn the NBR_0/NBR_1 model, I\u0027m still a bit confused at what this is being checked against?  Does NBR_1 correspond to a sector-based kernel search, and NBR_0 to a partition-based kernel search?  If so, should we name it as such?  Or, should we just rename the sector-based kernel search to be \"NBR kernel search\"?",
      "parentUuid": "99d9e2d0_62ece86e",
      "range": {
        "startLine": 367,
        "startChar": 0,
        "endLine": 368,
        "endChar": 62
      },
      "revId": "396504430b4c2bed10a90e8a0991c8649290c9e5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9615f9b0_d3a244a5",
        "filename": "firmware/2lib/include/2struct.h",
        "patchSetId": 3
      },
      "lineNbr": 368,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2021-05-24T22:18:36Z",
      "side": 1,
      "message": "\u003e I had intended EXTERNAL_0/EXTERNAL_1 to be checked against the disk in question (external vs. internal), without caring about how the kernel was found.\n\nBut an NBR boot is always from internal disk anyway? (In the way I use the terminology, I wouldn\u0027t consider booting an NBR kernel from USB an \"NBR boot\" -- that\u0027s a normal USB recovery boot of a GPT partition and vboot has no idea what\u0027s inside the signed kernel image.) I don\u0027t think an internal/external distinction would be that important, and it also cannot be mapped to our existing flags: both a USB recovery boot and a Ctrl+U developer boot are \"external\", but they\u0027re checking different flags... meanwhile, Ctrl+D and Ctrl+U check the same flags while one is internal and one is external. I think the \"boot mode\" is more important because that decides under what circumstances this boot is possible and what special permissions (e.g. TPM unlocked) come with it. That\u0027s why I would just expand our current flags with \"NBR\" as a new category (on top of RECOVERY).\n\n\u003e Does NBR_1 correspond to a sector-based kernel search, and NBR_0 to a partition-based kernel search?\n\nYes.\n\n\u003e If so, should we name it as such?  Or, should we just rename the sector-based kernel search to be \"NBR kernel search\"?\n\nProbably less confusing to just stick with one name (e.g. NBR) everywhere.",
      "parentUuid": "2418ea8b_98d23dea",
      "range": {
        "startLine": 367,
        "startChar": 0,
        "endLine": 368,
        "endChar": 62
      },
      "revId": "396504430b4c2bed10a90e8a0991c8649290c9e5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "9acb9ac2_7a889335",
        "filename": "firmware/2lib/include/2struct.h",
        "patchSetId": 3
      },
      "lineNbr": 368,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2021-05-26T08:40:42Z",
      "side": 1,
      "message": "Ack, renaming everywhere to \"NBR\" instead of more generic terms like \"sector search\".\n\nJust as a note here -- looks like a lot of our discussions on this CL stem from having different design perspectives.  I had originally envisioned \"NBR mode\" being triggered from loading an NBR image, regardless of coming from a USB disk or from an internal disk.  However, I\u0027m seeing that implementation is a lot simpler under the assumption you have been stating all along -- that NBR mode is limited exclusively to booting from a sector search on an internal disk (and conversely, that any other recovery modes *do not* allow sector search).  So let\u0027s move forward with that assumption.",
      "parentUuid": "9615f9b0_d3a244a5",
      "range": {
        "startLine": 367,
        "startChar": 0,
        "endLine": 368,
        "endChar": 62
      },
      "revId": "396504430b4c2bed10a90e8a0991c8649290c9e5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    }
  ]
}