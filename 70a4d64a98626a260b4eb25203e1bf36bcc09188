{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "35c7d53f_dca080db",
        "filename": "host/lib/subprocess.c",
        "patchSetId": 2
      },
      "lineNbr": 270,
      "author": {
        "id": 1353551
      },
      "writtenOn": "2022-07-06T03:05:54Z",
      "side": 1,
      "message": "```\n#ifdef CHROMEOS_ENVIRONMENT                                                      \n#define test_mockable __attribute__((weak))                                      \n#else                                                                            \n#define test_mockable                                                            \n#endif\n```\n\nFor host lib `CHROMEOS_ENVIRONMENT` will be defined, so this will be `__attribute__((weak))`. I guess that should be fine?\n\nOtherwise, we\u0027ll need a way for Makefile to tell whether it\u0027s for unit tests or not, and define `test_mockable` only in test environment. Two approaches that I can think of:\n\n1. Check the make target name (similar how unit tests are handled in depthcharge). This may require some refactoring work for Makefile.\n2. Pass `UNIT_TEST\u003d1` to make, from the ebuild. This would make running tests locally (by `make runtests`) more inconvenient.",
      "range": {
        "startLine": 270,
        "startChar": 0,
        "endLine": 270,
        "endChar": 13
      },
      "revId": "70a4d64a98626a260b4eb25203e1bf36bcc09188",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9326d3a0_cb13d674",
        "filename": "host/lib/subprocess.c",
        "patchSetId": 2
      },
      "lineNbr": 270,
      "author": {
        "id": 1512562
      },
      "writtenOn": "2022-07-06T08:13:22Z",
      "side": 1,
      "message": "What do you think about approach shown below? I tested it with your patch, and it seems to work. However, some targets might be missing form Makefile filters, so please, checks it.\n\n```\n// Can `if defined(CHROMEOS_ENVIRONMENT)` be dropped at this point?\n#ifndef test_mockable\n#if defined(CHROMEOS_ENVIRONMENT) \u0026\u0026 (defined(UNIT_TESTS) \u0026\u0026 UNIT_TESTS \u003d\u003d 1)\n#define test_mockable __attribute__((weak))\n#else\n#define test_mockable\n#endif\n#endif\n```\n\n```\n# ----------------------------------------------------------------------------\n# Tests\n\nifneq ($(filter %test test% %tests tests%, $(MAKECMDGOALS)),)\nifneq ($(filter-out %test test% %tests tests%, $(MAKECMDGOALS)),)\n$(error Cannot mix unit-tests targets with other targets)\nendif\nCFLAGS +\u003d -DUNIT_TESTS\u003d1\nendif\n\n.PHONY: tests\ntests: ${TEST_BINS}\n```",
      "parentUuid": "35c7d53f_dca080db",
      "range": {
        "startLine": 270,
        "startChar": 0,
        "endLine": 270,
        "endChar": 13
      },
      "revId": "70a4d64a98626a260b4eb25203e1bf36bcc09188",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c9d8d5a4_ce54a569",
        "filename": "host/lib/subprocess.c",
        "patchSetId": 2
      },
      "lineNbr": 270,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2022-07-06T23:43:28Z",
      "side": 1,
      "message": "The problem with using different compilation flags is that object files cannot be  shared between test builds and normal host library builds. For coreboot/depthcharge there\u0027s no host library and test object files are completely separate from firmware object files, so that\u0027s no issue. For vboot, the current system still assumes it can just link them together (e.g. TEST_BINS: LIBS \u003d ${UTILLIB}), so you can\u0027t just set -DUNIT_TESTS\u003d1 for tests but not for host utilities.\n\nI think the best option would be to refactor the Makefile to completely separate test builds from host utility builds. so that this becomes possible. (Maybe it would be nice to import some other tricks from the coreboot/depthcharge test frameworks while doing that... it\u0027s pretty annoying to have to put a test_mockable in front of almost every function declaration in vboot, it\u0027s nicer to have a system like coreboot/depthcharge where tests can declare what functions they mock and the #pragma weak directives get generated automatically based on that. A lower effort but probably also effective option would be to just build all test object files with `-Og` instead of `-Os`.)",
      "parentUuid": "9326d3a0_cb13d674",
      "range": {
        "startLine": 270,
        "startChar": 0,
        "endLine": 270,
        "endChar": 13
      },
      "revId": "70a4d64a98626a260b4eb25203e1bf36bcc09188",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "27e55416_75b4a124",
        "filename": "host/lib/subprocess.c",
        "patchSetId": 2
      },
      "lineNbr": 270,
      "author": {
        "id": 1512562
      },
      "writtenOn": "2022-07-21T09:54:47Z",
      "side": 1,
      "message": "How about partially re-writing vboot build system to make it similar to coreboot/depthcharge? coreboots\u0027 build system is nice when it comes to building both target and host binaries at the same time, so I think it might work here as well. Of course, it would slightly increase build time, but it would introduce builds isolation.\nWith that, it would be easier to port coreboot/depthcharge test framework here and create non-invasive tests (no test_mockable etc.)\n\nRewrite like will be time-consuming, but I think it\u0027s worth the effort if this project has to be maintained for years from now on. I think, that current Makefile is too complicated, yet too primitive, and thus causes many problems.",
      "parentUuid": "c9d8d5a4_ce54a569",
      "range": {
        "startLine": 270,
        "startChar": 0,
        "endLine": 270,
        "endChar": 13
      },
      "revId": "70a4d64a98626a260b4eb25203e1bf36bcc09188",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b3840619_d92f2073",
        "filename": "host/lib/subprocess.c",
        "patchSetId": 2
      },
      "lineNbr": 270,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2022-07-22T00:15:48Z",
      "side": 1,
      "message": "I\u0027m not really sure what exactly you mean \"partial rewrite to make it similar to coreboot/depthcharge\"... generally, yes, I think we need a rewrite that at least separates files built for tests completely from files built for host utilities. How exactly you want to design that is up to you -- I would suggest to try not to make it too complicated/extensive, though. We have a lot of important priorities right now (e.g. finishing RW CBFS verification) and vboot build system flexibility, while nice, is pretty far back on the list. So I\u0027d say do what needs to be done to fix the problem without trying to grow it too far in scope.\n\nAlso, remember that vboot is BSD licensed while coreboot and depthcharge are GPL, so if you want to directly copy something, try to copy it from libpayload to stay on the safe side there.",
      "parentUuid": "27e55416_75b4a124",
      "range": {
        "startLine": 270,
        "startChar": 0,
        "endLine": 270,
        "endChar": 13
      },
      "revId": "70a4d64a98626a260b4eb25203e1bf36bcc09188",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    }
  ]
}