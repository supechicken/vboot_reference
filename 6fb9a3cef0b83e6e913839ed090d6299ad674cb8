{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "6eaa2357_71da428b",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 16,
      "author": {
        "id": 1353551
      },
      "writtenOn": "2022-11-22T07:32:20Z",
      "side": 1,
      "message": "Should this be `USE\u003d-flashrom`?",
      "range": {
        "startLine": 16,
        "startChar": 24,
        "endLine": 16,
        "endChar": 33
      },
      "revId": "6fb9a3cef0b83e6e913839ed090d6299ad674cb8",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "82754e95_e6ff5edb",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 16,
      "author": {
        "id": 1561252
      },
      "writtenOn": "2022-11-29T19:27:35Z",
      "side": 1,
      "message": "Done.",
      "parentUuid": "6eaa2357_71da428b",
      "range": {
        "startLine": 16,
        "startChar": 24,
        "endLine": 16,
        "endChar": 33
      },
      "revId": "6fb9a3cef0b83e6e913839ed090d6299ad674cb8",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "d4bcb816_ad38b93c",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1561252
      },
      "writtenOn": "2022-11-22T00:44:49Z",
      "side": 1,
      "message": "Hello,\n\nThis change is for cl 4017045 which makes flashrom optional in the vboot_reference ebuild. This fixes the bug where vboot_reference won\u0027t install properly if USE_FLASHROM is disabled.\n\nhttps://chromium-review.googlesource.com/c/chromiumos/overlays/chromiumos-overlay/+/4017045",
      "revId": "6fb9a3cef0b83e6e913839ed090d6299ad674cb8",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "0ca27334_b645f35e",
        "filename": "host/arch/x86/lib/crossystem_arch.c",
        "patchSetId": 1
      },
      "lineNbr": 199,
      "author": {
        "id": 1353551
      },
      "writtenOn": "2022-11-22T07:32:20Z",
      "side": 1,
      "message": "The problem is, we can\u0027t simply skip flashrom operations for crossystem, because it\u0027s required on arm (see host/arch/arm/lib/crossystem_arch.c). Therefore, to build vboot_reference without flashrom, I think the proper solution is to stop building utility/crossystem.",
      "revId": "6fb9a3cef0b83e6e913839ed090d6299ad674cb8",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d9df3b2b_b26708e0",
        "filename": "host/arch/x86/lib/crossystem_arch.c",
        "patchSetId": 1
      },
      "lineNbr": 199,
      "author": {
        "id": 1561252
      },
      "writtenOn": "2022-11-22T18:17:32Z",
      "side": 1,
      "message": "Gotcha, I\u0027ll experiment with not building utility/crosystem altogether instead of excluding flashrom operations.",
      "parentUuid": "0ca27334_b645f35e",
      "revId": "6fb9a3cef0b83e6e913839ed090d6299ad674cb8",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "43639941_0d91136d",
        "filename": "host/arch/x86/lib/crossystem_arch.c",
        "patchSetId": 1
      },
      "lineNbr": 199,
      "author": {
        "id": 1561252
      },
      "writtenOn": "2022-11-29T19:27:35Z",
      "side": 1,
      "message": "Looks like conditionally compiling utility/crossystem passes unit tests. I\u0027ve made the change in the latest patch set.",
      "parentUuid": "d9df3b2b_b26708e0",
      "revId": "6fb9a3cef0b83e6e913839ed090d6299ad674cb8",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "724f140b_a1b06e94",
        "filename": "host/arch/x86/lib/crossystem_arch.c",
        "patchSetId": 1
      },
      "lineNbr": 199,
      "author": {
        "id": 1561252
      },
      "writtenOn": "2023-01-10T01:22:37Z",
      "side": 1,
      "message": "So it turns out that while this change does allow vboot_reference to compile without flashrom, when other packages such as `chromeos-base/secure-erase-file` reference the crossystem lib, the linker fails saying that certain symbols are no longer defined.\n\nTo your comment about host/arch/arm/lib/crossystem_arch.c is there a reason why I couldn\u0027t also make conditional the flashrom symbols for arm like I did in patchset 1 for x86?",
      "parentUuid": "43639941_0d91136d",
      "revId": "6fb9a3cef0b83e6e913839ed090d6299ad674cb8",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "71dc8b1e_b2b84e98",
        "filename": "host/arch/x86/lib/crossystem_arch.c",
        "patchSetId": 1
      },
      "lineNbr": 199,
      "author": {
        "id": 1353551
      },
      "writtenOn": "2023-01-10T08:00:20Z",
      "side": 1,
      "message": "What linker error did you see? We only removed utility/crossystem in PS4, so I wouldn\u0027t expect any lib to be affected. What exactly is the \"crossystem lib\" that is missing symbols? Is it `libvboot_host.a`?",
      "parentUuid": "724f140b_a1b06e94",
      "revId": "6fb9a3cef0b83e6e913839ed090d6299ad674cb8",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "7122ac77_a887cbcc",
        "filename": "host/arch/x86/lib/crossystem_arch.c",
        "patchSetId": 1
      },
      "lineNbr": 199,
      "author": {
        "id": 1561252
      },
      "writtenOn": "2023-01-10T20:10:36Z",
      "side": 1,
      "message": "The lib here is something called libbrillo-crossystem which I think loads in a library generated by this package that\u0027s just called lib/crossystem.\n\nHere\u0027s the issue I\u0027m running into. I\u0027m compiling a package that has a dependency graph that looks like this:\n\n```\nsecure-erase-file\n\tlibbrillo\n\t\tvboot_reference\n```\n\nWhen vboot_reference is compiled without flashrom, the symbols flashrom_read and flashrom_write are no longer defined but are referenced by\ncrossystem_arch. The linker doesn\u0027t complain when compiling lib/crossystem but when other programs try to link against this library,\nthe following error occurs:\n\n```\n$ USE\u003d-flashrom emerge-lakitu vboot_reference \u0026\u0026 emerge-lakitu libbrillo \u0026\u0026 emerge-lakitu chromeos-base/secure-erase-file\n...\nld.lld: error: /build/lakitu/usr/lib64/libbrillo-crossystem.so: undefined reference to flashrom_read [--no-allow-shlib-undefined]\nld.lld: error: /build/lakitu/usr/lib64/libbrillo-crossystem.so: undefined reference to flashrom_write [--no-allow-shlib-undefined]\n```\n\nBoth vboot_reference and libbrillo compile fine but when linked by secure-erase file, I get the following errors above. This does not happen when the flashrom symbols are not referenced in crossystem_arch and in crossystem.c. Looks like there are two flashrom functions defined in host/include/crossystem_vbnv.h and when they\u0027re invoked they reference lib/include/flashrom.h which is no longer installed.\n\nWhat is the recommended course of action here? I feel that spamming preprocessor directives isn\u0027t a great way to decouple flashrom and crossystem but it seems that they are tightly coupled at the moment.",
      "parentUuid": "71dc8b1e_b2b84e98",
      "revId": "6fb9a3cef0b83e6e913839ed090d6299ad674cb8",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "f924e516_990c3eab",
        "filename": "host/arch/x86/lib/crossystem_arch.c",
        "patchSetId": 1
      },
      "lineNbr": 199,
      "author": {
        "id": 1561252
      },
      "writtenOn": "2023-01-10T20:21:17Z",
      "side": 1,
      "message": "Looks like the only files that refer to host/lib/crossystem_vbnh.h are crosssystem_arch.c and crossystem.c which is consistent with the changes made in PS1. I think the path forward for being able to compile vboot without flashrom support is to somehow reference this header conditionally.\n\n```\nhost/lib/crossystem.c\n21:#include \"crossystem_vbnv.h\"\n\nhost/arch/stub/lib/crossystem_arch.c\n8:#include \"crossystem_vbnv.h\"\n\nhost/arch/x86/lib/crossystem_arch.c\n26:#include \"crossystem_vbnv.h\"\n\nhost/arch/arm/lib/crossystem_arch.c\n27:#include \"crossystem_vbnv.h\"\n```",
      "parentUuid": "7122ac77_a887cbcc",
      "revId": "6fb9a3cef0b83e6e913839ed090d6299ad674cb8",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "09f20313_3f55372f",
        "filename": "host/arch/x86/lib/crossystem_arch.c",
        "patchSetId": 1
      },
      "lineNbr": 199,
      "author": {
        "id": 1353551
      },
      "writtenOn": "2023-01-11T09:44:25Z",
      "side": 1,
      "message": "The problem doesn\u0027t seem to be related to header files. In order to prevent the linker from complaining (with `--no-allow-shlib-undefined`), I think the correct way is to exclude crossystem_arch.c and crossystem.c (and all dependencies of them) from the vboot lib. Could you try removing them from `UTILLIB_SRCS` (or `HOSTLIB_SRCS`, or both, not sure which one is correct) in vboot_reference/Makefile?\n\nAnother question is why and how `--no-allow-shlib-undefined` is enabled (can\u0027t find it in platform2 repo). From https://wiki.gentoo.org/wiki/Project:Quality_Assurance/-Wl,-z,defs_and_-Wl,--no-allow-shlib-undefined:\n\n\u003e Use of -Wl,--no-allow-shlib-undefined has not been tested thouroughly and may break weird systems, so it\u0027s preferable to focus on -Wl,-z,defs only.",
      "parentUuid": "f924e516_990c3eab",
      "revId": "6fb9a3cef0b83e6e913839ed090d6299ad674cb8",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b949f6fc_240870e5",
        "filename": "host/arch/x86/lib/crossystem_arch.c",
        "patchSetId": 1
      },
      "lineNbr": 199,
      "author": {
        "id": 1561252
      },
      "writtenOn": "2023-01-12T00:08:18Z",
      "side": 1,
      "message": "So I think the problem here is with the dependency graph shown here:\n\n```\nsecure-erase-file\n    libbrillo\n        vboot_reference\n```\n\nLibbrillo has a library called libbrillo-crossystem that links into vboot/crossystem.h which declares various symbols that would no longer be defined if I removed crossystem.c and crossystem_arch.c from UTLLIB_SRCS. If those symbols are not declared, both libbrillo and vboot_reference will compile since they\u0027re shared libraries but the executable secure-erase-file won\u0027t. I think to disable flashrom support from vboot_reference the only real path forward here is to keep those symbols defined but exclude blocks that rely on flashrom by using preprocessor directives. \n\nHere\u0027s the output if I remove crossystem.c and crossystem_arch.c from UTILLIB_SRCS and HOSTLIB_SRCS\n\n```\n$ USE\u003d-flashrom emerge-lakitu vboot_reference \u0026\u0026 emerge-lakitu libbrillo \u0026\u0026 emerge-lakitu chromeos-base/secure-erase-file\n\n\u003e\u003e\u003e vboot compiles successfully\n\u003e\u003e\u003e libbrillo compiles successfully\n\n\u003e\u003e\u003e secure-erase-file fails with the following:\n\nld.lld: error: /build/lakitu/usr/lib64/libbrillo-crossystem.so: undefined reference to VbGetSystemPropertyInt [--no-allow-shlib-undefined]\nld.lld: error: /build/lakitu/usr/lib64/libbrillo-crossystem.so: undefined reference to VbSetSystemPropertyInt [--no-allow-shlib-undefined]\nld.lld: error: /build/lakitu/usr/lib64/libbrillo-crossystem.so: undefined reference to VbGetSystemPropertyString [--no-allow-shlib-undefined]\nld.lld: error: /build/lakitu/usr/lib64/libbrillo-crossystem.so: undefined reference to VbSetSystemPropertyString [--no-allow-shlib-undefined]\n```\n\nSee src/platform2/libcrossystem/crossystem.cc",
      "parentUuid": "09f20313_3f55372f",
      "revId": "6fb9a3cef0b83e6e913839ed090d6299ad674cb8",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "af23336c_5c9d3648",
        "filename": "host/arch/x86/lib/crossystem_arch.c",
        "patchSetId": 1
      },
      "lineNbr": 199,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2023-01-12T01:27:35Z",
      "side": 1,
      "message": "Let\u0027s take a step back -- what is really your goal here? Because it sounds like you want to build libvboot_host.a without a dependency on flashrom, but the problem is that the main functionality provided by libvboot_host.a (vboot nvdata access) *does* depend on flashrom, fundamentally, because those nvdata variables are stored in flash and we need flashrom to access that.\n\nAre you saying that you want to build a version of libvboot_host.a without the nvdata access parts? Because I don\u0027t think there\u0027s much left of that library after that, that\u0027s the most important thing it does. And it sounds like the package you\u0027re trying to build (libbrillo-crossystem, or rather secure-erase-file) needs that functionality somehow.\n\nIf I followed the bug correctly it sounds like you\u0027re from COS, which IIRC is a kind of ChromeOS offshoot for servers, right? Do you actually have vboot nvdata on those systems? Do you use ChromeOS firmware? Because if you don\u0027t, then it doesn\u0027t really make sense for you to run code that tries to access them in the first place. Maybe we would want to add a new USE\u003dno_vboot_nvdata flag that just makes all those crossystem functions return errors without even trying to access anything (or maybe we tie that behavior directly to USE\u003dflashrom being disabled, although that would be a bit more of a stretch).",
      "parentUuid": "b949f6fc_240870e5",
      "revId": "6fb9a3cef0b83e6e913839ed090d6299ad674cb8",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e32ae9ef_1abc2d27",
        "filename": "host/arch/x86/lib/crossystem_arch.c",
        "patchSetId": 1
      },
      "lineNbr": 199,
      "author": {
        "id": 1561252
      },
      "writtenOn": "2023-01-13T19:33:48Z",
      "side": 1,
      "message": "Yup, you\u0027re correct. COS is indeed a chrome os offshoot for servers and we do not use vboot nvdata or chromeos firmware. The main goal here is to just remove packages so that we\u0027re less vulnerable and have fewer CVE\u0027s to respond to.\n\nI think for now, what I need to do is see which packages depend on crossystem and see if they can be removed from our source tree. The reason I tried removing flashrom from vboot was that it seemed like a trivial change but after doing some of the work here to remove it, it looks like a good next step would be to see what packages depend on crossystem and see if I can get those packages removed from our src tree altogether especially if cos doesn\u0027t even use vboot nvdata.",
      "parentUuid": "af23336c_5c9d3648",
      "revId": "6fb9a3cef0b83e6e913839ed090d6299ad674cb8",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "593273c6_c0734236",
        "filename": "host/arch/x86/lib/crossystem_arch.c",
        "patchSetId": 1
      },
      "lineNbr": 199,
      "author": {
        "id": 1353551
      },
      "writtenOn": "2023-01-16T03:28:09Z",
      "side": 1,
      "message": "If in the end COS no longer depends on vboot_reference, I\u0027d hope to remove `USE_FLASHROM`, because it has started making the vboot_reference code more and more complicated (for example CL:4075311).",
      "parentUuid": "e32ae9ef_1abc2d27",
      "revId": "6fb9a3cef0b83e6e913839ed090d6299ad674cb8",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "aeccdf35_4b8d0985",
        "filename": "host/arch/x86/lib/crossystem_arch.c",
        "patchSetId": 1
      },
      "lineNbr": 199,
      "author": {
        "id": 1561252
      },
      "writtenOn": "2023-01-17T21:09:48Z",
      "side": 1,
      "message": "Right, sounds good. I\u0027ll investigate further on what we can remove on COS and keep the chrome os team updated.",
      "parentUuid": "593273c6_c0734236",
      "revId": "6fb9a3cef0b83e6e913839ed090d6299ad674cb8",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "f85796e9_69a380ce",
        "filename": "host/arch/x86/lib/crossystem_arch.c",
        "patchSetId": 1
      },
      "lineNbr": 199,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2023-01-18T01:59:39Z",
      "side": 1,
      "message": "USE_FLASHROM is still required for upstream coreboot since it needs to build futility for key management but doesn\u0027t want to have the flashrom dependency.",
      "parentUuid": "aeccdf35_4b8d0985",
      "revId": "6fb9a3cef0b83e6e913839ed090d6299ad674cb8",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "63134607_818e818d",
        "filename": "host/lib/crossystem.c",
        "patchSetId": 1
      },
      "lineNbr": 782,
      "author": {
        "id": 1314079
      },
      "writtenOn": "2022-11-22T01:15:54Z",
      "side": 1,
      "message": "how about putting all the symbols below into their own file to become its own object and let the build system do its job rather than leaning on pre-processor complexity?",
      "range": {
        "startLine": 782,
        "startChar": 0,
        "endLine": 782,
        "endChar": 19
      },
      "revId": "6fb9a3cef0b83e6e913839ed090d6299ad674cb8",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "3ad438ba_9ac10b60",
        "filename": "host/lib/crossystem.c",
        "patchSetId": 1
      },
      "lineNbr": 782,
      "author": {
        "id": 1561252
      },
      "writtenOn": "2022-11-22T18:17:32Z",
      "side": 1,
      "message": "Right, yeah that\u0027s a better plan. Having this be handled by the build system will be easier to comprehend too since all you\u0027d have to do is skim the makefile and not have to grep for ifdefs everywhere.",
      "parentUuid": "63134607_818e818d",
      "range": {
        "startLine": 782,
        "startChar": 0,
        "endLine": 782,
        "endChar": 19
      },
      "revId": "6fb9a3cef0b83e6e913839ed090d6299ad674cb8",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "d0c8bba7_0c4876dc",
        "filename": "host/lib/crossystem.c",
        "patchSetId": 1
      },
      "lineNbr": 782,
      "author": {
        "id": 1561252
      },
      "writtenOn": "2022-11-29T19:27:35Z",
      "side": 1,
      "message": "So instead of moving these symbols to another file, utility/crossystem is now conditionally compiled if USE_FLASHROM is set to true.",
      "parentUuid": "3ad438ba_9ac10b60",
      "range": {
        "startLine": 782,
        "startChar": 0,
        "endLine": 782,
        "endChar": 19
      },
      "revId": "6fb9a3cef0b83e6e913839ed090d6299ad674cb8",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    }
  ]
}