{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "b3906066_e2fdecbf",
        "filename": "firmware/2lib/2misc.c",
        "patchSetId": 15
      },
      "lineNbr": 734,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2021-09-24T22:43:43Z",
      "side": 1,
      "message": "Sorry, my fault again. ^^ But this would make the system always boot in recovery mode all the time (no way to get back to normal mode) when that GBB flag is set, that\u0027s not the point of it either. That flag is basically supposed to disable the BROKEN screen so that it always becomes manual recovery.\n\nAlso, you still have sd-\u003erecovery_reason below now, that is too broad -- you actually need to check VB2_CONTEXT_FORCE_RECOVERY_MODE like I wrote. (Oh, I just noticed I accidentally wrote VB2_GBB_FLAG_FORCE_MANUAL_RECOVERY as well there, those two sound so similar, that was probably the issue.)\n\nOkay, anyway, new try (maybe this will make it read a bit more intuitive). How about this:\n\n if ((ctx-\u003eflags \u0026 VB2_GBB_FLAG_FORCE_MANUAL_RECOVERY) \u0026\u0026\n     !(ctx-\u003eflags \u0026 VB2_CONTEXT_NO_BOOT) \u0026\u0026\n     (ctx-\u003eflags \u0026 VB2_CONTEXT_EC_TRUSTED))) {\n         *boot_mode \u003d VB2_BOOT_MODE_MANUAL_RECOVERY;\n } else if (sd-\u003erecovery_reason) {\n         if ((vb2_get_gbb(ctx)-\u003eflags \u0026 VB2_GBB_FLAG_FORCE_MANUAL_RECOVERY)\n                 *boot_mode \u003d VB2_BOOT_MODE_MANUAL_RECOVERY;\n         else\n                 *boot_mode \u003d VB2_BOOT_MODE_BROKEN_SCREEN;\n }\n\n\n(Basically saying: if we have a manual recovery, *and* H1 thinks the EC is trusted, then boot manual recovery. Otherwise, if we have a recovery reason, boot the broken screen -- *unless* that GBB flag is set, then the broken screen is always treated like it was manual recovery.)",
      "revId": "0abc871543b0203642fb848cb59226112a858990",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "8f78c08e_6e238fe6",
        "filename": "firmware/2lib/2misc.c",
        "patchSetId": 15
      },
      "lineNbr": 734,
      "author": {
        "id": 1353551
      },
      "writtenOn": "2021-09-25T08:20:28Z",
      "side": 1,
      "message": "Since the condition is getting complicated and we\u0027ve been writing this wrong a few times, I\u0027d prefer changing it back to a static allow_recovery() function, which is much clearer than what we\u0027re doing right now (with comments explaining each condition).",
      "parentUuid": "b3906066_e2fdecbf",
      "revId": "0abc871543b0203642fb848cb59226112a858990",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a2eb817a_451f7952",
        "filename": "firmware/2lib/2misc.c",
        "patchSetId": 15
      },
      "lineNbr": 734,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2021-09-27T22:02:48Z",
      "side": 1,
      "message": "Well I\u0027m not sure the allow_recovery() function was necessarily any clearer (especially in a model where RECOVERY and BROKEN are considered completely different modes and calling it \"allow\" doesn\u0027t really much sense anymore). If you look at the earlier CLs of how allow_recovery() was written you will also see plenty of back and forth until it arrived at the version that was committed, that\u0027s not necessarily unusual or a sign that the final code was bad.",
      "parentUuid": "8f78c08e_6e238fe6",
      "revId": "0abc871543b0203642fb848cb59226112a858990",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "bfce291c_853547f9",
        "filename": "firmware/2lib/2misc.c",
        "patchSetId": 15
      },
      "lineNbr": 734,
      "author": {
        "id": 1383774
      },
      "writtenOn": "2021-09-30T06:55:55Z",
      "side": 1,
      "message": "\u003e  if ((ctx-\u003eflags \u0026 VB2_GBB_FLAG_FORCE_MANUAL_RECOVERY) \u0026\u0026\n\nI think this should be gbb-\u003eflags?",
      "parentUuid": "a2eb817a_451f7952",
      "revId": "0abc871543b0203642fb848cb59226112a858990",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "250e102e_ff91591d",
        "filename": "firmware/2lib/2misc.c",
        "patchSetId": 15
      },
      "lineNbr": 734,
      "author": {
        "id": 1353551
      },
      "writtenOn": "2021-09-30T08:26:11Z",
      "side": 1,
      "message": "\u003e Well I\u0027m not sure the allow_recovery() function was necessarily any clearer\n\nOkay, as long as the comment is clear enough, I\u0027m fine with that.",
      "parentUuid": "bfce291c_853547f9",
      "revId": "0abc871543b0203642fb848cb59226112a858990",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "39dacc38_a9cb1cbd",
        "filename": "firmware/2lib/2misc.c",
        "patchSetId": 15
      },
      "lineNbr": 734,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2021-10-04T23:00:11Z",
      "side": 1,
      "message": "\u003e  if ((ctx-\u003eflags \u0026 VB2_GBB_FLAG_FORCE_MANUAL_RECOVERY) \u0026\u0026\n\u003e I think this should be gbb-\u003eflags?\n\n*sigh*... no, sorry, that was supposed to be (ctx-\u003eflags \u0026 VB2_CONTEXT_FORCE_RECOVERY_MODE). I guess part of the problem is that these flags are named so similarly (maybe we should rename the GBB flag to ALWAYS_MANUAL_RECOVERY or something).",
      "parentUuid": "250e102e_ff91591d",
      "revId": "0abc871543b0203642fb848cb59226112a858990",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "18a5f210_aa5475d4",
        "filename": "firmware/2lib/2misc.c",
        "patchSetId": 15
      },
      "lineNbr": 734,
      "author": {
        "id": 1383774
      },
      "writtenOn": "2021-10-05T11:52:55Z",
      "side": 1,
      "message": "Fixed, but it means that, this failure can be caught by neither vboot unit test nor FAFT since I had ran them both",
      "parentUuid": "39dacc38_a9cb1cbd",
      "revId": "0abc871543b0203642fb848cb59226112a858990",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "91c75439_54e0776d",
        "filename": "firmware/2lib/2misc.c",
        "patchSetId": 15
      },
      "lineNbr": 734,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2021-10-06T00:34:11Z",
      "side": 1,
      "message": "...are you sure? This should have broken many basic tests like firmware_RecoveryButton. If you didn\u0027t see any errors with patch set 17 that would suggest you\u0027re not running all tests correctly (because that GBB flag isn\u0027t set in FAFT, and the way patch set 17 is written, without that flag it could never enter manual recovery mode.",
      "parentUuid": "18a5f210_aa5475d4",
      "revId": "0abc871543b0203642fb848cb59226112a858990",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "8fb355e2_90a278ea",
        "filename": "firmware/2lib/2misc.c",
        "patchSetId": 15
      },
      "lineNbr": 734,
      "author": {
        "id": 1353551
      },
      "writtenOn": "2021-10-06T01:47:29Z",
      "side": 1,
      "message": "FAFT should always set GBB flag to 0x140. Rocco, which FAFT test did you run (on PS16)?",
      "parentUuid": "91c75439_54e0776d",
      "revId": "0abc871543b0203642fb848cb59226112a858990",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "26048261_986fc1fb",
        "filename": "firmware/2lib/2misc.c",
        "patchSetId": 15
      },
      "lineNbr": 734,
      "author": {
        "id": 1383774
      },
      "writtenOn": "2021-10-06T06:11:29Z",
      "side": 1,
      "message": "It ran suite:faft_bios which contains firmware_RecoveryButton.\nLet me try to figure out what\u0027s going on here...",
      "parentUuid": "8fb355e2_90a278ea",
      "revId": "0abc871543b0203642fb848cb59226112a858990",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    }
  ]
}