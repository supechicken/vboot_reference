{
  "comments": [
    {
      "key": {
        "uuid": "21c29c57_7473a806",
        "filename": "firmware/2lib/2api.c",
        "patchSetId": 2
      },
      "lineNbr": 121,
      "author": {
        "id": 1002124
      },
      "writtenOn": "2014-12-18T16:52:45Z",
      "side": 1,
      "message": "Why sprinkle these checks around and not just put them in the 2sha_utility.c?",
      "revId": "1696b5ec9ab6047b675eaf17a0fbc4bb3539348a",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "e1996484_b22b80e8",
        "filename": "firmware/2lib/2api.c",
        "patchSetId": 2
      },
      "lineNbr": 121,
      "author": {
        "id": 1000187
      },
      "writtenOn": "2014-12-18T17:20:54Z",
      "side": 1,
      "message": "We can rename the current\n\nvb2_digest_*() \n\nfunctions to \n\nvb2_sw_digest_*()\n\nand then have all the checks in a set of wrapper functions\n\nvb2_digest_*()\n\nwhich calls either the _sw_ or _hwcrypto_ variants.\n\nThat way, the changes only need to be inside 2sha_utility.c.\n\nAh, but wait.  The ugly there is that vb2_digest_init() doesn\u0027t have access to the preamble flags.\n\nSo I think we should define a new hashing algorithm VB2_HASH_SHA256_HW.  And then if vb2ex_hwcrypto_digest_init() return unsupported, it falls back to the software variant.  That also gets rid of the need for plumbing a dc-\u003eusing_hycrypto flag everywhere.",
      "parentUuid": "21c29c57_7473a806",
      "revId": "1696b5ec9ab6047b675eaf17a0fbc4bb3539348a",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "c19c6086_e4b01486",
        "filename": "firmware/2lib/2api.c",
        "patchSetId": 2
      },
      "lineNbr": 121,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2014-12-18T19:59:14Z",
      "side": 1,
      "message": "One important thing is that the decision to use HW crypto in the first place must be in vb2api_init_hash(), not in vb2_digest_init()... because that function has other callers (keyblock and preamble verification) that I specifically never want to use HW crypto.\n\nWe can put the branch for the extend and finalize parts in either of them, I don\u0027t really care... I just thought that keeping everything in api.c would make it a little cleaner.\n\nI also thought about using new vb2_hash_algorithm values to somehow describe the hardware crypto choice, but I think that just ends up being less clear in the end. The vb2_signature/vb2_public_key that it\u0027s checked against is always marked VB2_HASH_SHA256, so if we introduce a new VB2_HASH_SHA256_HW we would need a translator function somewhere and end up having inconsitencies between the signature and the digest context. I think the decision to use HW crypto is really completely orthogonal to the algorithm, so having an extra flag for it makes most sense.",
      "parentUuid": "e1996484_b22b80e8",
      "revId": "1696b5ec9ab6047b675eaf17a0fbc4bb3539348a",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "a1a3ecb1_24182a9f",
        "filename": "firmware/2lib/2api.c",
        "patchSetId": 2
      },
      "lineNbr": 121,
      "author": {
        "id": 1002124
      },
      "writtenOn": "2014-12-18T20:35:39Z",
      "side": 1,
      "message": "That\u0027s what I figured. I thought about this after I posted my comment.",
      "parentUuid": "c19c6086_e4b01486",
      "revId": "1696b5ec9ab6047b675eaf17a0fbc4bb3539348a",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "e1e5e41c_d2c02460",
        "filename": "firmware/2lib/2api.c",
        "patchSetId": 2
      },
      "lineNbr": 121,
      "author": {
        "id": 1000187
      },
      "writtenOn": "2014-12-18T22:55:45Z",
      "side": 1,
      "message": "Yeah, ok.",
      "parentUuid": "a1a3ecb1_24182a9f",
      "revId": "1696b5ec9ab6047b675eaf17a0fbc4bb3539348a",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "812508f1_f6286eed",
        "filename": "firmware/2lib/2stub.c",
        "patchSetId": 2
      },
      "lineNbr": 11,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2014-12-17T23:58:24Z",
      "side": 1,
      "message": "I\u0027m not sure if this is how you do this in vboot, but without these futility doesn\u0027t compile (because it has its own definitions in cmd_vb2_verify_fw.c). Seems that if it needs nothing from this file it can compile just fine, but if it tries to pull in some functions (like my new stubs) it has to pull them all and will complain about the duplicate symbols.",
      "revId": "1696b5ec9ab6047b675eaf17a0fbc4bb3539348a",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "c19e206c_7130388a",
        "filename": "firmware/2lib/2stub.c",
        "patchSetId": 2
      },
      "lineNbr": 11,
      "author": {
        "id": 1000187
      },
      "writtenOn": "2014-12-18T17:20:54Z",
      "side": 1,
      "message": "In general we try to avoid weak, but here I think it\u0027s ok.",
      "parentUuid": "812508f1_f6286eed",
      "revId": "1696b5ec9ab6047b675eaf17a0fbc4bb3539348a",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "e1996484_92b3dc6c",
        "filename": "firmware/2lib/include/2api.h",
        "patchSetId": 2
      },
      "lineNbr": 377,
      "author": {
        "id": 1000187
      },
      "writtenOn": "2014-12-18T17:26:51Z",
      "side": 1,
      "message": "Do HW crypto engines ever require maintaining external state/context?\n\nWhy pass in data_size?  It\u0027s passed to vb2_digest_init() so that vb2_digest_finalize can ensure the right amount of data was hashed, but the Rockchip implementation never does anything with data_size.",
      "range": {
        "startLine": 376,
        "startChar": 0,
        "endLine": 377,
        "endChar": 30
      },
      "revId": "1696b5ec9ab6047b675eaf17a0fbc4bb3539348a",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "e197a45c_e51ff0cd",
        "filename": "firmware/2lib/include/2api.h",
        "patchSetId": 2
      },
      "lineNbr": 377,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2014-12-18T19:59:14Z",
      "side": 1,
      "message": "Yes, it does... it writes it to a register (HASH_MSG_LEN)",
      "parentUuid": "e1996484_92b3dc6c",
      "range": {
        "startLine": 376,
        "startChar": 0,
        "endLine": 377,
        "endChar": 30
      },
      "revId": "1696b5ec9ab6047b675eaf17a0fbc4bb3539348a",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "e197a45c_422fb2a4",
        "filename": "firmware/2lib/include/2api.h",
        "patchSetId": 2
      },
      "lineNbr": 384,
      "author": {
        "id": 1002124
      },
      "writtenOn": "2014-12-18T16:52:45Z",
      "side": 1,
      "message": "Why choose non-zero for this function and the following one when vb2ex_hwcrypto_digest_init() uses an error code ( presumably a VB2_* one).",
      "revId": "1696b5ec9ab6047b675eaf17a0fbc4bb3539348a",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "c19e206c_9124bc4c",
        "filename": "firmware/2lib/include/2api.h",
        "patchSetId": 2
      },
      "lineNbr": 384,
      "author": {
        "id": 1000187
      },
      "writtenOn": "2014-12-18T17:20:54Z",
      "side": 1,
      "message": "Technically it should be \"or non-zero error code\".  The comments are a little inconsistent in this regard; see vb2ex_read_resource() above.",
      "parentUuid": "e197a45c_422fb2a4",
      "revId": "1696b5ec9ab6047b675eaf17a0fbc4bb3539348a",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "c19c6086_07cadaae",
        "filename": "firmware/2lib/include/2api.h",
        "patchSetId": 2
      },
      "lineNbr": 384,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2014-12-18T19:59:14Z",
      "side": 1,
      "message": "Sorry, I just copied most of this from the vb2_digest_* comments. \"non-zero\" is supposed to mean a normal VB2_ERROR code.",
      "parentUuid": "c19e206c_9124bc4c",
      "revId": "1696b5ec9ab6047b675eaf17a0fbc4bb3539348a",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "a1a3ecb1_50e32c5d",
        "filename": "firmware/2lib/include/2api.h",
        "patchSetId": 2
      },
      "lineNbr": 397,
      "author": {
        "id": 1002124
      },
      "writtenOn": "2014-12-18T16:52:45Z",
      "side": 1,
      "message": "All the 2nd arguments can\u0027t if on the same line as the rest of the declaration?",
      "revId": "1696b5ec9ab6047b675eaf17a0fbc4bb3539348a",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "c19c6086_a7d8ce85",
        "filename": "firmware/2lib/include/2api.h",
        "patchSetId": 2
      },
      "lineNbr": 397,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2014-12-18T19:59:14Z",
      "side": 1,
      "message": "Right, they should... I didn\u0027t quite understand what the rule for this in vboot was. I guess it is \"all in one line if it fits, but as soon as there\u0027s more that one line put one parameter per line\"?",
      "parentUuid": "a1a3ecb1_50e32c5d",
      "revId": "1696b5ec9ab6047b675eaf17a0fbc4bb3539348a",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "e197a45c_e8bea786",
        "filename": "firmware/2lib/include/2api.h",
        "patchSetId": 2
      },
      "lineNbr": 397,
      "author": {
        "id": 1002124
      },
      "writtenOn": "2014-12-18T20:35:39Z",
      "side": 1,
      "message": "Ya. Not sure. I browsed up looking for a pattern. I think I came to the same conclusion.",
      "parentUuid": "c19c6086_a7d8ce85",
      "revId": "1696b5ec9ab6047b675eaf17a0fbc4bb3539348a",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "a1ef6cfe_302f68a6",
        "filename": "firmware/2lib/include/2api.h",
        "patchSetId": 2
      },
      "lineNbr": 397,
      "author": {
        "id": 1000187
      },
      "writtenOn": "2014-12-18T22:55:45Z",
      "side": 1,
      "message": "Yes, that\u0027s what we\u0027re doing.",
      "parentUuid": "e197a45c_e8bea786",
      "revId": "1696b5ec9ab6047b675eaf17a0fbc4bb3539348a",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "a1a3ecb1_309b08dd",
        "filename": "firmware/lib20/api.c",
        "patchSetId": 2
      },
      "lineNbr": 103,
      "author": {
        "id": 1002124
      },
      "writtenOn": "2014-12-18T16:52:45Z",
      "side": 1,
      "message": "Should the flag be be ALLOW_HWCRYPTO?  I\u0027m sure you thought through this, but it seems weird to go down this path for all platforms only to have it return UNSUPPORTED.",
      "revId": "1696b5ec9ab6047b675eaf17a0fbc4bb3539348a",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "e1996484_92883cb3",
        "filename": "firmware/lib20/api.c",
        "patchSetId": 2
      },
      "lineNbr": 103,
      "author": {
        "id": 1000187
      },
      "writtenOn": "2014-12-18T17:20:54Z",
      "side": 1,
      "message": "The double-negative is to allow this to work without needing to change our signing process.\n\nI think it might be better to make this ALLOW_HWCRYPTO, and change futility always to specify that flag for now.  At least that avoids the double-negative (if not no support...)",
      "parentUuid": "a1a3ecb1_309b08dd",
      "revId": "1696b5ec9ab6047b675eaf17a0fbc4bb3539348a",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "c19c6086_c7d9923b",
        "filename": "firmware/lib20/api.c",
        "patchSetId": 2
      },
      "lineNbr": 103,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2014-12-18T19:59:14Z",
      "side": 1,
      "message": "The preamble flags actually don\u0027t originate in futility, they get passed in by cros_bundle_firmware (which takes them from the fmap.dts file we have for every board in the depthcharge repo). So we could totally turn this around and set the flag for all new boards (or even just the veyron boards).\n\nI was just thinking that making the \"default\" state 0 would be the most simple (and therefore harder to screw up) way. We\u0027re always copying our fmap.dts together from some random old boards, and the preamble-flags value in there is a raw number that I\u0027m afraid too many people might not really know how to interpret anyway. I recently screwed up myself on Pinky by not noticing that we still had RO_NORMAL set until weird FAFT failures let me know... so I think leaving this in a way that makes copying the old numbers (where this bit is always 0) the \"right\" thing to do by default makes most sense.",
      "parentUuid": "e1996484_92883cb3",
      "revId": "1696b5ec9ab6047b675eaf17a0fbc4bb3539348a",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "a1a3ecb1_04908658",
        "filename": "firmware/lib20/api.c",
        "patchSetId": 2
      },
      "lineNbr": 103,
      "author": {
        "id": 1002124
      },
      "writtenOn": "2014-12-18T20:35:39Z",
      "side": 1,
      "message": "OK. I can buy the argument.",
      "parentUuid": "c19c6086_c7d9923b",
      "revId": "1696b5ec9ab6047b675eaf17a0fbc4bb3539348a",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "81f428d2_af889904",
        "filename": "firmware/lib20/api.c",
        "patchSetId": 2
      },
      "lineNbr": 103,
      "author": {
        "id": 1000187
      },
      "writtenOn": "2014-12-18T22:55:45Z",
      "side": 1,
      "message": "Yeah, ok.\n\nWould be nicer if fmap.dts could take tokenized bit values rather than a bare integer, but that\u0027s a totally different discussion.",
      "parentUuid": "a1a3ecb1_04908658",
      "revId": "1696b5ec9ab6047b675eaf17a0fbc4bb3539348a",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "21e9bccf_4236f689",
        "filename": "tests/vb20_api_tests.c",
        "patchSetId": 2
      },
      "lineNbr": 28,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2014-12-17T23:48:43Z",
      "side": 1,
      "message": "I\u0027d really like to do the same thing in vb21_api_tests.c, but unfortunately I can\u0027t since it is a full integration test (calls through to the actual vb2_digest_* functions instead of stubbing them out). I don\u0027t really see a good way to test which functions are called in that model (e.g. make sure vboot doesn\u0027t switch back-and-forth between hardware and software crypto functions in between)... it would be much simpler to test the vb2api* functions from both ends (like this file) and relegate testing of the vb2_digest* functions solely to vb2_sha_tests.c. What do you think?",
      "revId": "1696b5ec9ab6047b675eaf17a0fbc4bb3539348a",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "c19e206c_31631088",
        "filename": "tests/vb20_api_tests.c",
        "patchSetId": 2
      },
      "lineNbr": 28,
      "author": {
        "id": 1000187
      },
      "writtenOn": "2014-12-18T17:20:54Z",
      "side": 1,
      "message": "If we change vb2_digest_*() to be a wrapper which decides between:\n\nvb2ex_hwcrypto_digest_*()\n\nand \n\nvb2_sw_digest_*()\n\nthen your overrides below should work in both cases.",
      "parentUuid": "21e9bccf_4236f689",
      "revId": "1696b5ec9ab6047b675eaf17a0fbc4bb3539348a",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "e197a45c_086e6bee",
        "filename": "tests/vb20_api_tests.c",
        "patchSetId": 2
      },
      "lineNbr": 28,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2014-12-18T19:59:14Z",
      "side": 1,
      "message": "Right... although the one thing I really want to test is that decision, so if I put the decision logic in vb2_digest_* (and then replace that with a mock function) I\u0027m not really testing that much anymore. ;) (I guess I\u0027m still testing the logic on init() which is good, but not if there\u0027s some bug in vb2_digest_extend() that makes it misinterpret the contents of the digest context.)",
      "parentUuid": "c19e206c_31631088",
      "revId": "1696b5ec9ab6047b675eaf17a0fbc4bb3539348a",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "81f428d2_6f68718e",
        "filename": "tests/vb20_api_tests.c",
        "patchSetId": 2
      },
      "lineNbr": 28,
      "author": {
        "id": 1000187
      },
      "writtenOn": "2014-12-18T22:55:45Z",
      "side": 1,
      "message": "You can still mock the vb2ex_hwcrypto_digest() functions in the api21 test:\n\n  int vb2ex_hwcrypto_digest_init(...) {\n    if (retval_vb2ex_hwcrypto_digest_init)\n      return vb2ex_hwcrypto_digest_init; /* Force failure */\n    /* Mock implementation uses SW crypto */\n    return vb2_digest_init(...);\n  }",
      "parentUuid": "e197a45c_086e6bee",
      "revId": "1696b5ec9ab6047b675eaf17a0fbc4bb3539348a",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    }
  ]
}