{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "42e14bbd_5623d6ef",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2021-04-28T08:38:38Z",
      "side": 1,
      "message": "@jwerner and @yupingso: What do you think we should do with kparams?  I can think of three options:\n\n(1) Store a pointer in vb2_context.  Caller fills in the pointer before calling VbSelectAndLoadKernel.  Not sure this fits with our current model, since we don\u0027t really expose anything in vb2_context except for a \"flags\" field.\n\n(2) Store a pointer in vb2_shared_data.  Caller includes kparams as an argument to VbSelectAndLoadKernel, which stores the pointer in vb2_shared_data right away.  That\u0027s what this CL does.  We can use an existing unused field, which is nice.\n\n(3) Merge into vb2_context.  Seems awkward to take up so many fields, when vb2_context is used in so many other contexts. (\u003d\n\n(4) Include as an argument for all functions which require it.  Doesn\u0027t seem ideal, since we would need to add it to a slew of UI functions.\n\nIf our final goal is to move UI to depthcharge, and expose VbTryLoadKernel (or functions just a level above that, like vb2_normal_boot) in the API, then perhaps (4) would work well?  But in the meantime, (2) seems like a nice way of getting rid of the awkward copying between vboot_api_kernel.c\u0027s lkp global and the caller-provided kparams?",
      "revId": "673f20eb3fcb0547b8b9e49c31e17db02414c612",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "549aeadb_d9cb3991",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2021-04-29T23:12:28Z",
      "side": 1,
      "message": "\u003e (4) Include as an argument for all functions which require it.  Doesn\u0027t seem ideal, since we would need to add it to a slew of UI functions.\n\nI think this is the long-term right way to go. It is, in the end, just a function argument... not anything that really needs stay around long-term in shared data like most of the other stuff in there which traverses boot stages and the like. There\u0027s no point in \"cleaning up the ugly global\" by just abusing shared data as another kind of global variable storage instead.\n\nFor now I would suggest replacing the lkp global with a global kparams pointer, that way you can get rid of LKP, treat kparams as a function argument for VbSelectAndLoadKernel() and LoadKernel(), and still don\u0027t have to pass it through the whole UI stack. Once the UI stack is moved to the side, we can get rid of the global completely.",
      "parentUuid": "42e14bbd_5623d6ef",
      "revId": "673f20eb3fcb0547b8b9e49c31e17db02414c612",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "fff26f36_9195214f",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1353551
      },
      "writtenOn": "2021-05-03T09:20:18Z",
      "side": 1,
      "message": "\u003e Once the UI stack is moved to the side, we can get rid of the global completely.\n\nSounds good to me. Just to confirm the steps in the final state:\n\n- VbSelectAndLoadKernelParams kparams is declared in depthcharge and passed to VbSelectAndLoadKernel() as an argument.\n- VbSelectAndLoadKernel() returns control to depthcharge to enter UI code.\n- The UI code in depthcharge gets disk info (VbExDiskGetInfo) and fills in fields of kparams. This is equivalent to VbTryLoadKernel().\n- Then, depthcharge calls vboot\u0027s LoadKernel(*kparams) for verification.\n\nIs my understanding correct?\n\nNote that this is different from:\n\n\u003e expose VbTryLoadKernel (or functions just a level above that, like vb2_normal_boot) in the API",
      "parentUuid": "549aeadb_d9cb3991",
      "revId": "673f20eb3fcb0547b8b9e49c31e17db02414c612",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    }
  ]
}