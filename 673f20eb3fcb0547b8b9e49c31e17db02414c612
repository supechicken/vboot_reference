{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "42e14bbd_5623d6ef",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2021-04-28T08:38:38Z",
      "side": 1,
      "message": "@jwerner and @yupingso: What do you think we should do with kparams?  I can think of three options:\n\n(1) Store a pointer in vb2_context.  Caller fills in the pointer before calling VbSelectAndLoadKernel.  Not sure this fits with our current model, since we don\u0027t really expose anything in vb2_context except for a \"flags\" field.\n\n(2) Store a pointer in vb2_shared_data.  Caller includes kparams as an argument to VbSelectAndLoadKernel, which stores the pointer in vb2_shared_data right away.  That\u0027s what this CL does.  We can use an existing unused field, which is nice.\n\n(3) Merge into vb2_context.  Seems awkward to take up so many fields, when vb2_context is used in so many other contexts. (\u003d\n\n(4) Include as an argument for all functions which require it.  Doesn\u0027t seem ideal, since we would need to add it to a slew of UI functions.\n\nIf our final goal is to move UI to depthcharge, and expose VbTryLoadKernel (or functions just a level above that, like vb2_normal_boot) in the API, then perhaps (4) would work well?  But in the meantime, (2) seems like a nice way of getting rid of the awkward copying between vboot_api_kernel.c\u0027s lkp global and the caller-provided kparams?",
      "revId": "673f20eb3fcb0547b8b9e49c31e17db02414c612",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "549aeadb_d9cb3991",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2021-04-29T23:12:28Z",
      "side": 1,
      "message": "\u003e (4) Include as an argument for all functions which require it.  Doesn\u0027t seem ideal, since we would need to add it to a slew of UI functions.\n\nI think this is the long-term right way to go. It is, in the end, just a function argument... not anything that really needs stay around long-term in shared data like most of the other stuff in there which traverses boot stages and the like. There\u0027s no point in \"cleaning up the ugly global\" by just abusing shared data as another kind of global variable storage instead.\n\nFor now I would suggest replacing the lkp global with a global kparams pointer, that way you can get rid of LKP, treat kparams as a function argument for VbSelectAndLoadKernel() and LoadKernel(), and still don\u0027t have to pass it through the whole UI stack. Once the UI stack is moved to the side, we can get rid of the global completely.",
      "parentUuid": "42e14bbd_5623d6ef",
      "revId": "673f20eb3fcb0547b8b9e49c31e17db02414c612",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "fff26f36_9195214f",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1353551
      },
      "writtenOn": "2021-05-03T09:20:18Z",
      "side": 1,
      "message": "\u003e Once the UI stack is moved to the side, we can get rid of the global completely.\n\nSounds good to me. Just to confirm the steps in the final state:\n\n- VbSelectAndLoadKernelParams kparams is declared in depthcharge and passed to VbSelectAndLoadKernel() as an argument.\n- VbSelectAndLoadKernel() returns control to depthcharge to enter UI code.\n- The UI code in depthcharge gets disk info (VbExDiskGetInfo) and fills in fields of kparams. This is equivalent to VbTryLoadKernel().\n- Then, depthcharge calls vboot\u0027s LoadKernel(*kparams) for verification.\n\nIs my understanding correct?\n\nNote that this is different from:\n\n\u003e expose VbTryLoadKernel (or functions just a level above that, like vb2_normal_boot) in the API",
      "parentUuid": "549aeadb_d9cb3991",
      "revId": "673f20eb3fcb0547b8b9e49c31e17db02414c612",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "fb13b0c6_8b313e41",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2021-05-03T21:15:37Z",
      "side": 1,
      "message": "\u003e Sounds good to me. Just to confirm the steps in the final state:\n\nI think the question discussed here is just what Joel should do right now, within this patch. For larger-scale rearchitecting in the future, I think we all have a vague idea where it should go, but for me there are still a lot of details left open (e.g. whether the entry point into vboot will be VbTryLoadKernel() or LoadKernel() or something in-between). If you want to flesh that out I\u0027d suggest maybe sketching the flows in a small design doc so it\u0027s easier to discuss than ad hoc in a review comment.",
      "parentUuid": "fff26f36_9195214f",
      "revId": "673f20eb3fcb0547b8b9e49c31e17db02414c612",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "4ba40f48_f35487c8",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1353551
      },
      "writtenOn": "2021-05-04T06:53:32Z",
      "side": 1,
      "message": "Sorry, I didn\u0027t mean to start an irrelevant discussion. It\u0027s just unclear to me how the kparams global can be removed when the UI code is moved aside. Isn\u0027t that highly dependent on how we deal with the UI code?",
      "parentUuid": "fb13b0c6_8b313e41",
      "revId": "673f20eb3fcb0547b8b9e49c31e17db02414c612",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "db898faf_da6a49c4",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2021-05-04T23:33:50Z",
      "side": 1,
      "message": "Yeah, of course, I\u0027m just kinda guessing here that we\u0027re probably going to end up with something where we can get rid of that global and kparams can always be passed in as an argument. But it\u0027s something we\u0027ll still need to figure out the details of and only then we\u0027ll know how exactly we\u0027ll want to do it. I didn\u0027t mean to dismiss what you said, just that I think that will take some more time to sort out and could use a design doc.\n\nFor now I\u0027m suggesting storing kparams in a global because it should be the simplest and least invasive way to move forward here without having to know the answers to all those other questions. I think we\u0027ll probably be able to have it be just a parameter eventually and it can stay a global until then. If we figure out that doesn\u0027t work after all, we can still decide to do something else at that point. But putting something into vb2_context or shared data is a bigger, less easily reversible change (because those structures are versioned) so I wouldn\u0027t do that until we are certain that that\u0027s really the solution we want to end up with long term.",
      "parentUuid": "4ba40f48_f35487c8",
      "revId": "673f20eb3fcb0547b8b9e49c31e17db02414c612",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "30ba12e6_772d16ec",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2021-05-10T04:17:47Z",
      "side": 1,
      "message": "\u003e I would suggest replacing the lkp global with a global kparams pointer\n\nAny thoughts on checking the pointer validity?  Should vboot code just assume the kparams pointer has been set properly?\n\nRe. Yu-Ping\u0027s comments: I\u0027m happy to chat about what the API should look like as we prepare to move UI code to depthcharge, either in-person or in a bug discussion.",
      "parentUuid": "db898faf_da6a49c4",
      "revId": "673f20eb3fcb0547b8b9e49c31e17db02414c612",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "3d25f436_249cd075",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2021-05-20T00:52:38Z",
      "side": 1,
      "message": "\u003e Any thoughts on checking the pointer validity?  Should vboot code just assume the kparams pointer has been set properly?\n\nWell... I mean it\u0027s vboot code setting up that pointer and vboot code using it later, so... yeah? You can add a VB2_ASSERT() for it if you want, of course. I think we all agree this isn\u0027t an amazing solution, just an interim to get from what we have to something slightly cleaner.",
      "parentUuid": "30ba12e6_772d16ec",
      "revId": "673f20eb3fcb0547b8b9e49c31e17db02414c612",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    }
  ]
}