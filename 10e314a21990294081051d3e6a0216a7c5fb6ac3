{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "78f8c33e_caa0ba03",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 15,
      "author": {
        "id": 1267126
      },
      "writtenOn": "2022-10-18T22:24:02Z",
      "side": 1,
      "message": "The deprecated sysfs ABI doesn\u0027t have this problem, right? It looks like we need a \u0027gpiod\u0027 daemon that we send dbus messages to to ask for the state of a gpio, so that only one userspace process owns the pin.",
      "range": {
        "startLine": 13,
        "startChar": 0,
        "endLine": 15,
        "endChar": 10
      },
      "revId": "10e314a21990294081051d3e6a0216a7c5fb6ac3",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "649322a7_f3c7d27f",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 15,
      "author": {
        "id": 1000107
      },
      "writtenOn": "2022-10-18T22:47:37Z",
      "side": 1,
      "message": "We\u0027re using the deprecated ABI, though! See b/254329477. Oh, you mean the ABI that was deprecated before that (https://docs.kernel.org/admin-guide/gpio/sysfs.html). Right, I don\u0027t think it was a problem there because there was no locking. Userspace could freely step on each other.\n\nYes, we could make a daemon just for this. If you really think we should do this, feel free to file a bug. It feels like that would be a longer term effort, though?\n\nHonestly, though, if we\u0027re gonna make big changes I\u0027d rather see us actually export this as a bona-fide \"switch\" using gpio-keys. Then userspace could query the switch. They could also listen for changes to this switch... Did we think about doing that before and decided on exporting it as a GPIO, or did we not think about it before?",
      "parentUuid": "78f8c33e_caa0ba03",
      "range": {
        "startLine": 13,
        "startChar": 0,
        "endLine": 15,
        "endChar": 10
      },
      "revId": "10e314a21990294081051d3e6a0216a7c5fb6ac3",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "310641c6_2d7f9903",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 15,
      "author": {
        "id": 1267126
      },
      "writtenOn": "2022-10-18T23:53:27Z",
      "side": 1,
      "message": "I believe @briannorris@chromium.org implemented the code? See https://crbug.com/897992",
      "parentUuid": "649322a7_f3c7d27f",
      "range": {
        "startLine": 13,
        "startChar": 0,
        "endLine": 15,
        "endChar": 10
      },
      "revId": "10e314a21990294081051d3e6a0216a7c5fb6ac3",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "8383e03f_a4cb13bd",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 15,
      "author": {
        "id": 1132414
      },
      "writtenOn": "2022-10-19T00:00:10Z",
      "side": 1,
      "message": "I did not consider using a daemon. Reimplementing libgpiod was enough yak shaving for me. I also didn\u0027t consider EBUSY or know that it was a problem. (Of course there\u0027s no actual API documentation for ioctls. Who would want that?)\n\nI hope D-Bus was a joke. I assume vboot developers would laugh you out of the room for that one, given that Julius didn\u0027t even want to take a libgpiod dependency.",
      "parentUuid": "310641c6_2d7f9903",
      "range": {
        "startLine": 13,
        "startChar": 0,
        "endLine": 15,
        "endChar": 10
      },
      "revId": "10e314a21990294081051d3e6a0216a7c5fb6ac3",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "2adbbfa8_91488d37",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 15,
      "author": {
        "id": 1267126
      },
      "writtenOn": "2022-10-19T00:03:09Z",
      "side": 1,
      "message": "D-Bus was only half a joke. I recall there was some discussion about removing the deprecated sysfs ABI completely and there being concerns that not using the file based API would lead to ownership/permission issues. Basically folks liked having unix file permissions and being able to limit what gpios could be used by what processes. To get around that, we would need to make some broker process that \"owned\" the file descriptor and handed the fd to the requesting process if it knew there wasn\u0027t a security risk for that particular gpio.",
      "parentUuid": "310641c6_2d7f9903",
      "range": {
        "startLine": 13,
        "startChar": 0,
        "endLine": 15,
        "endChar": 10
      },
      "revId": "10e314a21990294081051d3e6a0216a7c5fb6ac3",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "29066fc0_676cd6a0",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 15,
      "author": {
        "id": 1132414
      },
      "writtenOn": "2022-10-19T00:36:08Z",
      "side": 1,
      "message": "We\u0027ve got our share of gpio exporters and chown\u0027ers:\n\nhttps://source.chromium.org/chromiumos/chromiumos/codesearch/+/main:src/overlays/overlay-drallion/chromeos-base/modemfwd-helpers/files/modemfwd-helpers.conf;l\u003d15;drc\u003d74a826157823281c2c1d7e39bb93f0e99cc8c86a\n\nhttps://source.chromium.org/chromiumos/chromiumos/codesearch/+/main:src/overlays/overlay-coral/chromeos-base/modemfwd-helpers/files/94-l850gl-gpio.rules;drc\u003d74a826157823281c2c1d7e39bb93f0e99cc8c86a\n\nSo either we let them pry our perfectly functional sysfs ABI from our cold dead hands, or maybe we have to do this privilege delegation thing in at least some cases. Maybe debugd will grow a GPIO API, as it already owns a bunch of other privileged operations...\n\nBut even with a D-Bus service for some things, would we actually want that for crossystem/vboot_reference? (Or maybe the answer is that crossystem should be ripped out of vboot_reference...)\n\nI also didn\u0027t answer Doug\u0027s question: I don\u0027t recall considering gpio-keys. \"The\" chardev GPIO API seemed perfectly fine at the time, and I didn\u0027t field any objections or mentions of gpio-keys. Why would it be better, except that the input subsystem has sane maintainers? I guess it supports multiple listeners/readers, for one. I guess maybe it supports ACLs (with a proper file node) too? But this GPIO API seems to have a watch/event API, if that\u0027s what you\u0027re looking for.",
      "parentUuid": "2adbbfa8_91488d37",
      "range": {
        "startLine": 13,
        "startChar": 0,
        "endLine": 15,
        "endChar": 10
      },
      "revId": "10e314a21990294081051d3e6a0216a7c5fb6ac3",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "283e816b_d7aa4a51",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 15,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2022-10-19T21:56:05Z",
      "side": 1,
      "message": "Please consider that crossystem needs to work in special environments, like the recovery installer. Depending on an extra daemon (and a huge library dependency like dbus on top!) would create a lot of headache there. If the retry approach here isn\u0027t sufficient (but sounds like it is?) I would suggest using lock files instead,",
      "parentUuid": "29066fc0_676cd6a0",
      "range": {
        "startLine": 13,
        "startChar": 0,
        "endLine": 15,
        "endChar": 10
      },
      "revId": "10e314a21990294081051d3e6a0216a7c5fb6ac3",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "0dede272_bab140e6",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 15,
      "author": {
        "id": 1267126
      },
      "writtenOn": "2022-10-20T01:29:04Z",
      "side": 1,
      "message": "Maybe we should file this bug report up to libgpiod folks so they\u0027re aware of the issue? In this case we would probably be OK if there could be multiple readers of the pin state. Maybe that can be expressed somehow through the ioctl on the gpiochip passing a flag that the intent is to only read the gpio state, and not write it? Then if something wants to write a gpio from the gpiochip it requests the line without that flag like is done now and it checks for exclusivity.",
      "parentUuid": "283e816b_d7aa4a51",
      "range": {
        "startLine": 13,
        "startChar": 0,
        "endLine": 15,
        "endChar": 10
      },
      "revId": "10e314a21990294081051d3e6a0216a7c5fb6ac3",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "5b7e02c7_f5a6d958",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1152319
      },
      "writtenOn": "2022-10-18T21:35:53Z",
      "side": 1,
      "message": "Lgtm with a question (see CIL)",
      "revId": "10e314a21990294081051d3e6a0216a7c5fb6ac3",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "aa9ef4a2_6f607872",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1132414
      },
      "writtenOn": "2022-10-18T22:23:48Z",
      "side": 1,
      "message": "fun fact: libgpiod doesn\u0027t handle EBUSY either. so score one (or is it a tie?) for rolling our own non-library",
      "revId": "10e314a21990294081051d3e6a0216a7c5fb6ac3",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "718339eb_e336b5db",
        "filename": "host/arch/arm/lib/crossystem_arch.c",
        "patchSetId": 1
      },
      "lineNbr": 216,
      "author": {
        "id": 1152319
      },
      "writtenOn": "2022-10-18T21:35:53Z",
      "side": 1,
      "message": "so, the total wait in \"constant busy\" case before we give up is 50*(0+49)/2 ms \u003d 1.225 seconds. sounds probably ok, but double-checking.",
      "range": {
        "startLine": 216,
        "startChar": 2,
        "endLine": 216,
        "endChar": 24
      },
      "revId": "10e314a21990294081051d3e6a0216a7c5fb6ac3",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "0abfcb75_403a9aa1",
        "filename": "host/arch/arm/lib/crossystem_arch.c",
        "patchSetId": 1
      },
      "lineNbr": 216,
      "author": {
        "id": 1000107
      },
      "writtenOn": "2022-10-18T22:19:29Z",
      "side": 1,
      "message": "Yeah. I could lower it if desired (I don\u0027t think I ever saw even more than a single retry needed). To some extent I kinda like it being long but not too long. If somehow things got busted and this failed constantly (timing out every time) then running \"crossystem\" would take a second to fail. Hopefully it would mean that a user\u0027s system wasn\u0027t terribly blocked but also that someone would notice and dig out the root cause.\n\nDefinitely having _some_ type of obvious failure is good because (right now) we default to doing completely the wrong thing (returning the unpopulated \"boot wp\" value).",
      "parentUuid": "718339eb_e336b5db",
      "range": {
        "startLine": 216,
        "startChar": 2,
        "endLine": 216,
        "endChar": 24
      },
      "revId": "10e314a21990294081051d3e6a0216a7c5fb6ac3",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "12a899f7_328f8b29",
        "filename": "host/arch/arm/lib/crossystem_arch.c",
        "patchSetId": 1
      },
      "lineNbr": 220,
      "author": {
        "id": 1132414
      },
      "writtenOn": "2022-10-18T22:23:48Z",
      "side": 1,
      "message": "this is no longer going to get the errno from ioctl() in the EBUSY error case; it\u0027ll report the (non)error from usleep().\n\nMaybe move this into the loop, splitting the success vs. error cases?",
      "range": {
        "startLine": 220,
        "startChar": 2,
        "endLine": 220,
        "endChar": 8
      },
      "revId": "10e314a21990294081051d3e6a0216a7c5fb6ac3",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "c8169484_883dc0b8",
        "filename": "host/arch/arm/lib/crossystem_arch.c",
        "patchSetId": 1
      },
      "lineNbr": 220,
      "author": {
        "id": 1000107
      },
      "writtenOn": "2022-10-18T22:47:37Z",
      "side": 1,
      "message": "Ah, good point. I don\u0027t think moving the print in the loop helps. I think we need to move all the loop end conditions into the loop so we can do them before the sleep.\n\nOK, see how this looks.",
      "parentUuid": "12a899f7_328f8b29",
      "range": {
        "startLine": 220,
        "startChar": 2,
        "endLine": 220,
        "endChar": 8
      },
      "revId": "10e314a21990294081051d3e6a0216a7c5fb6ac3",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    }
  ]
}