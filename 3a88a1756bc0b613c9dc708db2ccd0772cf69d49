{
  "comments": [
    {
      "key": {
        "uuid": "e14789dd_f12bbc71",
        "filename": "firmware/2lib/2secdata_fwmp.c",
        "patchSetId": 3
      },
      "lineNbr": 63,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2019-08-30T18:37:27Z",
      "side": 1,
      "message": "I\u0027m actually wondering if we should really implement this. Firmware never initializes the FWMP itself right now and never should in the future. The only thing we need is to return default values when the FWMP doesn\u0027t exist.\n\n...so, really, we want to distinguish the three cases...\n\na) FWMP exists and is valid (then use it)\nb) FWMP exists and is invalid (then error out into recovery)\nc) FWMP doesn\u0027t exist (then pretend all fields are zero/default)\n\n...and the knowledge of whether the FWMP exists or not is left to the code doing the TPM access (which we eventually want to be depthcharge). So maybe we should add a new vb2_context flag VB2_CONTEXT_NO_FWMP that the caller is supposed to set when it gets a BADINDEX response from trying to read the FWMP. When that is set, vb2_secdata_fwmp_get...() functions will always return their default value. When it\u0027s not set, then the FWMP has to be valid and if it isn\u0027t all those functions should return errors.",
      "revId": "3a88a1756bc0b613c9dc708db2ccd0772cf69d49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "391d1349_6a6d3330",
        "filename": "firmware/2lib/2secdata_fwmp.c",
        "patchSetId": 3
      },
      "lineNbr": 63,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2019-09-12T07:56:22Z",
      "side": 1,
      "message": "I like this solution.",
      "parentUuid": "e14789dd_f12bbc71",
      "revId": "3a88a1756bc0b613c9dc708db2ccd0772cf69d49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "0bc13b66_6d6dec04",
        "filename": "firmware/2lib/2secdata_fwmp.c",
        "patchSetId": 3
      },
      "lineNbr": 81,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2019-08-30T18:37:27Z",
      "side": 1,
      "message": "...and also, we don\u0027t actually need this, right? We don\u0027t ever *want* to write the FWMP from vboot. So let\u0027s not put anything suggesting we might in here.",
      "revId": "3a88a1756bc0b613c9dc708db2ccd0772cf69d49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "c56a76e2_834515a0",
        "filename": "firmware/2lib/2secdata_fwmp.c",
        "patchSetId": 3
      },
      "lineNbr": 81,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2019-09-12T07:56:22Z",
      "side": 1,
      "message": "Gone.",
      "parentUuid": "0bc13b66_6d6dec04",
      "revId": "3a88a1756bc0b613c9dc708db2ccd0772cf69d49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "1cfabb81_2f4537c1",
        "filename": "firmware/2lib/2secdata_fwmp.c",
        "patchSetId": 3
      },
      "lineNbr": 103,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2019-08-30T20:50:37Z",
      "side": 1,
      "message": "So after looking at https://chromium-review.googlesource.com/c/chromiumos/platform/vboot_reference/+/1728298/25/firmware/lib/vboot_ui_menu.c#186 and similar call sites I\u0027m not really happy about this API anymore. Having to check this return value all the time is really annoying and bloats the code a lot. We really only need to check once (as part of init()), and after that it should either always work, or we shouldn\u0027t be trying to read any fields anyway (since we would error out immediately), or we\u0027re in recovery mode and should be using default values if we can\u0027t read the real ones.\n\nSo maybe we can do these somewhat like this instead:\n\n uint32_t vb2_secdata_\u003ctype\u003e_get_\u003cfield\u003e(ctx, field)\n {\n   if (ctx-\u003eflags \u0026 NO_FWMP)\n     goto default;\n\n   if (!sd-\u003estatus \u0026 FWMP_INIT) {\n     if (ctx-\u003eflags \u0026 RECOVERY_MODE)\n       goto default;\n     else\n       vb2_assert();\n   }\n\n   switch (field) {\n   case xxx:\n     return sec-\u003e...;\n   ...\n   }\n\n default:\n   return 0; /* Or other default if necessary, but I think it\u0027s usually 0 */\n }",
      "revId": "3a88a1756bc0b613c9dc708db2ccd0772cf69d49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "8d4a448d_16d23011",
        "filename": "firmware/2lib/2secdata_fwmp.c",
        "patchSetId": 3
      },
      "lineNbr": 103,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2019-09-12T07:56:22Z",
      "side": 1,
      "message": "Yeah okay, this sounds like a good idea.\nNot sure if we should go ahead and update vb2_secdata_firmware/kernel in this CL, or leave that for a future change?",
      "parentUuid": "1cfabb81_2f4537c1",
      "revId": "3a88a1756bc0b613c9dc708db2ccd0772cf69d49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "96df0c33_2d553f37",
        "filename": "firmware/2lib/2secdata_fwmp.c",
        "patchSetId": 3
      },
      "lineNbr": 103,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2019-09-13T00:31:58Z",
      "side": 1,
      "message": "Separate change sounds better.",
      "parentUuid": "8d4a448d_16d23011",
      "revId": "3a88a1756bc0b613c9dc708db2ccd0772cf69d49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "1c9a8b8c_5f02f51e",
        "filename": "firmware/2lib/2secdata_fwmp.c",
        "patchSetId": 3
      },
      "lineNbr": 103,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2019-09-17T09:01:19Z",
      "side": 1,
      "message": "Ack",
      "parentUuid": "96df0c33_2d553f37",
      "revId": "3a88a1756bc0b613c9dc708db2ccd0772cf69d49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "ed9fd8da_3cfd2c62",
        "filename": "firmware/2lib/2secdata_fwmp.c",
        "patchSetId": 3
      },
      "lineNbr": 119,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2019-08-30T18:37:27Z",
      "side": 1,
      "message": "Same notion, vboot will never use this (in fact I\u0027m not sure if it would be possible/safe to do so, since the FMWP needs some special and weird permissions)",
      "revId": "3a88a1756bc0b613c9dc708db2ccd0772cf69d49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "8d971f27_1f7abee4",
        "filename": "firmware/2lib/2secdata_fwmp.c",
        "patchSetId": 3
      },
      "lineNbr": 119,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2019-08-30T20:50:37Z",
      "side": 1,
      "message": "...and for the set() ones we can probably make them void then (I mean, we shouldn\u0027t have this one anyway, but for the other secdata types).",
      "parentUuid": "ed9fd8da_3cfd2c62",
      "revId": "3a88a1756bc0b613c9dc708db2ccd0772cf69d49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "059dccf2_a5f8c031",
        "filename": "firmware/2lib/2secdata_fwmp.c",
        "patchSetId": 3
      },
      "lineNbr": 119,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2019-09-12T07:56:22Z",
      "side": 1,
      "message": "Good point, let\u0027s just remove this.",
      "parentUuid": "8d971f27_1f7abee4",
      "revId": "3a88a1756bc0b613c9dc708db2ccd0772cf69d49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "a3a0013b_16eab083",
        "filename": "firmware/2lib/2secdata_fwmp.c",
        "patchSetId": 3
      },
      "lineNbr": 155,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2019-08-30T18:37:27Z",
      "side": 1,
      "message": "I think this can just be VB2_ERROR_SECDATA_FWMP_GET_UNINITIALIZED. That means \"any fwmp_get function was called before fwmp_init\". I think that can apply here just as well.",
      "revId": "3a88a1756bc0b613c9dc708db2ccd0772cf69d49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "c602314b_f75cfd23",
        "filename": "firmware/2lib/2secdata_fwmp.c",
        "patchSetId": 3
      },
      "lineNbr": 155,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2019-09-12T07:56:22Z",
      "side": 1,
      "message": "Let\u0027s just have this return the uint8_t pointer directly, and assert that FWMP has been initialized?  Not sure if there is a \"default value\" here though.",
      "parentUuid": "a3a0013b_16eab083",
      "revId": "3a88a1756bc0b613c9dc708db2ccd0772cf69d49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "8987fe64_1203009b",
        "filename": "firmware/2lib/2secdata_fwmp.c",
        "patchSetId": 3
      },
      "lineNbr": 155,
      "author": {
        "id": 1002133
      },
      "writtenOn": "2019-09-13T00:31:58Z",
      "side": 1,
      "message": "Yeah, I wrote that comment before rethinking the return types.",
      "parentUuid": "c602314b_f75cfd23",
      "revId": "3a88a1756bc0b613c9dc708db2ccd0772cf69d49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "d3178f8a_419e6bce",
        "filename": "firmware/2lib/2secdata_fwmp.c",
        "patchSetId": 3
      },
      "lineNbr": 155,
      "author": {
        "id": 1126709
      },
      "writtenOn": "2019-09-17T09:01:19Z",
      "side": 1,
      "message": "Ack",
      "parentUuid": "8987fe64_1203009b",
      "revId": "3a88a1756bc0b613c9dc708db2ccd0772cf69d49",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    }
  ]
}